'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
    value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _appiumChromedriver = require('appium-chromedriver');

var _appiumChromedriver2 = _interopRequireDefault(_appiumChromedriver);

var _desiredCaps = require('./desired-caps');

var _desiredCaps2 = _interopRequireDefault(_desiredCaps);

var _commandsIndex = require('./commands/index');

var _commandsIndex2 = _interopRequireDefault(_commandsIndex);

var _commandsContext = require('./commands/context');

var _androidHelpers = require('./android-helpers');

var _androidHelpers2 = _interopRequireDefault(_androidHelpers);

var _webviewHelpers = require('./webview-helpers');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumAdb = require('appium-adb');

var _appiumSupport = require('appium-support');

var _asyncbox = require('asyncbox');

var APP_EXTENSION = '.apk';
var DEVICE_PORT = 4725;
var TESTBUNDLE_PORT = 4724;

// This is a set of methods and paths that we never want to proxy to
// Chromedriver
var NO_PROXY = [['POST', new RegExp('^/session/[^/]+/context')], ['GET', new RegExp('^/session/[^/]+/context')], ['POST', new RegExp('^/session/[^/]+/appium')], ['GET', new RegExp('^/session/[^/]+/appium')], ['POST', new RegExp('^/session/[^/]+/touch/perform')], ['POST', new RegExp('^/session/[^/]+/touch/multi/perform')], ['POST', new RegExp('^/session/[^/]+/orientation')], ['GET', new RegExp('^/session/[^/]+/orientation')]];

var AndroidDriver = (function (_BaseDriver) {
    _inherits(AndroidDriver, _BaseDriver);

    function AndroidDriver() {
        var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
        var shouldValidateCaps = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

        _classCallCheck(this, AndroidDriver);

        _get(Object.getPrototypeOf(AndroidDriver.prototype), 'constructor', this).call(this, opts, shouldValidateCaps);

        this.locatorStrategies = ['xpath', 'name', 'id', 'class name', 'text','accessibility id', '-android uiautomator'];
        this.desiredCapConstraints = _desiredCaps2['default'];
        this.sessionChromedrivers = {};
        this.jwpProxyActive = false;
        this.jwpProxyAvoid = _lodash2['default'].clone(NO_PROXY);
        this.settings = new _appiumBaseDriver.DeviceSettings({ ignoreUnimportantViews: false }, this.onSettingsUpdate.bind(this));
        this.chromedriver = null;
        this.apkStrings = {};
        this.bootstrapPort = opts.bootstrapPort || DEVICE_PORT;
        this.testbundlePort = opts.testbundlePort || TESTBUNDLE_PORT;
        this.unlocker = _androidHelpers2['default'].unlocker;

        var _iteratorNormalCompletion = true;
        var _didIteratorError = false;
        var _iteratorError = undefined;

        try {
            for (var _iterator = _getIterator(_lodash2['default'].pairs(_commandsIndex2['default'])), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                var _step$value = _slicedToArray(_step.value, 2);

                var cmd = _step$value[0];
                var fn = _step$value[1];

                AndroidDriver.prototype[cmd] = fn;
            }
        } catch (err) {
            _didIteratorError = true;
            _iteratorError = err;
        } finally {
            try {
                if (!_iteratorNormalCompletion && _iterator['return']) {
                    _iterator['return']();
                }
            } finally {
                if (_didIteratorError) {
                    throw _iteratorError;
                }
            }
        }
    }

    _createClass(AndroidDriver, [{
        key: 'createSession',
        value: function createSession(caps) {
            var sessionId, _ref, _ref2, serverDetails, defaultOpts, _helpers$getChromePkg, pkg, activity, _ref3,

            // get device udid for this session
            udid, emPort, networkSpeed;

            return _regeneratorRuntime.async(function createSession$(context$2$0) {
                while (1) switch (context$2$0.prev = context$2$0.next) {
                    case 0:
                        context$2$0.prev = 0;
                        sessionId = undefined;
                        context$2$0.next = 4;
                        return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(AndroidDriver.prototype), 'createSession', this).call(this, caps));

                    case 4:
                        _ref = context$2$0.sent;
                        _ref2 = _slicedToArray(_ref, 1);
                        sessionId = _ref2[0];
                        serverDetails = {
                            platform: 'LINUX',
                            webStorageEnabled: false,
                            takesScreenshot: true,
                            javascriptEnabled: true,
                            databaseEnabled: false,
                            networkConnectionEnabled: true,
                            locationContextEnabled: false,
                            warnings: {},
                            desired: this.caps
                        };

                        this.caps = _Object$assign(serverDetails, this.caps);

                        // assigning defaults
                        context$2$0.next = 11;
                        return _regeneratorRuntime.awrap(_appiumSupport.tempDir.staticDir());

                    case 11:
                        context$2$0.t0 = context$2$0.sent;
                        context$2$0.t1 = _appiumAdb.DEFAULT_ADB_PORT;
                        defaultOpts = {
                            action: "android.intent.action.MAIN",
                            category: "android.intent.category.LAUNCHER",
                            flags: "0x10200000",
                            disableAndroidWatchers: false,
                            tmpDir: context$2$0.t0,
                            fullReset: false,
                            autoLaunch: true,
                            adbPort: context$2$0.t1,
                            androidInstallTimeout: 90000
                        };

                        // 这里对opts.uuid字段没影响
                        _lodash2['default'].defaults(this.opts, defaultOpts);

                        if (this.opts.javaVersion) {
                            context$2$0.next = 19;
                            break;
                        }

                        context$2$0.next = 18;
                        return _regeneratorRuntime.awrap(_androidHelpers2['default'].getJavaVersion());

                    case 18:
                        this.opts.javaVersion = context$2$0.sent;

                    case 19:
                        this.useUnlockHelperApp = _lodash2['default'].isUndefined(this.caps.unlockType);

                        // not user visible via caps
                        if (this.opts.noReset === true) {
                            this.opts.fullReset = false;
                        }
                        if (this.opts.fullReset === true) {
                            this.opts.noReset = false;
                        }
                        this.opts.fastReset = !this.opts.fullReset && !this.opts.noReset;
                        this.opts.skipUninstall = this.opts.fastReset || this.opts.noReset;

                        this.curContext = this.defaultContextName();

                        if (this.isChromeSession) {
                            _logger2['default'].info("We're going to run a Chrome-based session");
                            _helpers$getChromePkg = _androidHelpers2['default'].getChromePkg(this.opts.browserName);
                            pkg = _helpers$getChromePkg.pkg;
                            activity = _helpers$getChromePkg.activity;

                            this.opts.appPackage = pkg;
                            this.opts.appActivity = activity;
                            _logger2['default'].info('Chrome-type package and activity are ' + pkg + ' and ' + activity);
                        }

                        if (this.opts.nativeWebScreenshot) {
                            this.jwpProxyAvoid.push(['GET', new RegExp('^/session/[^/]+/screenshot')]);
                        }

                        if (this.opts.reboot) {
                            this.setAvdFromCapabilities(caps);
                            this.addWipeDataToAvdArgs();
                        }context$2$0.next = 30;
                        return _regeneratorRuntime.awrap(_androidHelpers2['default'].getDeviceInfoFromCaps(this.opts));

                    case 30:
                        _ref3 = context$2$0.sent;
                        udid = _ref3.udid;
                        emPort = _ref3.emPort;

                        this.opts.udid = udid;
                        this.opts.emPort = emPort;

                        // set up an instance of ADB
                        context$2$0.next = 37;
                        return _regeneratorRuntime.awrap(_androidHelpers2['default'].createADB(this.opts.javaVersion, this.opts.udid, this.opts.emPort, this.opts.adbPort, this.opts.suppressKillServer, this.opts.remoteAdbHost));

                    case 37:
                        this.adb = context$2$0.sent;

                        if (this.helpers.isPackageOrBundle(this.opts.app)) {
                            // user provided package instead of app for 'app' capability, massage options
                            this.opts.appPackage = this.opts.app;
                            this.opts.app = null;
                        }

                        if (!this.opts.app) {
                            context$2$0.next = 48;
                            break;
                        }

                        context$2$0.next = 42;
                        return _regeneratorRuntime.awrap(this.helpers.configureApp(this.opts.app, APP_EXTENSION));

                    case 42:
                        this.opts.app = context$2$0.sent;

                        this.opts.appIsTemp = caps.app !== this.opts.app; // did we make a temporary copy?
                        context$2$0.next = 46;
                        return _regeneratorRuntime.awrap(this.checkAppPresent());

                    case 46:
                        context$2$0.next = 52;
                        break;

                    case 48:
                        if (!this.appOnDevice) {
                            context$2$0.next = 52;
                            break;
                        }

                        // the app isn't an actual app file but rather something we want to
                        // assume is on the device and just launch via the appPackage
                        _logger2['default'].info('App file was not listed, instead we\'re going to run ' + (this.opts.appPackage + ' directly on the device'));
                        context$2$0.next = 52;
                        return _regeneratorRuntime.awrap(this.checkPackagePresent());

                    case 52:
                        if (_lodash2['default'].isUndefined(this.opts.networkSpeed)) {
                            context$2$0.next = 60;
                            break;
                        }

                        if (this.isEmulator()) {
                            context$2$0.next = 57;
                            break;
                        }

                        _logger2['default'].warn("Sorry, networkSpeed capability is only available for emulators");
                        context$2$0.next = 60;
                        break;

                    case 57:
                        networkSpeed = _androidHelpers2['default'].ensureNetworkSpeed(this.adb, this.opts.networkSpeed);
                        context$2$0.next = 60;
                        return _regeneratorRuntime.awrap(this.adb.networkSpeed(networkSpeed));

                    case 60:
                        if (!_appiumSupport.util.hasValue(this.opts.gpsEnabled)) {
                            context$2$0.next = 68;
                            break;
                        }

                        if (!this.isEmulator()) {
                            context$2$0.next = 67;
                            break;
                        }

                        _logger2['default'].info('Trying to ' + (this.opts.gpsEnabled ? "enable" : "disable") + ' gps location provider');
                        context$2$0.next = 65;
                        return _regeneratorRuntime.awrap(this.adb.toggleGPSLocationProvider(this.opts.gpsEnabled));

                    case 65:
                        context$2$0.next = 68;
                        break;

                    case 67:
                        _logger2['default'].warn('Sorry! gpsEnabled capability is only available for emulators');

                    case 68:
                        context$2$0.next = 70;
                        return _regeneratorRuntime.awrap(this.startAndroidSession(this.opts));

                    case 70:
                        return context$2$0.abrupt('return', [sessionId, this.caps]);

                    case 73:
                        context$2$0.prev = 73;
                        context$2$0.t2 = context$2$0['catch'](0);
                        context$2$0.prev = 75;
                        context$2$0.next = 78;
                        return _regeneratorRuntime.awrap(this.deleteSession());

                    case 78:
                        context$2$0.next = 82;
                        break;

                    case 80:
                        context$2$0.prev = 80;
                        context$2$0.t3 = context$2$0['catch'](75);

                    case 82:
                        throw context$2$0.t2;

                    case 83:
                    case 'end':
                        return context$2$0.stop();
                }
            }, null, this, [[0, 73], [75, 80]]);
        }
    }, {
        key: 'isEmulator',
        value: function isEmulator() {
            return !!(this.opts.avd || /emulator/.test(this.opts.udid));
        }
    }, {
        key: 'setAvdFromCapabilities',
        value: function setAvdFromCapabilities(caps) {
            if (this.opts.avd) {
                _logger2['default'].info('avd name defined, ignoring device name and platform version');
            } else {
                if (!caps.deviceName) {
                    _logger2['default'].errorAndThrow('avd or deviceName should be specified when reboot option is enables');
                }
                if (!caps.platformVersion) {
                    _logger2['default'].errorAndThrow('avd or platformVersion should be specified when reboot option is enabled');
                }
                var avdDevice = caps.deviceName.replace(/[^a-zA-Z0-9_.]/g, "-");
                this.opts.avd = avdDevice + '__' + caps.platformVersion;
            }
        }
    }, {
        key: 'addWipeDataToAvdArgs',
        value: function addWipeDataToAvdArgs() {
            if (!this.opts.avdArgs) {
                this.opts.avdArgs = '-wipe-data';
            } else if (this.opts.avdArgs.toLowerCase().indexOf("-wipe-data") === -1) {
                this.opts.avdArgs += ' -wipe-data';
            }
        }
    }, {
        key: 'onSettingsUpdate',
        value: function onSettingsUpdate(key, value) {
            return _regeneratorRuntime.async(function onSettingsUpdate$(context$2$0) {
                while (1) switch (context$2$0.prev = context$2$0.next) {
                    case 0:
                        if (!(key === "ignoreUnimportantViews")) {
                            context$2$0.next = 3;
                            break;
                        }

                        context$2$0.next = 3;
                        return _regeneratorRuntime.awrap(this.setCompressedLayoutHierarchy(value));

                    case 3:
                    case 'end':
                        return context$2$0.stop();
                }
            }, null, this);
        }
    }, {
        key: 'startAndroidSession',
        value: function startAndroidSession() {
            return _regeneratorRuntime.async(function startAndroidSession$(context$2$0) {
                var _this = this;

                while (1) switch (context$2$0.prev = context$2$0.next) {
                    case 0:
                        _logger2['default'].info('Starting Android session');
                        // set up the device to run on (real or emulator, etc)
                        context$2$0.next = 3;
                        return _regeneratorRuntime.awrap(_androidHelpers2['default'].initDevice(this.adb, this.opts));

                    case 3:
                        this.defaultIME = context$2$0.sent;

                        // set actual device name, udid, platform version, screen size, model and manufacturer details
                        this.caps.deviceName = this.adb.curDeviceId;
                        this.caps.deviceUDID = this.opts.udid;
                        context$2$0.next = 8;
                        return _regeneratorRuntime.awrap(this.adb.getPlatformVersion());

                    case 8:
                        this.caps.platformVersion = context$2$0.sent;
                        context$2$0.next = 11;
                        return _regeneratorRuntime.awrap(this.adb.getScreenSize());

                    case 11:
                        this.caps.deviceScreenSize = context$2$0.sent;
                        context$2$0.next = 14;
                        return _regeneratorRuntime.awrap(this.adb.getModel());

                    case 14:
                        this.caps.deviceModel = context$2$0.sent;
                        context$2$0.next = 17;
                        return _regeneratorRuntime.awrap(this.adb.getManufacturer());

                    case 17:
                        this.caps.deviceManufacturer = context$2$0.sent;

                        if (!this.opts.autoLaunch) {
                            context$2$0.next = 21;
                            break;
                        }

                        context$2$0.next = 21;
                        return _regeneratorRuntime.awrap(this.initAUT());

                    case 21:

                        _logger2['default'].debug('mmmmmmmmmmmmmmmmmmmmmmmmmmmm-----testbundle start--------------');
                        this.testbundle = new _androidHelpers2['default'].testbundle(this.adb, this.testbundlePort);
                        context$2$0.next = 25;
                        return _regeneratorRuntime.awrap(this.testbundle.start());

                    case 25:
                        this.testbundle.onUnexpectedShutdown['catch'](function callee$2$0(err) {
                            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                                while (1) switch (context$3$0.prev = context$3$0.next) {
                                    case 0:
                                        if (this.testbundle.ignoreUnexpectedShutdown) {
                                            context$3$0.next = 4;
                                            break;
                                        }

                                        _logger2['default'].debug('start testbundle unexpected shutdown');
                                        context$3$0.next = 4;
                                        return _regeneratorRuntime.awrap(this.startUnexpectedShutdown(err));

                                    case 4:
                                    case 'end':
                                        return context$3$0.stop();
                                }
                            }, null, _this);
                        });
                        _logger2['default'].debug('mmmmmmmmmmmmmmmmmmmmmmmmmmmmm-----testbundle end-------------');

                        _logger2['default'].debug('mmmmmmmmmmmmmmmmmmmmmmmmmmm-----bootstrap start---------------');
                        // start UiAutomator
                        this.bootstrap = new _androidHelpers2['default'].bootstrap(this.adb, this.bootstrapPort, this.opts.websocket);
                        context$2$0.next = 31;
                        return _regeneratorRuntime.awrap(this.bootstrap.start(this.opts.appPackage, this.opts.disableAndroidWatchers, this.opts.acceptSslCerts));

                    case 31:
                        // handling unexpected shutdown
                        this.bootstrap.onUnexpectedShutdown['catch'](function callee$2$0(err) {
                            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                                while (1) switch (context$3$0.prev = context$3$0.next) {
                                    case 0:
                                        if (this.bootstrap.ignoreUnexpectedShutdown) {
                                            context$3$0.next = 3;
                                            break;
                                        }

                                        context$3$0.next = 3;
                                        return _regeneratorRuntime.awrap(this.startUnexpectedShutdown(err));

                                    case 3:
                                    case 'end':
                                        return context$3$0.stop();
                                }
                            }, null, _this);
                        });
                        _logger2['default'].debug('mmmmmmmmmmmmmmmmmmmmmmmmmmm-----bootstrap end---------------');

                        // Let's try to unlock the device
                        context$2$0.next = 35;
                        return _regeneratorRuntime.awrap(_androidHelpers2['default'].unlock(this, this.adb, this.caps));

                    case 35:
                        if (!this.opts.ignoreUnimportantViews) {
                            context$2$0.next = 38;
                            break;
                        }

                        context$2$0.next = 38;
                        return _regeneratorRuntime.awrap(this.settings.update({ ignoreUnimportantViews: this.opts.ignoreUnimportantViews }));

                    case 38:
                        if (!this.isChromeSession) {
                            context$2$0.next = 46;
                            break;
                        }

                        context$2$0.next = 41;
                        return _regeneratorRuntime.awrap(this.startChromeSession());

                    case 41:
                        if (!this.shouldDismissChromeWelcome()) {
                            context$2$0.next = 44;
                            break;
                        }

                        context$2$0.next = 44;
                        return _regeneratorRuntime.awrap(this.dismissChromeWelcome());

                    case 44:
                        context$2$0.next = 49;
                        break;

                    case 46:
                        if (!this.opts.autoLaunch) {
                            context$2$0.next = 49;
                            break;
                        }

                        context$2$0.next = 49;
                        return _regeneratorRuntime.awrap(this.startAUT());

                    case 49:
                        context$2$0.next = 51;
                        return _regeneratorRuntime.awrap(this.initAutoWebview());

                    case 51:
                    case 'end':
                        return context$2$0.stop();
                }
            }, null, this);
        }
    }, {
        key: 'shouldDismissChromeWelcome',
        value: function shouldDismissChromeWelcome() {
            return !_lodash2['default'].isUndefined(this.opts.chromeOptions) && _lodash2['default'].isArray(this.opts.chromeOptions.args) && this.opts.chromeOptions.args.indexOf('--no-first-run') !== -1;
        }
    }, {
        key: 'dismissChromeWelcome',
        value: function dismissChromeWelcome() {
            var activity, el, _el;

            return _regeneratorRuntime.async(function dismissChromeWelcome$(context$2$0) {
                while (1) switch (context$2$0.prev = context$2$0.next) {
                    case 0:
                        _logger2['default'].info("Trying to dismiss Chrome welcome");
                        context$2$0.next = 3;
                        return _regeneratorRuntime.awrap(this.getCurrentActivity());

                    case 3:
                        activity = context$2$0.sent;

                        if (!(activity !== "org.chromium.chrome.browser.firstrun.FirstRunActivity")) {
                            context$2$0.next = 7;
                            break;
                        }

                        _logger2['default'].info("Chrome welcome dialog never showed up! Continuing");
                        return context$2$0.abrupt('return');

                    case 7:
                        context$2$0.next = 9;
                        return _regeneratorRuntime.awrap(this.findElOrEls('id', 'com.android.chrome:id/terms_accept', false));

                    case 9:
                        el = context$2$0.sent;
                        context$2$0.next = 12;
                        return _regeneratorRuntime.awrap(this.click(el.ELEMENT));

                    case 12:
                        context$2$0.prev = 12;
                        context$2$0.next = 15;
                        return _regeneratorRuntime.awrap(this.findElOrEls('id', 'com.android.chrome:id/negative_button', false));

                    case 15:
                        _el = context$2$0.sent;
                        context$2$0.next = 18;
                        return _regeneratorRuntime.awrap(this.click(_el.ELEMENT));

                    case 18:
                        context$2$0.next = 23;
                        break;

                    case 20:
                        context$2$0.prev = 20;
                        context$2$0.t0 = context$2$0['catch'](12);

                        // DO NOTHING, THIS DEVICE DIDNT LAUNCH THE SIGNIN DIALOG
                        // IT MUST BE A NON GMS DEVICE
                        _logger2['default'].warn('This device didnt show Chrome SignIn dialog, ' + context$2$0.t0.message);

                    case 23:
                    case 'end':
                        return context$2$0.stop();
                }
            }, null, this, [[12, 20]]);
        }
    }, {
        key: 'initAutoWebview',
        value: function initAutoWebview() {
            return _regeneratorRuntime.async(function initAutoWebview$(context$2$0) {
                var _this3 = this;

                while (1) switch (context$2$0.prev = context$2$0.next) {
                    case 0:
                        if (!this.opts.autoWebview) {
                            context$2$0.next = 3;
                            break;
                        }

                        context$2$0.next = 3;
                        return _regeneratorRuntime.awrap((function callee$2$0() {
                            var viewName, timeout;
                            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                                var _this2 = this;

                                while (1) switch (context$3$0.prev = context$3$0.next) {
                                    case 0:
                                        viewName = this.defaultWebviewName();
                                        timeout = this.opts.autoWebviewTimeout || 2000;

                                        _logger2['default'].info('Setting auto webview to context \'' + viewName + '\' with timeout ' + timeout + 'ms');

                                        // try every 500ms until timeout is over
                                        context$3$0.next = 5;
                                        return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(timeout / 500, 500, function callee$3$0() {
                                            return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                                                while (1) switch (context$4$0.prev = context$4$0.next) {
                                                    case 0:
                                                        context$4$0.next = 2;
                                                        return _regeneratorRuntime.awrap(this.setContext(viewName));

                                                    case 2:
                                                    case 'end':
                                                        return context$4$0.stop();
                                                }
                                            }, null, _this2);
                                        }));

                                    case 5:
                                    case 'end':
                                        return context$3$0.stop();
                                }
                            }, null, _this3);
                        })());

                    case 3:
                    case 'end':
                        return context$2$0.stop();
                }
            }, null, this);
        }
    }, {
        key: 'initAUT',
        value: function initAUT() {
            var launchInfo;
            return _regeneratorRuntime.async(function initAUT$(context$2$0) {
                while (1) switch (context$2$0.prev = context$2$0.next) {
                    case 0:
                        context$2$0.next = 2;
                        return _regeneratorRuntime.awrap(_androidHelpers2['default'].getLaunchInfo(this.adb, this.opts));

                    case 2:
                        launchInfo = context$2$0.sent;

                        _Object$assign(this.opts, launchInfo);
                        _Object$assign(this.caps, launchInfo);
                        // install app

                        if (this.opts.app) {
                            context$2$0.next = 14;
                            break;
                        }

                        if (this.opts.fullReset) {
                            _logger2['default'].errorAndThrow('Full reset requires an app capability, use fastReset if app is not provided');
                        }
                        _logger2['default'].debug('No app capability. Assuming it is already on the device');

                        if (!this.opts.fastReset) {
                            context$2$0.next = 11;
                            break;
                        }

                        context$2$0.next = 11;
                        return _regeneratorRuntime.awrap(_androidHelpers2['default'].resetApp(this.adb, this.opts.app, this.opts.appPackage, this.opts.fastReset));

                    case 11:
                        context$2$0.next = 13;
                        return _regeneratorRuntime.awrap(this.grantPermissions());

                    case 13:
                        return context$2$0.abrupt('return');

                    case 14:
                        if (this.opts.skipUninstall) {
                            context$2$0.next = 17;
                            break;
                        }

                        context$2$0.next = 17;
                        return _regeneratorRuntime.awrap(this.adb.uninstallApk(this.opts.appPackage));

                    case 17:
                        context$2$0.next = 19;
                        return _regeneratorRuntime.awrap(_androidHelpers2['default'].installApkRemotely(this.adb, this.opts));

                    case 19:
                        context$2$0.next = 21;
                        return _regeneratorRuntime.awrap(this.grantPermissions());

                    case 21:
                        context$2$0.next = 23;
                        return _regeneratorRuntime.awrap(_androidHelpers2['default'].pushStrings(this.opts.language, this.adb, this.opts));

                    case 23:
                        this.apkStrings[this.opts.language] = context$2$0.sent;

                    case 24:
                    case 'end':
                        return context$2$0.stop();
                }
            }, null, this);
        }
    }, {
        key: 'startChromeSession',
        value: function startChromeSession() {
            var opts, knownPackages;
            return _regeneratorRuntime.async(function startChromeSession$(context$2$0) {
                var _this4 = this;

                while (1) switch (context$2$0.prev = context$2$0.next) {
                    case 0:
                        _logger2['default'].info("Starting a chrome-based browser session");
                        opts = _lodash2['default'].cloneDeep(this.opts);

                        opts.chromeUseRunningApp = false;

                        knownPackages = ["org.chromium.chrome.shell", "com.android.chrome", "com.chrome.beta", "org.chromium.chrome", "org.chromium.webview_shell"];

                        if (!_lodash2['default'].contains(knownPackages, this.opts.appPackage)) {
                            opts.chromeAndroidActivity = this.opts.appActivity;
                        }
                        context$2$0.next = 7;
                        return _regeneratorRuntime.awrap((0, _commandsContext.setupNewChromedriver)(opts, this.adb.curDeviceId, this.adb));

                    case 7:
                        this.chromedriver = context$2$0.sent;

                        this.chromedriver.on(_appiumChromedriver2['default'].EVENT_CHANGED, function (msg) {
                            if (msg.state === _appiumChromedriver2['default'].STATE_STOPPED) {
                                _this4.onChromedriverStop(_webviewHelpers.CHROMIUM_WIN);
                            }
                        });

                        // Now that we have a Chrome session, we ensure that the context is
                        // appropriately set and that this chromedriver is added to the list
                        // of session chromedrivers so we can switch back and forth
                        this.curContext = _webviewHelpers.CHROMIUM_WIN;
                        this.sessionChromedrivers[_webviewHelpers.CHROMIUM_WIN] = this.chromedriver;
                        this.proxyReqRes = this.chromedriver.proxyReq.bind(this.chromedriver);
                        this.jwpProxyActive = true;

                    case 13:
                    case 'end':
                        return context$2$0.stop();
                }
            }, null, this);
        }
    }, {
        key: 'checkAppPresent',
        value: function checkAppPresent() {
            return _regeneratorRuntime.async(function checkAppPresent$(context$2$0) {
                while (1) switch (context$2$0.prev = context$2$0.next) {
                    case 0:
                        _logger2['default'].debug("Checking whether app is actually present");
                        context$2$0.next = 3;
                        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.opts.app));

                    case 3:
                        if (context$2$0.sent) {
                            context$2$0.next = 5;
                            break;
                        }

                        _logger2['default'].errorAndThrow('Could not find app apk at ' + this.opts.app);

                    case 5:
                    case 'end':
                        return context$2$0.stop();
                }
            }, null, this);
        }
    }, {
        key: 'checkPackagePresent',
        value: function checkPackagePresent() {
            return _regeneratorRuntime.async(function checkPackagePresent$(context$2$0) {
                while (1) switch (context$2$0.prev = context$2$0.next) {
                    case 0:
                        _logger2['default'].debug("Checking whether package is present on the device");
                        context$2$0.next = 3;
                        return _regeneratorRuntime.awrap(this.adb.shell(['pm', 'list', 'packages', this.opts.appPackage]));

                    case 3:
                        if (context$2$0.sent) {
                            context$2$0.next = 5;
                            break;
                        }

                        _logger2['default'].errorAndThrow('Could not find package ' + this.opts.appPackage + ' on the device');

                    case 5:
                    case 'end':
                        return context$2$0.stop();
                }
            }, null, this);
        }
    }, {
        key: 'grantPermissions',
        value: function grantPermissions() {
            return _regeneratorRuntime.async(function grantPermissions$(context$2$0) {
                while (1) switch (context$2$0.prev = context$2$0.next) {
                    case 0:
                        if (!this.opts.autoGrantPermissions) {
                            context$2$0.next = 9;
                            break;
                        }

                        context$2$0.prev = 1;
                        context$2$0.next = 4;
                        return _regeneratorRuntime.awrap(this.adb.grantAllPermissions(this.opts.appPackage, this.opts.app));

                    case 4:
                        context$2$0.next = 9;
                        break;

                    case 6:
                        context$2$0.prev = 6;
                        context$2$0.t0 = context$2$0['catch'](1);

                        _logger2['default'].error('Unable to grant permissions requested. Original error: ' + context$2$0.t0.message);

                    case 9:
                    case 'end':
                        return context$2$0.stop();
                }
            }, null, this, [[1, 6]]);
        }

        // Set CompressedLayoutHierarchy on the device
    }, {
        key: 'setCompressedLayoutHierarchy',
        value: function setCompressedLayoutHierarchy(compress) {
            return _regeneratorRuntime.async(function setCompressedLayoutHierarchy$(context$2$0) {
                while (1) switch (context$2$0.prev = context$2$0.next) {
                    case 0:
                        context$2$0.next = 2;
                        return _regeneratorRuntime.awrap(this.bootstrap.sendAction("compressedLayoutHierarchy", { compressLayout: compress }));

                    case 2:
                    case 'end':
                        return context$2$0.stop();
                }
            }, null, this);
        }
    }, {
        key: 'deleteSession',
        value: function deleteSession() {
            var avdName;
            return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
                while (1) switch (context$2$0.prev = context$2$0.next) {
                    case 0:
                        _logger2['default'].debug("Shutting down Android driver");
                        context$2$0.next = 3;
                        return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(AndroidDriver.prototype), 'deleteSession', this).call(this));

                    case 3:
                        if (!this.bootstrap) {
                            context$2$0.next = 26;
                            break;
                        }

                        context$2$0.next = 6;
                        return _regeneratorRuntime.awrap(this.stopChromedriverProxies());

                    case 6:
                        if (!(this.opts.unicodeKeyboard && this.opts.resetKeyboard && this.defaultIME)) {
                            context$2$0.next = 10;
                            break;
                        }

                        _logger2['default'].debug('Resetting IME to ' + this.defaultIME);
                        context$2$0.next = 10;
                        return _regeneratorRuntime.awrap(this.adb.setIME(this.defaultIME));

                    case 10:
                        context$2$0.next = 12;
                        return _regeneratorRuntime.awrap(this.bootstrap.shutdown());

                    case 12:
                        this.bootstrap = null;

                        if (this.isChromeSession) {
                            context$2$0.next = 19;
                            break;
                        }

                        context$2$0.next = 16;
                        return _regeneratorRuntime.awrap(this.testbundle.shutdown());

                    case 16:
                        this.testbundle = null;
                        context$2$0.next = 19;
                        return _regeneratorRuntime.awrap(this.adb.forceStop(this.opts.appPackage));

                    case 19:
                        context$2$0.next = 21;
                        return _regeneratorRuntime.awrap(this.adb.goToHome());

                    case 21:
                        if (!(this.opts.fullReset && !this.opts.skipUninstall && !this.appOnDevice)) {
                            context$2$0.next = 24;
                            break;
                        }

                        context$2$0.next = 24;
                        return _regeneratorRuntime.awrap(this.adb.uninstallApk(this.opts.appPackage));

                    case 24:
                        context$2$0.next = 27;
                        break;

                    case 26:
                        _logger2['default'].debug("Called deleteSession but bootstrap wasn't active");

                    case 27:
                        if (!this.opts.startLogcat) {
                            context$2$0.next = 30;
                            break;
                        }

                        context$2$0.next = 30;
                        return _regeneratorRuntime.awrap(this.adb.stopLogcat());

                    case 30:
                        if (!this.useUnlockHelperApp) {
                            context$2$0.next = 33;
                            break;
                        }

                        context$2$0.next = 33;
                        return _regeneratorRuntime.awrap(this.adb.forceStop('io.appium.unlock'));

                    case 33:
                        if (!this.opts.reboot) {
                            context$2$0.next = 38;
                            break;
                        }

                        avdName = this.opts.avd.replace('@', '');

                        _logger2['default'].debug('closing emulator \'' + avdName + '\'');
                        context$2$0.next = 38;
                        return _regeneratorRuntime.awrap(this.adb.killEmulator(avdName));

                    case 38:
                        if (!this.opts.clearSystemFiles) {
                            context$2$0.next = 54;
                            break;
                        }

                        if (!this.opts.appIsTemp) {
                            context$2$0.next = 51;
                            break;
                        }

                        _logger2['default'].debug('Temporary copy of app was made: deleting \'' + this.opts.app + '\'');
                        context$2$0.prev = 41;
                        context$2$0.next = 44;
                        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(this.opts.app));

                    case 44:
                        context$2$0.next = 49;
                        break;

                    case 46:
                        context$2$0.prev = 46;
                        context$2$0.t0 = context$2$0['catch'](41);

                        _logger2['default'].warn('Unable to delete temporary app: ' + context$2$0.t0.message);

                    case 49:
                        context$2$0.next = 52;
                        break;

                    case 51:
                        _logger2['default'].debug('App was not copied, so not deleting');

                    case 52:
                        context$2$0.next = 55;
                        break;

                    case 54:
                        _logger2['default'].debug('Not cleaning generated files. Add `clearSystemFiles` capability if wanted.');

                    case 55:
                    case 'end':
                        return context$2$0.stop();
                }
            }, null, this, [[41, 46]]);
        }
    }, {
        key: 'validateDesiredCaps',
        value: function validateDesiredCaps(caps) {
            // check with the base class, and return if it fails
            var res = _get(Object.getPrototypeOf(AndroidDriver.prototype), 'validateDesiredCaps', this).call(this, caps);
            if (!res) return res; // eslint-disable-line curly

            // make sure that the capabilities have one of `app`, `appPackage` or `browser`
            if ((!caps.browserName || !_androidHelpers2['default'].isChromeBrowser(caps.browserName)) && !caps.app && !caps.appPackage) {
                var msg = 'The desired capabilities must include either an app, appPackage or browserName';
                _logger2['default'].errorAndThrow(msg);
            }
            // warn if the capabilities have both `app` and `browser, although this
            // is common with selenium grid
            if (caps.browserName && caps.app) {
                var msg = 'The desired capabilities should generally not include both an app and a browserName';
                _logger2['default'].warn(msg);
            }
        }
    }, {
        key: 'proxyActive',
        value: function proxyActive(sessionId) {
            _get(Object.getPrototypeOf(AndroidDriver.prototype), 'proxyActive', this).call(this, sessionId);

            return this.jwpProxyActive;
        }
    }, {
        key: 'getProxyAvoidList',
        value: function getProxyAvoidList(sessionId) {
            _get(Object.getPrototypeOf(AndroidDriver.prototype), 'getProxyAvoidList', this).call(this, sessionId);

            return this.jwpProxyAvoid;
        }
    }, {
        key: 'canProxy',
        value: function canProxy(sessionId) {
            _get(Object.getPrototypeOf(AndroidDriver.prototype), 'canProxy', this).call(this, sessionId);

            // this will change depending on ChromeDriver status
            return _lodash2['default'].isFunction(this.proxyReqRes);
        }
    }, {
        key: 'appOnDevice',
        get: function get() {
            return this.helpers.isPackageOrBundle(this.opts.app) || !this.opts.app && this.helpers.isPackageOrBundle(this.opts.appPackage);
        }
    }, {
        key: 'isChromeSession',
        get: function get() {
            return _androidHelpers2['default'].isChromeBrowser(this.opts.browserName);
        }
    }]);

    return AndroidDriver;
})(_appiumBaseDriver.BaseDriver);

exports['default'] = AndroidDriver;
module.exports = exports['default'];

// the whole createSession flow is surrounded in a try-catch statement
// if creating a session fails at any point, we teardown everything we
// set up before throwing the error.

// find and copy, or download and unzip an app url or path

// Some cloud services using appium launch the avd themselves, so we ensure netspeed
// is set for emulators by calling adb.networkSpeed before running the app

// check if we have to enable/disable gps before running the application

// ignoring delete session exception if any and throw the real error
// that happened while creating the session.

// If the user sets autoLaunch to false, they are responsible for initAUT() and startAUT()

// set up app under test
// eslint-disable-line promise/prefer-await-to-callbacks

// Set CompressedLayoutHierarchy on the device based on current settings object
// this has to happen _after_ bootstrap is initialized

// start a chromedriver session and proxy to it

// dismiss Chrome welcome dialog

// start app

// populate appPackage, appActivity, appWaitPackage, appWaitActivity,
// and the device being used
// in the opts and caps (so it gets back to the user on session creation)

// certain cleanup we only care to do if the bootstrap was ever run

// 要先关闭bootstrap

// testbundle关掉后，应用也会关闭

// some cleanup we want to do regardless, in case we are shutting down
// mid-startup
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUNkLG1CQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUNuRSxJQUFJLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEFBQUMsQ0FBQztTQUM3RDs7O2FBRWtCLGVBQUc7QUFDbEIsbUJBQU8sNEJBQVEsZUFBZSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDekQ7OztXQXRNQyxhQUFhOzs7cUJBOGVKLGFBQWEiLCJmaWxlIjoibGliL2RyaXZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7QmFzZURyaXZlciwgRGV2aWNlU2V0dGluZ3N9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgQ2hyb21lZHJpdmVyIGZyb20gJ2FwcGl1bS1jaHJvbWVkcml2ZXInO1xuaW1wb3J0IGRlc2lyZWRDb25zdHJhaW50cyBmcm9tICcuL2Rlc2lyZWQtY2Fwcyc7XG5pbXBvcnQgY29tbWFuZHMgZnJvbSAnLi9jb21tYW5kcy9pbmRleCc7XG5pbXBvcnQge3NldHVwTmV3Q2hyb21lZHJpdmVyfSBmcm9tICcuL2NvbW1hbmRzL2NvbnRleHQnO1xuaW1wb3J0IGhlbHBlcnMgZnJvbSAnLi9hbmRyb2lkLWhlbHBlcnMnO1xuaW1wb3J0IHtDSFJPTUlVTV9XSU59IGZyb20gJy4vd2Vidmlldy1oZWxwZXJzJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7REVGQVVMVF9BREJfUE9SVH0gZnJvbSAnYXBwaXVtLWFkYic7XG5pbXBvcnQge2ZzLCB0ZW1wRGlyLCB1dGlsfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQge3JldHJ5SW50ZXJ2YWx9IGZyb20gJ2FzeW5jYm94JztcblxuXG5jb25zdCBBUFBfRVhURU5TSU9OID0gJy5hcGsnO1xuY29uc3QgREVWSUNFX1BPUlQgPSA0NzI1O1xuY29uc3QgVEVTVEJVTkRMRV9QT1JUID0gNDcyNDtcblxuLy8gVGhpcyBpcyBhIHNldCBvZiBtZXRob2RzIGFuZCBwYXRocyB0aGF0IHdlIG5ldmVyIHdhbnQgdG8gcHJveHkgdG9cbi8vIENocm9tZWRyaXZlclxuY29uc3QgTk9fUFJPWFkgPSBbXG4gICAgWydQT1NUJywgbmV3IFJlZ0V4cCgnXi9zZXNzaW9uL1teL10rL2NvbnRleHQnKV0sXG4gICAgWydHRVQnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvY29udGV4dCcpXSxcbiAgICBbJ1BPU1QnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvYXBwaXVtJyldLFxuICAgIFsnR0VUJywgbmV3IFJlZ0V4cCgnXi9zZXNzaW9uL1teL10rL2FwcGl1bScpXSxcbiAgICBbJ1BPU1QnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvdG91Y2gvcGVyZm9ybScpXSxcbiAgICBbJ1BPU1QnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvdG91Y2gvbXVsdGkvcGVyZm9ybScpXSxcbiAgICBbJ1BPU1QnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvb3JpZW50YXRpb24nKV0sXG4gICAgWydHRVQnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvb3JpZW50YXRpb24nKV0sXG5dO1xuXG5jbGFzcyBBbmRyb2lkRHJpdmVyIGV4dGVuZHMgQmFzZURyaXZlciB7XG4gICAgY29uc3RydWN0b3Iob3B0cyA9IHt9LCBzaG91bGRWYWxpZGF0ZUNhcHMgPSB0cnVlKSB7XG4gICAgICAgIHN1cGVyKG9wdHMsIHNob3VsZFZhbGlkYXRlQ2Fwcyk7XG5cbiAgICAgICAgdGhpcy5sb2NhdG9yU3RyYXRlZ2llcyA9IFtcbiAgICAgICAgICAgICd4cGF0aCcsXG4gICAgICAgICAgICAnbmFtZScsXG4gICAgICAgICAgICAnaWQnLFxuICAgICAgICAgICAgJ2NsYXNzIG5hbWUnLFxuICAgICAgICAgICAgJ2FjY2Vzc2liaWxpdHkgaWQnLFxuICAgICAgICAgICAgJy1hbmRyb2lkIHVpYXV0b21hdG9yJ1xuICAgICAgICBdO1xuICAgICAgICB0aGlzLmRlc2lyZWRDYXBDb25zdHJhaW50cyA9IGRlc2lyZWRDb25zdHJhaW50cztcbiAgICAgICAgdGhpcy5zZXNzaW9uQ2hyb21lZHJpdmVycyA9IHt9O1xuICAgICAgICB0aGlzLmp3cFByb3h5QWN0aXZlID0gZmFsc2U7XG4gICAgICAgIHRoaXMuandwUHJveHlBdm9pZCA9IF8uY2xvbmUoTk9fUFJPWFkpO1xuICAgICAgICB0aGlzLnNldHRpbmdzID0gbmV3IERldmljZVNldHRpbmdzKHtpZ25vcmVVbmltcG9ydGFudFZpZXdzOiBmYWxzZX0sXG4gICAgICAgICAgICB0aGlzLm9uU2V0dGluZ3NVcGRhdGUuYmluZCh0aGlzKSk7XG4gICAgICAgIHRoaXMuY2hyb21lZHJpdmVyID0gbnVsbDtcbiAgICAgICAgdGhpcy5hcGtTdHJpbmdzID0ge307XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwUG9ydCA9IG9wdHMuYm9vdHN0cmFwUG9ydCB8fCBERVZJQ0VfUE9SVDtcbiAgICAgICAgdGhpcy50ZXN0YnVuZGxlUG9ydCA9IG9wdHMudGVzdGJ1bmRsZVBvcnQgfHwgVEVTVEJVTkRMRV9QT1JUXG4gICAgICAgIHRoaXMudW5sb2NrZXIgPSBoZWxwZXJzLnVubG9ja2VyO1xuXG4gICAgICAgIGZvciAobGV0IFtjbWQsIGZuXSBvZiBfLnBhaXJzKGNvbW1hbmRzKSkge1xuICAgICAgICAgICAgQW5kcm9pZERyaXZlci5wcm90b3R5cGVbY21kXSA9IGZuO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgY3JlYXRlU2Vzc2lvbihjYXBzKSB7XG4gICAgICAgIC8vIHRoZSB3aG9sZSBjcmVhdGVTZXNzaW9uIGZsb3cgaXMgc3Vycm91bmRlZCBpbiBhIHRyeS1jYXRjaCBzdGF0ZW1lbnRcbiAgICAgICAgLy8gaWYgY3JlYXRpbmcgYSBzZXNzaW9uIGZhaWxzIGF0IGFueSBwb2ludCwgd2UgdGVhcmRvd24gZXZlcnl0aGluZyB3ZVxuICAgICAgICAvLyBzZXQgdXAgYmVmb3JlIHRocm93aW5nIHRoZSBlcnJvci5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGxldCBzZXNzaW9uSWQ7XG4gICAgICAgICAgICBbc2Vzc2lvbklkXSA9IGF3YWl0IHN1cGVyLmNyZWF0ZVNlc3Npb24oY2Fwcyk7XG5cbiAgICAgICAgICAgIGxldCBzZXJ2ZXJEZXRhaWxzID0ge1xuICAgICAgICAgICAgICAgIHBsYXRmb3JtOiAnTElOVVgnLFxuICAgICAgICAgICAgICAgIHdlYlN0b3JhZ2VFbmFibGVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB0YWtlc1NjcmVlbnNob3Q6IHRydWUsXG4gICAgICAgICAgICAgICAgamF2YXNjcmlwdEVuYWJsZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgZGF0YWJhc2VFbmFibGVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBuZXR3b3JrQ29ubmVjdGlvbkVuYWJsZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgbG9jYXRpb25Db250ZXh0RW5hYmxlZDogZmFsc2UsXG4gICAgICAgICAgICAgICAgd2FybmluZ3M6IHt9LFxuICAgICAgICAgICAgICAgIGRlc2lyZWQ6IHRoaXMuY2Fwc1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgdGhpcy5jYXBzID0gT2JqZWN0LmFzc2lnbihzZXJ2ZXJEZXRhaWxzLCB0aGlzLmNhcHMpO1xuXG4gICAgICAgICAgICAvLyBhc3NpZ25pbmcgZGVmYXVsdHNcbiAgICAgICAgICAgIGxldCBkZWZhdWx0T3B0cyA9IHtcbiAgICAgICAgICAgICAgICBhY3Rpb246IFwiYW5kcm9pZC5pbnRlbnQuYWN0aW9uLk1BSU5cIixcbiAgICAgICAgICAgICAgICBjYXRlZ29yeTogXCJhbmRyb2lkLmludGVudC5jYXRlZ29yeS5MQVVOQ0hFUlwiLFxuICAgICAgICAgICAgICAgIGZsYWdzOiBcIjB4MTAyMDAwMDBcIixcbiAgICAgICAgICAgICAgICBkaXNhYmxlQW5kcm9pZFdhdGNoZXJzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB0bXBEaXI6IGF3YWl0IHRlbXBEaXIuc3RhdGljRGlyKCksXG4gICAgICAgICAgICAgICAgZnVsbFJlc2V0OiBmYWxzZSxcbiAgICAgICAgICAgICAgICBhdXRvTGF1bmNoOiB0cnVlLFxuICAgICAgICAgICAgICAgIGFkYlBvcnQ6IERFRkFVTFRfQURCX1BPUlQsXG4gICAgICAgICAgICAgICAgYW5kcm9pZEluc3RhbGxUaW1lb3V0OiA5MDAwMFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIC8vIOi/memHjOWvuW9wdHMudXVpZOWtl+auteayoeW9seWTjVxuICAgICAgICAgICAgXy5kZWZhdWx0cyh0aGlzLm9wdHMsIGRlZmF1bHRPcHRzKTtcbiAgICAgICAgICAgIGlmICghdGhpcy5vcHRzLmphdmFWZXJzaW9uKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vcHRzLmphdmFWZXJzaW9uID0gYXdhaXQgaGVscGVycy5nZXRKYXZhVmVyc2lvbigpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy51c2VVbmxvY2tIZWxwZXJBcHAgPSBfLmlzVW5kZWZpbmVkKHRoaXMuY2Fwcy51bmxvY2tUeXBlKTtcblxuICAgICAgICAgICAgLy8gbm90IHVzZXIgdmlzaWJsZSB2aWEgY2Fwc1xuICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5ub1Jlc2V0ID09PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vcHRzLmZ1bGxSZXNldCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5mdWxsUmVzZXQgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9wdHMubm9SZXNldCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5vcHRzLmZhc3RSZXNldCA9ICF0aGlzLm9wdHMuZnVsbFJlc2V0ICYmICF0aGlzLm9wdHMubm9SZXNldDtcbiAgICAgICAgICAgIHRoaXMub3B0cy5za2lwVW5pbnN0YWxsID0gdGhpcy5vcHRzLmZhc3RSZXNldCB8fCB0aGlzLm9wdHMubm9SZXNldDtcblxuICAgICAgICAgICAgdGhpcy5jdXJDb250ZXh0ID0gdGhpcy5kZWZhdWx0Q29udGV4dE5hbWUoKTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuaXNDaHJvbWVTZXNzaW9uKSB7XG4gICAgICAgICAgICAgICAgbG9nLmluZm8oXCJXZSdyZSBnb2luZyB0byBydW4gYSBDaHJvbWUtYmFzZWQgc2Vzc2lvblwiKTtcbiAgICAgICAgICAgICAgICBsZXQge3BrZywgYWN0aXZpdHl9ID0gaGVscGVycy5nZXRDaHJvbWVQa2codGhpcy5vcHRzLmJyb3dzZXJOYW1lKTtcbiAgICAgICAgICAgICAgICB0aGlzLm9wdHMuYXBwUGFja2FnZSA9IHBrZztcbiAgICAgICAgICAgICAgICB0aGlzLm9wdHMuYXBwQWN0aXZpdHkgPSBhY3Rpdml0eTtcbiAgICAgICAgICAgICAgICBsb2cuaW5mbyhgQ2hyb21lLXR5cGUgcGFja2FnZSBhbmQgYWN0aXZpdHkgYXJlICR7cGtnfSBhbmQgJHthY3Rpdml0eX1gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5uYXRpdmVXZWJTY3JlZW5zaG90KSB7XG4gICAgICAgICAgICAgICAgdGhpcy5qd3BQcm94eUF2b2lkLnB1c2goWydHRVQnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvc2NyZWVuc2hvdCcpXSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMucmVib290KSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRBdmRGcm9tQ2FwYWJpbGl0aWVzKGNhcHMpO1xuICAgICAgICAgICAgICAgIHRoaXMuYWRkV2lwZURhdGFUb0F2ZEFyZ3MoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gZ2V0IGRldmljZSB1ZGlkIGZvciB0aGlzIHNlc3Npb25cbiAgICAgICAgICAgIGxldCB7dWRpZCwgZW1Qb3J0fSA9IGF3YWl0IGhlbHBlcnMuZ2V0RGV2aWNlSW5mb0Zyb21DYXBzKHRoaXMub3B0cyk7XG4gICAgICAgICAgICB0aGlzLm9wdHMudWRpZCA9IHVkaWQ7XG4gICAgICAgICAgICB0aGlzLm9wdHMuZW1Qb3J0ID0gZW1Qb3J0O1xuXG4gICAgICAgICAgICAvLyBzZXQgdXAgYW4gaW5zdGFuY2Ugb2YgQURCXG4gICAgICAgICAgICB0aGlzLmFkYiA9IGF3YWl0IGhlbHBlcnMuY3JlYXRlQURCKHRoaXMub3B0cy5qYXZhVmVyc2lvbixcbiAgICAgICAgICAgICAgICB0aGlzLm9wdHMudWRpZCxcbiAgICAgICAgICAgICAgICB0aGlzLm9wdHMuZW1Qb3J0LFxuICAgICAgICAgICAgICAgIHRoaXMub3B0cy5hZGJQb3J0LFxuICAgICAgICAgICAgICAgIHRoaXMub3B0cy5zdXBwcmVzc0tpbGxTZXJ2ZXIsXG4gICAgICAgICAgICAgICAgdGhpcy5vcHRzLnJlbW90ZUFkYkhvc3QpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5oZWxwZXJzLmlzUGFja2FnZU9yQnVuZGxlKHRoaXMub3B0cy5hcHApKSB7XG4gICAgICAgICAgICAgICAgLy8gdXNlciBwcm92aWRlZCBwYWNrYWdlIGluc3RlYWQgb2YgYXBwIGZvciAnYXBwJyBjYXBhYmlsaXR5LCBtYXNzYWdlIG9wdGlvbnNcbiAgICAgICAgICAgICAgICB0aGlzLm9wdHMuYXBwUGFja2FnZSA9IHRoaXMub3B0cy5hcHA7XG4gICAgICAgICAgICAgICAgdGhpcy5vcHRzLmFwcCA9IG51bGw7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMuYXBwKSB7XG4gICAgICAgICAgICAgICAgLy8gZmluZCBhbmQgY29weSwgb3IgZG93bmxvYWQgYW5kIHVuemlwIGFuIGFwcCB1cmwgb3IgcGF0aFxuICAgICAgICAgICAgICAgIHRoaXMub3B0cy5hcHAgPSBhd2FpdCB0aGlzLmhlbHBlcnMuY29uZmlndXJlQXBwKHRoaXMub3B0cy5hcHAsIEFQUF9FWFRFTlNJT04pO1xuICAgICAgICAgICAgICAgIHRoaXMub3B0cy5hcHBJc1RlbXAgPSBjYXBzLmFwcCAhPT0gdGhpcy5vcHRzLmFwcDsgLy8gZGlkIHdlIG1ha2UgYSB0ZW1wb3JhcnkgY29weT9cbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmNoZWNrQXBwUHJlc2VudCgpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmFwcE9uRGV2aWNlKSB7XG4gICAgICAgICAgICAgICAgLy8gdGhlIGFwcCBpc24ndCBhbiBhY3R1YWwgYXBwIGZpbGUgYnV0IHJhdGhlciBzb21ldGhpbmcgd2Ugd2FudCB0b1xuICAgICAgICAgICAgICAgIC8vIGFzc3VtZSBpcyBvbiB0aGUgZGV2aWNlIGFuZCBqdXN0IGxhdW5jaCB2aWEgdGhlIGFwcFBhY2thZ2VcbiAgICAgICAgICAgICAgICBsb2cuaW5mbyhgQXBwIGZpbGUgd2FzIG5vdCBsaXN0ZWQsIGluc3RlYWQgd2UncmUgZ29pbmcgdG8gcnVuIGAgK1xuICAgICAgICAgICAgICAgICAgICBgJHt0aGlzLm9wdHMuYXBwUGFja2FnZX0gZGlyZWN0bHkgb24gdGhlIGRldmljZWApO1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuY2hlY2tQYWNrYWdlUHJlc2VudCgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBTb21lIGNsb3VkIHNlcnZpY2VzIHVzaW5nIGFwcGl1bSBsYXVuY2ggdGhlIGF2ZCB0aGVtc2VsdmVzLCBzbyB3ZSBlbnN1cmUgbmV0c3BlZWRcbiAgICAgICAgICAgIC8vIGlzIHNldCBmb3IgZW11bGF0b3JzIGJ5IGNhbGxpbmcgYWRiLm5ldHdvcmtTcGVlZCBiZWZvcmUgcnVubmluZyB0aGUgYXBwXG4gICAgICAgICAgICBpZiAoIV8uaXNVbmRlZmluZWQodGhpcy5vcHRzLm5ldHdvcmtTcGVlZCkpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNFbXVsYXRvcigpKSB7XG4gICAgICAgICAgICAgICAgICAgIGxvZy53YXJuKFwiU29ycnksIG5ldHdvcmtTcGVlZCBjYXBhYmlsaXR5IGlzIG9ubHkgYXZhaWxhYmxlIGZvciBlbXVsYXRvcnNcIik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG5ldHdvcmtTcGVlZCA9IGhlbHBlcnMuZW5zdXJlTmV0d29ya1NwZWVkKHRoaXMuYWRiLCB0aGlzLm9wdHMubmV0d29ya1NwZWVkKTtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5hZGIubmV0d29ya1NwZWVkKG5ldHdvcmtTcGVlZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gY2hlY2sgaWYgd2UgaGF2ZSB0byBlbmFibGUvZGlzYWJsZSBncHMgYmVmb3JlIHJ1bm5pbmcgdGhlIGFwcGxpY2F0aW9uXG4gICAgICAgICAgICBpZiAodXRpbC5oYXNWYWx1ZSh0aGlzLm9wdHMuZ3BzRW5hYmxlZCkpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0VtdWxhdG9yKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgbG9nLmluZm8oYFRyeWluZyB0byAke3RoaXMub3B0cy5ncHNFbmFibGVkID8gXCJlbmFibGVcIiA6IFwiZGlzYWJsZVwifSBncHMgbG9jYXRpb24gcHJvdmlkZXJgKTtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5hZGIudG9nZ2xlR1BTTG9jYXRpb25Qcm92aWRlcih0aGlzLm9wdHMuZ3BzRW5hYmxlZCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbG9nLndhcm4oJ1NvcnJ5ISBncHNFbmFibGVkIGNhcGFiaWxpdHkgaXMgb25seSBhdmFpbGFibGUgZm9yIGVtdWxhdG9ycycpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFydEFuZHJvaWRTZXNzaW9uKHRoaXMub3B0cyk7XG4gICAgICAgICAgICByZXR1cm4gW3Nlc3Npb25JZCwgdGhpcy5jYXBzXTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgLy8gaWdub3JpbmcgZGVsZXRlIHNlc3Npb24gZXhjZXB0aW9uIGlmIGFueSBhbmQgdGhyb3cgdGhlIHJlYWwgZXJyb3JcbiAgICAgICAgICAgIC8vIHRoYXQgaGFwcGVuZWQgd2hpbGUgY3JlYXRpbmcgdGhlIHNlc3Npb24uXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuZGVsZXRlU2Vzc2lvbigpO1xuICAgICAgICAgICAgfSBjYXRjaCAoaWduKSB7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaXNFbXVsYXRvcigpIHtcbiAgICAgICAgcmV0dXJuICEhKHRoaXMub3B0cy5hdmQgfHwgL2VtdWxhdG9yLy50ZXN0KHRoaXMub3B0cy51ZGlkKSk7XG4gICAgfVxuXG4gICAgc2V0QXZkRnJvbUNhcGFiaWxpdGllcyhjYXBzKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdHMuYXZkKSB7XG4gICAgICAgICAgICBsb2cuaW5mbygnYXZkIG5hbWUgZGVmaW5lZCwgaWdub3JpbmcgZGV2aWNlIG5hbWUgYW5kIHBsYXRmb3JtIHZlcnNpb24nKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICghY2Fwcy5kZXZpY2VOYW1lKSB7XG4gICAgICAgICAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coJ2F2ZCBvciBkZXZpY2VOYW1lIHNob3VsZCBiZSBzcGVjaWZpZWQgd2hlbiByZWJvb3Qgb3B0aW9uIGlzIGVuYWJsZXMnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghY2Fwcy5wbGF0Zm9ybVZlcnNpb24pIHtcbiAgICAgICAgICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdygnYXZkIG9yIHBsYXRmb3JtVmVyc2lvbiBzaG91bGQgYmUgc3BlY2lmaWVkIHdoZW4gcmVib290IG9wdGlvbiBpcyBlbmFibGVkJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsZXQgYXZkRGV2aWNlID0gY2Fwcy5kZXZpY2VOYW1lLnJlcGxhY2UoL1teYS16QS1aMC05Xy5dL2csIFwiLVwiKTtcbiAgICAgICAgICAgIHRoaXMub3B0cy5hdmQgPSBgJHthdmREZXZpY2V9X18ke2NhcHMucGxhdGZvcm1WZXJzaW9ufWA7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhZGRXaXBlRGF0YVRvQXZkQXJncygpIHtcbiAgICAgICAgaWYgKCF0aGlzLm9wdHMuYXZkQXJncykge1xuICAgICAgICAgICAgdGhpcy5vcHRzLmF2ZEFyZ3MgPSAnLXdpcGUtZGF0YSc7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5vcHRzLmF2ZEFyZ3MudG9Mb3dlckNhc2UoKS5pbmRleE9mKFwiLXdpcGUtZGF0YVwiKSA9PT0gLTEpIHtcbiAgICAgICAgICAgIHRoaXMub3B0cy5hdmRBcmdzICs9ICcgLXdpcGUtZGF0YSc7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXQgYXBwT25EZXZpY2UoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmhlbHBlcnMuaXNQYWNrYWdlT3JCdW5kbGUodGhpcy5vcHRzLmFwcCkgfHwgKCF0aGlzLm9wdHMuYXBwICYmXG4gICAgICAgICAgICB0aGlzLmhlbHBlcnMuaXNQYWNrYWdlT3JCdW5kbGUodGhpcy5vcHRzLmFwcFBhY2thZ2UpKTtcbiAgICB9XG5cbiAgICBnZXQgaXNDaHJvbWVTZXNzaW9uKCkge1xuICAgICAgICByZXR1cm4gaGVscGVycy5pc0Nocm9tZUJyb3dzZXIodGhpcy5vcHRzLmJyb3dzZXJOYW1lKTtcbiAgICB9XG5cbiAgICBhc3luYyBvblNldHRpbmdzVXBkYXRlKGtleSwgdmFsdWUpIHtcbiAgICAgICAgaWYgKGtleSA9PT0gXCJpZ25vcmVVbmltcG9ydGFudFZpZXdzXCIpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc2V0Q29tcHJlc3NlZExheW91dEhpZXJhcmNoeSh2YWx1ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBzdGFydEFuZHJvaWRTZXNzaW9uKCkge1xuICAgICAgICBsb2cuaW5mbyhgU3RhcnRpbmcgQW5kcm9pZCBzZXNzaW9uYCk7XG4gICAgICAgIC8vIHNldCB1cCB0aGUgZGV2aWNlIHRvIHJ1biBvbiAocmVhbCBvciBlbXVsYXRvciwgZXRjKVxuICAgICAgICB0aGlzLmRlZmF1bHRJTUUgPSBhd2FpdCBoZWxwZXJzLmluaXREZXZpY2UodGhpcy5hZGIsIHRoaXMub3B0cyk7XG5cbiAgICAgICAgLy8gc2V0IGFjdHVhbCBkZXZpY2UgbmFtZSwgdWRpZCwgcGxhdGZvcm0gdmVyc2lvbiwgc2NyZWVuIHNpemUsIG1vZGVsIGFuZCBtYW51ZmFjdHVyZXIgZGV0YWlsc1xuICAgICAgICB0aGlzLmNhcHMuZGV2aWNlTmFtZSA9IHRoaXMuYWRiLmN1ckRldmljZUlkO1xuICAgICAgICB0aGlzLmNhcHMuZGV2aWNlVURJRCA9IHRoaXMub3B0cy51ZGlkO1xuICAgICAgICB0aGlzLmNhcHMucGxhdGZvcm1WZXJzaW9uID0gYXdhaXQgdGhpcy5hZGIuZ2V0UGxhdGZvcm1WZXJzaW9uKCk7XG4gICAgICAgIHRoaXMuY2Fwcy5kZXZpY2VTY3JlZW5TaXplID0gYXdhaXQgdGhpcy5hZGIuZ2V0U2NyZWVuU2l6ZSgpO1xuICAgICAgICB0aGlzLmNhcHMuZGV2aWNlTW9kZWwgPSBhd2FpdCB0aGlzLmFkYi5nZXRNb2RlbCgpO1xuICAgICAgICB0aGlzLmNhcHMuZGV2aWNlTWFudWZhY3R1cmVyID0gYXdhaXQgdGhpcy5hZGIuZ2V0TWFudWZhY3R1cmVyKCk7XG5cbiAgICAgICAgLy8gSWYgdGhlIHVzZXIgc2V0cyBhdXRvTGF1bmNoIHRvIGZhbHNlLCB0aGV5IGFyZSByZXNwb25zaWJsZSBmb3IgaW5pdEFVVCgpIGFuZCBzdGFydEFVVCgpXG4gICAgICAgIGlmICh0aGlzLm9wdHMuYXV0b0xhdW5jaCkge1xuICAgICAgICAgICAgLy8gc2V0IHVwIGFwcCB1bmRlciB0ZXN0XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmluaXRBVVQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxvZy5kZWJ1ZygnbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbS0tLS0tdGVzdGJ1bmRsZSBzdGFydC0tLS0tLS0tLS0tLS0tJylcbiAgICAgICAgdGhpcy50ZXN0YnVuZGxlID0gbmV3IGhlbHBlcnMudGVzdGJ1bmRsZSh0aGlzLmFkYiwgdGhpcy50ZXN0YnVuZGxlUG9ydClcbiAgICAgICAgYXdhaXQgdGhpcy50ZXN0YnVuZGxlLnN0YXJ0KClcbiAgICAgICAgdGhpcy50ZXN0YnVuZGxlLm9uVW5leHBlY3RlZFNodXRkb3duLmNhdGNoKGFzeW5jKGVycikgPT4ge1xuICAgICAgICAgICAgaWYgKCF0aGlzLnRlc3RidW5kbGUuaWdub3JlVW5leHBlY3RlZFNodXRkb3duKSB7XG4gICAgICAgICAgICAgICAgbG9nLmRlYnVnKCdzdGFydCB0ZXN0YnVuZGxlIHVuZXhwZWN0ZWQgc2h1dGRvd24nKVxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuc3RhcnRVbmV4cGVjdGVkU2h1dGRvd24oZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGxvZy5kZWJ1ZygnbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW0tLS0tLXRlc3RidW5kbGUgZW5kLS0tLS0tLS0tLS0tLScpXG5cbiAgICAgICAgbG9nLmRlYnVnKCdtbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW0tLS0tLWJvb3RzdHJhcCBzdGFydC0tLS0tLS0tLS0tLS0tLScpXG4gICAgICAgIC8vIHN0YXJ0IFVpQXV0b21hdG9yXG4gICAgICAgIHRoaXMuYm9vdHN0cmFwID0gbmV3IGhlbHBlcnMuYm9vdHN0cmFwKHRoaXMuYWRiLCB0aGlzLmJvb3RzdHJhcFBvcnQsIHRoaXMub3B0cy53ZWJzb2NrZXQpO1xuICAgICAgICBhd2FpdCB0aGlzLmJvb3RzdHJhcC5zdGFydCh0aGlzLm9wdHMuYXBwUGFja2FnZSwgdGhpcy5vcHRzLmRpc2FibGVBbmRyb2lkV2F0Y2hlcnMsIHRoaXMub3B0cy5hY2NlcHRTc2xDZXJ0cyk7XG4gICAgICAgIC8vIGhhbmRsaW5nIHVuZXhwZWN0ZWQgc2h1dGRvd25cbiAgICAgICAgdGhpcy5ib290c3RyYXAub25VbmV4cGVjdGVkU2h1dGRvd24uY2F0Y2goYXN5bmMoZXJyKSA9PiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tY2FsbGJhY2tzXG4gICAgICAgICAgICBpZiAoIXRoaXMuYm9vdHN0cmFwLmlnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93bikge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuc3RhcnRVbmV4cGVjdGVkU2h1dGRvd24oZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGxvZy5kZWJ1ZygnbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tLS0tLS1ib290c3RyYXAgZW5kLS0tLS0tLS0tLS0tLS0tJylcblxuICAgICAgICAvLyBMZXQncyB0cnkgdG8gdW5sb2NrIHRoZSBkZXZpY2VcbiAgICAgICAgYXdhaXQgaGVscGVycy51bmxvY2sodGhpcywgdGhpcy5hZGIsIHRoaXMuY2Fwcyk7XG5cbiAgICAgICAgLy8gU2V0IENvbXByZXNzZWRMYXlvdXRIaWVyYXJjaHkgb24gdGhlIGRldmljZSBiYXNlZCBvbiBjdXJyZW50IHNldHRpbmdzIG9iamVjdFxuICAgICAgICAvLyB0aGlzIGhhcyB0byBoYXBwZW4gX2FmdGVyXyBib290c3RyYXAgaXMgaW5pdGlhbGl6ZWRcbiAgICAgICAgaWYgKHRoaXMub3B0cy5pZ25vcmVVbmltcG9ydGFudFZpZXdzKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnNldHRpbmdzLnVwZGF0ZSh7aWdub3JlVW5pbXBvcnRhbnRWaWV3czogdGhpcy5vcHRzLmlnbm9yZVVuaW1wb3J0YW50Vmlld3N9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmlzQ2hyb21lU2Vzc2lvbikge1xuICAgICAgICAgICAgLy8gc3RhcnQgYSBjaHJvbWVkcml2ZXIgc2Vzc2lvbiBhbmQgcHJveHkgdG8gaXRcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc3RhcnRDaHJvbWVTZXNzaW9uKCk7XG4gICAgICAgICAgICBpZiAodGhpcy5zaG91bGREaXNtaXNzQ2hyb21lV2VsY29tZSgpKSB7XG4gICAgICAgICAgICAgICAgLy8gZGlzbWlzcyBDaHJvbWUgd2VsY29tZSBkaWFsb2dcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmRpc21pc3NDaHJvbWVXZWxjb21lKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodGhpcy5vcHRzLmF1dG9MYXVuY2gpIHtcbiAgICAgICAgICAgICAgICAvLyBzdGFydCBhcHBcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0QVVUKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgdGhpcy5pbml0QXV0b1dlYnZpZXcoKTtcbiAgICB9XG5cbiAgICBzaG91bGREaXNtaXNzQ2hyb21lV2VsY29tZSgpIHtcbiAgICAgICAgcmV0dXJuICFfLmlzVW5kZWZpbmVkKHRoaXMub3B0cy5jaHJvbWVPcHRpb25zKSAmJlxuICAgICAgICAgICAgXy5pc0FycmF5KHRoaXMub3B0cy5jaHJvbWVPcHRpb25zLmFyZ3MpICYmXG4gICAgICAgICAgICB0aGlzLm9wdHMuY2hyb21lT3B0aW9ucy5hcmdzLmluZGV4T2YoJy0tbm8tZmlyc3QtcnVuJykgIT09IC0xO1xuICAgIH1cblxuICAgIGFzeW5jIGRpc21pc3NDaHJvbWVXZWxjb21lKCkge1xuICAgICAgICBsb2cuaW5mbyhcIlRyeWluZyB0byBkaXNtaXNzIENocm9tZSB3ZWxjb21lXCIpO1xuICAgICAgICBsZXQgYWN0aXZpdHkgPSBhd2FpdCB0aGlzLmdldEN1cnJlbnRBY3Rpdml0eSgpO1xuICAgICAgICBpZiAoYWN0aXZpdHkgIT09IFwib3JnLmNocm9taXVtLmNocm9tZS5icm93c2VyLmZpcnN0cnVuLkZpcnN0UnVuQWN0aXZpdHlcIikge1xuICAgICAgICAgICAgbG9nLmluZm8oXCJDaHJvbWUgd2VsY29tZSBkaWFsb2cgbmV2ZXIgc2hvd2VkIHVwISBDb250aW51aW5nXCIpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGxldCBlbCA9IGF3YWl0IHRoaXMuZmluZEVsT3JFbHMoJ2lkJywgJ2NvbS5hbmRyb2lkLmNocm9tZTppZC90ZXJtc19hY2NlcHQnLCBmYWxzZSk7XG4gICAgICAgIGF3YWl0IHRoaXMuY2xpY2soZWwuRUxFTUVOVCk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBsZXQgZWwgPSBhd2FpdCB0aGlzLmZpbmRFbE9yRWxzKCdpZCcsICdjb20uYW5kcm9pZC5jaHJvbWU6aWQvbmVnYXRpdmVfYnV0dG9uJywgZmFsc2UpO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5jbGljayhlbC5FTEVNRU5UKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgLy8gRE8gTk9USElORywgVEhJUyBERVZJQ0UgRElETlQgTEFVTkNIIFRIRSBTSUdOSU4gRElBTE9HXG4gICAgICAgICAgICAvLyBJVCBNVVNUIEJFIEEgTk9OIEdNUyBERVZJQ0VcbiAgICAgICAgICAgIGxvZy53YXJuKGBUaGlzIGRldmljZSBkaWRudCBzaG93IENocm9tZSBTaWduSW4gZGlhbG9nLCAke2UubWVzc2FnZX1gKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGluaXRBdXRvV2VidmlldygpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0cy5hdXRvV2Vidmlldykge1xuICAgICAgICAgICAgbGV0IHZpZXdOYW1lID0gdGhpcy5kZWZhdWx0V2Vidmlld05hbWUoKTtcbiAgICAgICAgICAgIGxldCB0aW1lb3V0ID0gKHRoaXMub3B0cy5hdXRvV2Vidmlld1RpbWVvdXQpIHx8IDIwMDA7XG5cbiAgICAgICAgICAgIGxvZy5pbmZvKGBTZXR0aW5nIGF1dG8gd2VidmlldyB0byBjb250ZXh0ICcke3ZpZXdOYW1lfScgd2l0aCB0aW1lb3V0ICR7dGltZW91dH1tc2ApO1xuXG4gICAgICAgICAgICAvLyB0cnkgZXZlcnkgNTAwbXMgdW50aWwgdGltZW91dCBpcyBvdmVyXG4gICAgICAgICAgICBhd2FpdCByZXRyeUludGVydmFsKHRpbWVvdXQgLyA1MDAsIDUwMCwgYXN5bmMoKSA9PiB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5zZXRDb250ZXh0KHZpZXdOYW1lKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgaW5pdEFVVCgpIHtcbiAgICAgICAgLy8gcG9wdWxhdGUgYXBwUGFja2FnZSwgYXBwQWN0aXZpdHksIGFwcFdhaXRQYWNrYWdlLCBhcHBXYWl0QWN0aXZpdHksXG4gICAgICAgIC8vIGFuZCB0aGUgZGV2aWNlIGJlaW5nIHVzZWRcbiAgICAgICAgLy8gaW4gdGhlIG9wdHMgYW5kIGNhcHMgKHNvIGl0IGdldHMgYmFjayB0byB0aGUgdXNlciBvbiBzZXNzaW9uIGNyZWF0aW9uKVxuICAgICAgICBsZXQgbGF1bmNoSW5mbyA9IGF3YWl0IGhlbHBlcnMuZ2V0TGF1bmNoSW5mbyh0aGlzLmFkYiwgdGhpcy5vcHRzKTtcbiAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLm9wdHMsIGxhdW5jaEluZm8pO1xuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMuY2FwcywgbGF1bmNoSW5mbyk7XG4gICAgICAgIC8vIGluc3RhbGwgYXBwXG4gICAgICAgIGlmICghdGhpcy5vcHRzLmFwcCkge1xuICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5mdWxsUmVzZXQpIHtcbiAgICAgICAgICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdygnRnVsbCByZXNldCByZXF1aXJlcyBhbiBhcHAgY2FwYWJpbGl0eSwgdXNlIGZhc3RSZXNldCBpZiBhcHAgaXMgbm90IHByb3ZpZGVkJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsb2cuZGVidWcoJ05vIGFwcCBjYXBhYmlsaXR5LiBBc3N1bWluZyBpdCBpcyBhbHJlYWR5IG9uIHRoZSBkZXZpY2UnKTtcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMuZmFzdFJlc2V0KSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgaGVscGVycy5yZXNldEFwcCh0aGlzLmFkYiwgdGhpcy5vcHRzLmFwcCwgdGhpcy5vcHRzLmFwcFBhY2thZ2UsIHRoaXMub3B0cy5mYXN0UmVzZXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5ncmFudFBlcm1pc3Npb25zKCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLm9wdHMuc2tpcFVuaW5zdGFsbCkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5hZGIudW5pbnN0YWxsQXBrKHRoaXMub3B0cy5hcHBQYWNrYWdlKTtcbiAgICAgICAgfVxuICAgICAgICBhd2FpdCBoZWxwZXJzLmluc3RhbGxBcGtSZW1vdGVseSh0aGlzLmFkYiwgdGhpcy5vcHRzKTtcbiAgICAgICAgYXdhaXQgdGhpcy5ncmFudFBlcm1pc3Npb25zKCk7XG4gICAgICAgIHRoaXMuYXBrU3RyaW5nc1t0aGlzLm9wdHMubGFuZ3VhZ2VdID0gYXdhaXQgaGVscGVycy5wdXNoU3RyaW5ncyhcbiAgICAgICAgICAgIHRoaXMub3B0cy5sYW5ndWFnZSwgdGhpcy5hZGIsIHRoaXMub3B0cyk7XG4gICAgfVxuXG4gICAgYXN5bmMgc3RhcnRDaHJvbWVTZXNzaW9uKCkge1xuICAgICAgICBsb2cuaW5mbyhcIlN0YXJ0aW5nIGEgY2hyb21lLWJhc2VkIGJyb3dzZXIgc2Vzc2lvblwiKTtcbiAgICAgICAgbGV0IG9wdHMgPSBfLmNsb25lRGVlcCh0aGlzLm9wdHMpO1xuICAgICAgICBvcHRzLmNocm9tZVVzZVJ1bm5pbmdBcHAgPSBmYWxzZTtcblxuICAgICAgICBjb25zdCBrbm93blBhY2thZ2VzID0gW1wib3JnLmNocm9taXVtLmNocm9tZS5zaGVsbFwiLFxuICAgICAgICAgICAgXCJjb20uYW5kcm9pZC5jaHJvbWVcIixcbiAgICAgICAgICAgIFwiY29tLmNocm9tZS5iZXRhXCIsXG4gICAgICAgICAgICBcIm9yZy5jaHJvbWl1bS5jaHJvbWVcIixcbiAgICAgICAgICAgIFwib3JnLmNocm9taXVtLndlYnZpZXdfc2hlbGxcIl07XG5cbiAgICAgICAgaWYgKCFfLmNvbnRhaW5zKGtub3duUGFja2FnZXMsIHRoaXMub3B0cy5hcHBQYWNrYWdlKSkge1xuICAgICAgICAgICAgb3B0cy5jaHJvbWVBbmRyb2lkQWN0aXZpdHkgPSB0aGlzLm9wdHMuYXBwQWN0aXZpdHk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jaHJvbWVkcml2ZXIgPSBhd2FpdCBzZXR1cE5ld0Nocm9tZWRyaXZlcihvcHRzLCB0aGlzLmFkYi5jdXJEZXZpY2VJZCxcbiAgICAgICAgICAgIHRoaXMuYWRiKTtcbiAgICAgICAgdGhpcy5jaHJvbWVkcml2ZXIub24oQ2hyb21lZHJpdmVyLkVWRU5UX0NIQU5HRUQsIChtc2cpID0+IHtcbiAgICAgICAgICAgIGlmIChtc2cuc3RhdGUgPT09IENocm9tZWRyaXZlci5TVEFURV9TVE9QUEVEKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vbkNocm9tZWRyaXZlclN0b3AoQ0hST01JVU1fV0lOKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gTm93IHRoYXQgd2UgaGF2ZSBhIENocm9tZSBzZXNzaW9uLCB3ZSBlbnN1cmUgdGhhdCB0aGUgY29udGV4dCBpc1xuICAgICAgICAvLyBhcHByb3ByaWF0ZWx5IHNldCBhbmQgdGhhdCB0aGlzIGNocm9tZWRyaXZlciBpcyBhZGRlZCB0byB0aGUgbGlzdFxuICAgICAgICAvLyBvZiBzZXNzaW9uIGNocm9tZWRyaXZlcnMgc28gd2UgY2FuIHN3aXRjaCBiYWNrIGFuZCBmb3J0aFxuICAgICAgICB0aGlzLmN1ckNvbnRleHQgPSBDSFJPTUlVTV9XSU47XG4gICAgICAgIHRoaXMuc2Vzc2lvbkNocm9tZWRyaXZlcnNbQ0hST01JVU1fV0lOXSA9IHRoaXMuY2hyb21lZHJpdmVyO1xuICAgICAgICB0aGlzLnByb3h5UmVxUmVzID0gdGhpcy5jaHJvbWVkcml2ZXIucHJveHlSZXEuYmluZCh0aGlzLmNocm9tZWRyaXZlcik7XG4gICAgICAgIHRoaXMuandwUHJveHlBY3RpdmUgPSB0cnVlO1xuICAgIH1cblxuICAgIGFzeW5jIGNoZWNrQXBwUHJlc2VudCgpIHtcbiAgICAgICAgbG9nLmRlYnVnKFwiQ2hlY2tpbmcgd2hldGhlciBhcHAgaXMgYWN0dWFsbHkgcHJlc2VudFwiKTtcbiAgICAgICAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKHRoaXMub3B0cy5hcHApKSkge1xuICAgICAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coYENvdWxkIG5vdCBmaW5kIGFwcCBhcGsgYXQgJHt0aGlzLm9wdHMuYXBwfWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgY2hlY2tQYWNrYWdlUHJlc2VudCgpIHtcbiAgICAgICAgbG9nLmRlYnVnKFwiQ2hlY2tpbmcgd2hldGhlciBwYWNrYWdlIGlzIHByZXNlbnQgb24gdGhlIGRldmljZVwiKTtcbiAgICAgICAgaWYgKCEoYXdhaXQgdGhpcy5hZGIuc2hlbGwoWydwbScsICdsaXN0JywgJ3BhY2thZ2VzJywgdGhpcy5vcHRzLmFwcFBhY2thZ2VdKSkpIHtcbiAgICAgICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBDb3VsZCBub3QgZmluZCBwYWNrYWdlICR7dGhpcy5vcHRzLmFwcFBhY2thZ2V9IG9uIHRoZSBkZXZpY2VgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGdyYW50UGVybWlzc2lvbnMoKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdHMuYXV0b0dyYW50UGVybWlzc2lvbnMpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5hZGIuZ3JhbnRBbGxQZXJtaXNzaW9ucyh0aGlzLm9wdHMuYXBwUGFja2FnZSwgdGhpcy5vcHRzLmFwcCk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGxvZy5lcnJvcihgVW5hYmxlIHRvIGdyYW50IHBlcm1pc3Npb25zIHJlcXVlc3RlZC4gT3JpZ2luYWwgZXJyb3I6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIFNldCBDb21wcmVzc2VkTGF5b3V0SGllcmFyY2h5IG9uIHRoZSBkZXZpY2VcbiAgICBhc3luYyBzZXRDb21wcmVzc2VkTGF5b3V0SGllcmFyY2h5KGNvbXByZXNzKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYm9vdHN0cmFwLnNlbmRBY3Rpb24oXCJjb21wcmVzc2VkTGF5b3V0SGllcmFyY2h5XCIsIHtjb21wcmVzc0xheW91dDogY29tcHJlc3N9KTtcbiAgICB9XG5cbiAgICBhc3luYyBkZWxldGVTZXNzaW9uKCkge1xuICAgICAgICBsb2cuZGVidWcoXCJTaHV0dGluZyBkb3duIEFuZHJvaWQgZHJpdmVyXCIpO1xuICAgICAgICBhd2FpdCBzdXBlci5kZWxldGVTZXNzaW9uKCk7XG4gICAgICAgIGlmICh0aGlzLmJvb3RzdHJhcCkge1xuICAgICAgICAgICAgLy8gY2VydGFpbiBjbGVhbnVwIHdlIG9ubHkgY2FyZSB0byBkbyBpZiB0aGUgYm9vdHN0cmFwIHdhcyBldmVyIHJ1blxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdG9wQ2hyb21lZHJpdmVyUHJveGllcygpO1xuICAgICAgICAgICAgaWYgKHRoaXMub3B0cy51bmljb2RlS2V5Ym9hcmQgJiYgdGhpcy5vcHRzLnJlc2V0S2V5Ym9hcmQgJiYgdGhpcy5kZWZhdWx0SU1FKSB7XG4gICAgICAgICAgICAgICAgbG9nLmRlYnVnKGBSZXNldHRpbmcgSU1FIHRvICR7dGhpcy5kZWZhdWx0SU1FfWApO1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuYWRiLnNldElNRSh0aGlzLmRlZmF1bHRJTUUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8g6KaB5YWI5YWz6ZetYm9vdHN0cmFwXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmJvb3RzdHJhcC5zaHV0ZG93bigpO1xuICAgICAgICAgICAgdGhpcy5ib290c3RyYXAgPSBudWxsO1xuICAgICAgICAgICAgaWYgKCF0aGlzLmlzQ2hyb21lU2Vzc2lvbikge1xuICAgICAgICAgICAgICAgIC8vIHRlc3RidW5kbGXlhbPmjonlkI7vvIzlupTnlKjkuZ/kvJrlhbPpl61cbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnRlc3RidW5kbGUuc2h1dGRvd24oKVxuICAgICAgICAgICAgICAgIHRoaXMudGVzdGJ1bmRsZSA9IG51bGxcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmFkYi5mb3JjZVN0b3AodGhpcy5vcHRzLmFwcFBhY2thZ2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5hZGIuZ29Ub0hvbWUoKTtcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMuZnVsbFJlc2V0ICYmICF0aGlzLm9wdHMuc2tpcFVuaW5zdGFsbCAmJiAhdGhpcy5hcHBPbkRldmljZSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuYWRiLnVuaW5zdGFsbEFwayh0aGlzLm9wdHMuYXBwUGFja2FnZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhcIkNhbGxlZCBkZWxldGVTZXNzaW9uIGJ1dCBib290c3RyYXAgd2Fzbid0IGFjdGl2ZVwiKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBzb21lIGNsZWFudXAgd2Ugd2FudCB0byBkbyByZWdhcmRsZXNzLCBpbiBjYXNlIHdlIGFyZSBzaHV0dGluZyBkb3duXG4gICAgICAgIC8vIG1pZC1zdGFydHVwXG4gICAgICAgIGlmICh0aGlzLm9wdHMuc3RhcnRMb2djYXQpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuYWRiLnN0b3BMb2djYXQoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy51c2VVbmxvY2tIZWxwZXJBcHApIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuYWRiLmZvcmNlU3RvcCgnaW8uYXBwaXVtLnVubG9jaycpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLm9wdHMucmVib290KSB7XG4gICAgICAgICAgICBsZXQgYXZkTmFtZSA9IHRoaXMub3B0cy5hdmQucmVwbGFjZSgnQCcsICcnKTtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhgY2xvc2luZyBlbXVsYXRvciAnJHthdmROYW1lfSdgKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuYWRiLmtpbGxFbXVsYXRvcihhdmROYW1lKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5vcHRzLmNsZWFyU3lzdGVtRmlsZXMpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMuYXBwSXNUZW1wKSB7XG4gICAgICAgICAgICAgICAgbG9nLmRlYnVnKGBUZW1wb3JhcnkgY29weSBvZiBhcHAgd2FzIG1hZGU6IGRlbGV0aW5nICcke3RoaXMub3B0cy5hcHB9J2ApO1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGZzLnJpbXJhZih0aGlzLm9wdHMuYXBwKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgbG9nLndhcm4oYFVuYWJsZSB0byBkZWxldGUgdGVtcG9yYXJ5IGFwcDogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygnQXBwIHdhcyBub3QgY29waWVkLCBzbyBub3QgZGVsZXRpbmcnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZygnTm90IGNsZWFuaW5nIGdlbmVyYXRlZCBmaWxlcy4gQWRkIGBjbGVhclN5c3RlbUZpbGVzYCBjYXBhYmlsaXR5IGlmIHdhbnRlZC4nKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHZhbGlkYXRlRGVzaXJlZENhcHMoY2Fwcykge1xuICAgICAgICAvLyBjaGVjayB3aXRoIHRoZSBiYXNlIGNsYXNzLCBhbmQgcmV0dXJuIGlmIGl0IGZhaWxzXG4gICAgICAgIGxldCByZXMgPSBzdXBlci52YWxpZGF0ZURlc2lyZWRDYXBzKGNhcHMpO1xuICAgICAgICBpZiAoIXJlcykgcmV0dXJuIHJlczsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuXG4gICAgICAgIC8vIG1ha2Ugc3VyZSB0aGF0IHRoZSBjYXBhYmlsaXRpZXMgaGF2ZSBvbmUgb2YgYGFwcGAsIGBhcHBQYWNrYWdlYCBvciBgYnJvd3NlcmBcbiAgICAgICAgaWYgKCghY2Fwcy5icm93c2VyTmFtZSB8fCAhaGVscGVycy5pc0Nocm9tZUJyb3dzZXIoY2Fwcy5icm93c2VyTmFtZSkpICYmICFjYXBzLmFwcCAmJiAhY2Fwcy5hcHBQYWNrYWdlKSB7XG4gICAgICAgICAgICBsZXQgbXNnID0gJ1RoZSBkZXNpcmVkIGNhcGFiaWxpdGllcyBtdXN0IGluY2x1ZGUgZWl0aGVyIGFuIGFwcCwgYXBwUGFja2FnZSBvciBicm93c2VyTmFtZSc7XG4gICAgICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICAgICAgICB9XG4gICAgICAgIC8vIHdhcm4gaWYgdGhlIGNhcGFiaWxpdGllcyBoYXZlIGJvdGggYGFwcGAgYW5kIGBicm93c2VyLCBhbHRob3VnaCB0aGlzXG4gICAgICAgIC8vIGlzIGNvbW1vbiB3aXRoIHNlbGVuaXVtIGdyaWRcbiAgICAgICAgaWYgKGNhcHMuYnJvd3Nlck5hbWUgJiYgY2Fwcy5hcHApIHtcbiAgICAgICAgICAgIGxldCBtc2cgPSAnVGhlIGRlc2lyZWQgY2FwYWJpbGl0aWVzIHNob3VsZCBnZW5lcmFsbHkgbm90IGluY2x1ZGUgYm90aCBhbiBhcHAgYW5kIGEgYnJvd3Nlck5hbWUnO1xuICAgICAgICAgICAgbG9nLndhcm4obXNnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3h5QWN0aXZlKHNlc3Npb25JZCkge1xuICAgICAgICBzdXBlci5wcm94eUFjdGl2ZShzZXNzaW9uSWQpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmp3cFByb3h5QWN0aXZlO1xuICAgIH1cblxuICAgIGdldFByb3h5QXZvaWRMaXN0KHNlc3Npb25JZCkge1xuICAgICAgICBzdXBlci5nZXRQcm94eUF2b2lkTGlzdChzZXNzaW9uSWQpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmp3cFByb3h5QXZvaWQ7XG4gICAgfVxuXG4gICAgY2FuUHJveHkoc2Vzc2lvbklkKSB7XG4gICAgICAgIHN1cGVyLmNhblByb3h5KHNlc3Npb25JZCk7XG5cbiAgICAgICAgLy8gdGhpcyB3aWxsIGNoYW5nZSBkZXBlbmRpbmcgb24gQ2hyb21lRHJpdmVyIHN0YXR1c1xuICAgICAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKHRoaXMucHJveHlSZXFSZXMpO1xuICAgIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQW5kcm9pZERyaXZlcjtcbiJdLCJzb3VyY2VSb290IjoiLi5cXC4uIn0=
