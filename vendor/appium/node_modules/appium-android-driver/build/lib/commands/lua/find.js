'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
    value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumBaseDriver = require('appium-base-driver');

var commands = {};

/**
 *
 * 查找lua元素  2017/4/24
 *
 */
commands.findLuaElement = function callee$0$0(strategy, selector) {
    var result;
    return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
        while (1) switch (context$1$0.prev = context$1$0.next) {
            case 0:
                context$1$0.next = 2;
                return _regeneratorRuntime.awrap(this.findLuaElOrEls(strategy, selector, false));

            case 2:
                result = context$1$0.sent;

                result.IS_LUA = true;
                return context$1$0.abrupt('return', result);

            case 5:
            case 'end':
                return context$1$0.stop();
        }
    }, null, this);
};

commands.findLuaElements = function callee$0$0(strategy, selector) {
    var result;
    return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
        while (1) switch (context$1$0.prev = context$1$0.next) {
            case 0:
                context$1$0.next = 2;
                return _regeneratorRuntime.awrap(this.findLuaElOrEls(strategy, selector, true));

            case 2:
                result = context$1$0.sent;

                result.forEach(function (element) {
                    element.IS_LUA = true;
                });
                return context$1$0.abrupt('return', result);

            case 5:
            case 'end':
                return context$1$0.stop();
        }
    }, null, this);
};

commands.doFindLuaElementOrEls = function callee$0$0(params) {
    return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
        while (1) switch (context$1$0.prev = context$1$0.next) {
            case 0:
                context$1$0.next = 2;
                return _regeneratorRuntime.awrap(this.testbundle.sendAction('find', params));

            case 2:
                return context$1$0.abrupt('return', context$1$0.sent);

            case 3:
            case 'end':
                return context$1$0.stop();
        }
    }, null, this);
};

commands.findLuaElOrEls = function callee$0$0(strategy, selector, mult) {
    var context = arguments.length <= 3 || arguments[3] === undefined ? '' : arguments[3];
    var params, element, doFind;
    return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
        var _this = this;

        while (1) switch (context$1$0.prev = context$1$0.next) {
            case 0:
                this.validateLocatorStrategy(strategy);

                if (selector) {
                    context$1$0.next = 3;
                    break;
                }

                throw new Error("Must provide a selector when finding elements");

            case 3:
                params = {
                    strategy: strategy,
                    selector: selector,
                    context: context,
                    multiple: mult
                };
                element = undefined;

                doFind = function doFind() {
                    return _regeneratorRuntime.async(function doFind$(context$2$0) {
                        while (1) switch (context$2$0.prev = context$2$0.next) {
                            case 0:
                                context$2$0.prev = 0;
                                context$2$0.next = 3;
                                return _regeneratorRuntime.awrap(this.doFindLuaElementOrEls(params));

                            case 3:
                                element = context$2$0.sent;
                                context$2$0.next = 11;
                                break;

                            case 6:
                                context$2$0.prev = 6;
                                context$2$0.t0 = context$2$0['catch'](0);

                                if (!(context$2$0.t0.message && context$2$0.t0.message.match(/An element could not be located/))) {
                                    context$2$0.next = 10;
                                    break;
                                }

                                return context$2$0.abrupt('return', false);

                            case 10:
                                throw context$2$0.t0;

                            case 11:
                                if (!params.multiple) {
                                    context$2$0.next = 15;
                                    break;
                                }

                                return context$2$0.abrupt('return', element && element.length !== 0);

                            case 15:
                                return context$2$0.abrupt('return', !_lodash2['default'].isNull(element));

                            case 16:
                            case 'end':
                                return context$2$0.stop();
                        }
                    }, null, _this, [[0, 6]]);
                };

                context$1$0.prev = 6;
                context$1$0.next = 9;
                return _regeneratorRuntime.awrap(this.implicitWaitForCondition(doFind));

            case 9:
                context$1$0.next = 18;
                break;

            case 11:
                context$1$0.prev = 11;
                context$1$0.t0 = context$1$0['catch'](6);

                if (!(context$1$0.t0.message && context$1$0.t0.message.match(/Condition unmet/))) {
                    context$1$0.next = 17;
                    break;
                }

                // only get here if we are looking for multiple elements
                // condition was not met setting res to empty array
                element = [];
                context$1$0.next = 18;
                break;

            case 17:
                throw context$1$0.t0;

            case 18:
                if (!mult) {
                    context$1$0.next = 22;
                    break;
                }

                return context$1$0.abrupt('return', element);

            case 22:
                if (!(!element || _lodash2['default'].size(element) === 0)) {
                    context$1$0.next = 24;
                    break;
                }

                throw new _appiumBaseDriver.errors.NoSuchElementError();

            case 24:
                return context$1$0.abrupt('return', element);

            case 25:
            case 'end':
                return context$1$0.stop();
        }
    }, null, this, [[6, 11]]);
};

exports['default'] = commands;
module.exports = exports['default'];

// we are fine with this, just indicate a retry

// we want to return false if we want to potentially try again
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9sdWEvZmluZC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O3NCQUFjLFFBQVE7Ozs7Z0NBQ0Msb0JBQW9COztBQUczQyxJQUFJLFFBQVEsR0FBRyxFQUFFLENBQUM7Ozs7Ozs7QUFRbEIsUUFBUSxDQUFDLGNBQWMsR0FBRyxvQkFBZ0IsUUFBUSxFQUFFLFFBQVE7UUFDcEQsTUFBTTs7Ozs7aURBQVMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLEtBQUssQ0FBQzs7O0FBQTdELHNCQUFNOztBQUNWLHNCQUFNLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQTtvREFDYixNQUFNOzs7Ozs7O0NBQ2hCLENBQUM7O0FBRUYsUUFBUSxDQUFDLGVBQWUsR0FBRyxvQkFBZ0IsUUFBUSxFQUFFLFFBQVE7UUFFckQsTUFBTTs7Ozs7aURBQVMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQzs7O0FBQTVELHNCQUFNOztBQUNWLHNCQUFNLENBQUMsT0FBTyxDQUFDLFVBQVUsT0FBTyxFQUFFO0FBQzlCLDJCQUFPLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQTtpQkFDeEIsQ0FBQyxDQUFBO29EQUNLLE1BQU07Ozs7Ozs7Q0FDaEIsQ0FBQzs7QUFFRixRQUFRLENBQUMscUJBQXFCLEdBQUcsb0JBQWdCLE1BQU07Ozs7O2lEQUN0QyxJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDOzs7Ozs7Ozs7O0NBQzFELENBQUM7O0FBRUYsUUFBUSxDQUFDLGNBQWMsR0FBRyxvQkFBZ0IsUUFBUSxFQUFFLFFBQVEsRUFBRSxJQUFJO1FBQUUsT0FBTyx5REFBRyxFQUFFO1FBS3hFLE1BQU0sRUFNTixPQUFPLEVBQ1AsTUFBTTs7Ozs7O0FBWFYsb0JBQUksQ0FBQyx1QkFBdUIsQ0FBQyxRQUFRLENBQUMsQ0FBQzs7b0JBQ2xDLFFBQVE7Ozs7O3NCQUNILElBQUksS0FBSyxDQUFDLCtDQUErQyxDQUFDOzs7QUFFaEUsc0JBQU0sR0FBRztBQUNULDRCQUFRLEVBQVIsUUFBUTtBQUNSLDRCQUFRLEVBQVIsUUFBUTtBQUNSLDJCQUFPLEVBQVAsT0FBTztBQUNQLDRCQUFRLEVBQUUsSUFBSTtpQkFDakI7QUFDRyx1QkFBTzs7QUFDUCxzQkFBTSxHQUFHLFNBQVQsTUFBTTs7Ozs7O2lFQUVjLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxNQUFNLENBQUM7OztBQUFsRCx1Q0FBTzs7Ozs7Ozs7c0NBRUgsZUFBSSxPQUFPLElBQUksZUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUE7Ozs7O29FQUU1RCxLQUFLOzs7Ozs7cUNBS2hCLE1BQU0sQ0FBQyxRQUFROzs7OztvRUFDUixPQUFPLElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDOzs7b0VBRS9CLENBQUMsb0JBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQzs7Ozs7OztpQkFFaEM7Ozs7aURBR1MsSUFBSSxDQUFDLHdCQUF3QixDQUFDLE1BQU0sQ0FBQzs7Ozs7Ozs7OztzQkFFdkMsZUFBSSxPQUFPLElBQUksZUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUE7Ozs7Ozs7QUFHbkQsdUJBQU8sR0FBRyxFQUFFLENBQUM7Ozs7Ozs7O3FCQU1qQixJQUFJOzs7OztvREFDRyxPQUFPOzs7c0JBRVYsQ0FBQyxPQUFPLElBQUksb0JBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQTs7Ozs7c0JBQzNCLElBQUkseUJBQU8sa0JBQWtCLEVBQUU7OztvREFFbEMsT0FBTzs7Ozs7OztDQUVyQixDQUFDOztxQkFJYSxRQUFRIiwiZmlsZSI6ImxpYi9jb21tYW5kcy9sdWEvZmluZC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XHJcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XHJcblxyXG5cclxubGV0IGNvbW1hbmRzID0ge307XHJcblxyXG5cclxuLyoqXHJcbiAqXHJcbiAqIOafpeaJvmx1YeWFg+e0oCAgMjAxNy80LzI0XHJcbiAqXHJcbiAqL1xyXG5jb21tYW5kcy5maW5kTHVhRWxlbWVudCA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgc2VsZWN0b3IpIHtcclxuICAgIGxldCByZXN1bHQgPSBhd2FpdCB0aGlzLmZpbmRMdWFFbE9yRWxzKHN0cmF0ZWd5LCBzZWxlY3RvciwgZmFsc2UpXHJcbiAgICByZXN1bHQuSVNfTFVBID0gdHJ1ZVxyXG4gICAgcmV0dXJuIHJlc3VsdFxyXG59O1xyXG5cclxuY29tbWFuZHMuZmluZEx1YUVsZW1lbnRzID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCBzZWxlY3Rvcikge1xyXG5cclxuICAgIGxldCByZXN1bHQgPSBhd2FpdCB0aGlzLmZpbmRMdWFFbE9yRWxzKHN0cmF0ZWd5LCBzZWxlY3RvciwgdHJ1ZSk7XHJcbiAgICByZXN1bHQuZm9yRWFjaChmdW5jdGlvbiAoZWxlbWVudCkge1xyXG4gICAgICAgIGVsZW1lbnQuSVNfTFVBID0gdHJ1ZVxyXG4gICAgfSlcclxuICAgIHJldHVybiByZXN1bHRcclxufTtcclxuXHJcbmNvbW1hbmRzLmRvRmluZEx1YUVsZW1lbnRPckVscyA9IGFzeW5jIGZ1bmN0aW9uIChwYXJhbXMpIHtcclxuICAgIHJldHVybiBhd2FpdCB0aGlzLnRlc3RidW5kbGUuc2VuZEFjdGlvbignZmluZCcsIHBhcmFtcylcclxufTtcclxuXHJcbmNvbW1hbmRzLmZpbmRMdWFFbE9yRWxzID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCA9ICcnKSB7XHJcbiAgICB0aGlzLnZhbGlkYXRlTG9jYXRvclN0cmF0ZWd5KHN0cmF0ZWd5KTtcclxuICAgIGlmICghc2VsZWN0b3IpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJNdXN0IHByb3ZpZGUgYSBzZWxlY3RvciB3aGVuIGZpbmRpbmcgZWxlbWVudHNcIik7XHJcbiAgICB9XHJcbiAgICBsZXQgcGFyYW1zID0ge1xyXG4gICAgICAgIHN0cmF0ZWd5LFxyXG4gICAgICAgIHNlbGVjdG9yLFxyXG4gICAgICAgIGNvbnRleHQsXHJcbiAgICAgICAgbXVsdGlwbGU6IG11bHRcclxuICAgIH07XHJcbiAgICBsZXQgZWxlbWVudDtcclxuICAgIGxldCBkb0ZpbmQgPSBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgZWxlbWVudCA9IGF3YWl0IHRoaXMuZG9GaW5kTHVhRWxlbWVudE9yRWxzKHBhcmFtcyk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICAgIGlmIChlcnIubWVzc2FnZSAmJiBlcnIubWVzc2FnZS5tYXRjaCgvQW4gZWxlbWVudCBjb3VsZCBub3QgYmUgbG9jYXRlZC8pKSB7XHJcbiAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgZmluZSB3aXRoIHRoaXMsIGp1c3QgaW5kaWNhdGUgYSByZXRyeVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRocm93IGVycjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gd2Ugd2FudCB0byByZXR1cm4gZmFsc2UgaWYgd2Ugd2FudCB0byBwb3RlbnRpYWxseSB0cnkgYWdhaW5cclxuICAgICAgICBpZiAocGFyYW1zLm11bHRpcGxlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBlbGVtZW50ICYmIGVsZW1lbnQubGVuZ3RoICE9PSAwO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiAhXy5pc051bGwoZWxlbWVudCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAgIGF3YWl0IHRoaXMuaW1wbGljaXRXYWl0Rm9yQ29uZGl0aW9uKGRvRmluZCk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICBpZiAoZXJyLm1lc3NhZ2UgJiYgZXJyLm1lc3NhZ2UubWF0Y2goL0NvbmRpdGlvbiB1bm1ldC8pKSB7XHJcbiAgICAgICAgICAgIC8vIG9ubHkgZ2V0IGhlcmUgaWYgd2UgYXJlIGxvb2tpbmcgZm9yIG11bHRpcGxlIGVsZW1lbnRzXHJcbiAgICAgICAgICAgIC8vIGNvbmRpdGlvbiB3YXMgbm90IG1ldCBzZXR0aW5nIHJlcyB0byBlbXB0eSBhcnJheVxyXG4gICAgICAgICAgICBlbGVtZW50ID0gW107XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhyb3cgZXJyO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAobXVsdCkge1xyXG4gICAgICAgIHJldHVybiBlbGVtZW50O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAoIWVsZW1lbnQgfHwgXy5zaXplKGVsZW1lbnQpID09PSAwKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBlbGVtZW50O1xyXG4gICAgfVxyXG59O1xyXG5cclxuXHJcblxyXG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcclxuIl0sInNvdXJjZVJvb3QiOiIuLlxcLi5cXC4uXFwuLiJ9
