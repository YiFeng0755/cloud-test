'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
    value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumBaseDriver = require('appium-base-driver');

var commands = {};

/**
 *
 * 查找lua元素  2017/4/24
 *
 */
commands.findLuaElement = function callee$0$0(strategy, selector) {
    var result;
    return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
        while (1) switch (context$1$0.prev = context$1$0.next) {
            case 0:
                context$1$0.next = 2;
                return _regeneratorRuntime.awrap(this.findLuaElOrEls(strategy, selector, false));

            case 2:
                result = context$1$0.sent;

                result.IS_LUA = true;
                return context$1$0.abrupt('return', result);

            case 5:
            case 'end':
                return context$1$0.stop();
        }
    }, null, this);
};

commands.findLuaElements = function callee$0$0(strategy, selector) {
    var result;
    return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
        while (1) switch (context$1$0.prev = context$1$0.next) {
            case 0:
                context$1$0.next = 2;
                return _regeneratorRuntime.awrap(this.findLuaElOrEls(strategy, selector, true));

            case 2:
                result = context$1$0.sent;

                result.forEach(function (element) {
                    element.IS_LUA = true;
                });
                return context$1$0.abrupt('return', result);

            case 5:
            case 'end':
                return context$1$0.stop();
        }
    }, null, this);
};

commands.doFindLuaElementOrEls = function callee$0$0(params) {
    return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
        while (1) switch (context$1$0.prev = context$1$0.next) {
            case 0:
                context$1$0.next = 2;
                return _regeneratorRuntime.awrap(this.testbundle.sendAction('find', params));

            case 2:
                return context$1$0.abrupt('return', context$1$0.sent);

            case 3:
            case 'end':
                return context$1$0.stop();
        }
    }, null, this);
};

commands.findLuaElOrEls = function callee$0$0(strategy, selector, mult) {
    var context = arguments.length <= 3 || arguments[3] === undefined ? '' : arguments[3];
    var params, element, doFind;
    return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
        var _this = this;

        while (1) switch (context$1$0.prev = context$1$0.next) {
            case 0:
                this.validateLocatorStrategy(strategy);

                if (selector) {
                    context$1$0.next = 3;
                    break;
                }

                throw new Error("Must provide a selector when finding elements");

            case 3:
                params = {
                    strategy: strategy,
                    selector: selector,
                    context: context,
                    multiple: mult
                };
                element = undefined;

                doFind = function doFind() {
                    return _regeneratorRuntime.async(function doFind$(context$2$0) {
                        while (1) switch (context$2$0.prev = context$2$0.next) {
                            case 0:
                                context$2$0.prev = 0;
                                context$2$0.next = 3;
                                return _regeneratorRuntime.awrap(this.doFindLuaElementOrEls(params));

                            case 3:
                                element = context$2$0.sent;
                                context$2$0.next = 11;
                                break;

                            case 6:
                                context$2$0.prev = 6;
                                context$2$0.t0 = context$2$0['catch'](0);

                                if (!(context$2$0.t0.message && context$2$0.t0.message.match(/An element could not be located/))) {
                                    context$2$0.next = 10;
                                    break;
                                }

                                return context$2$0.abrupt('return', false);

                            case 10:
                                throw context$2$0.t0;

                            case 11:
                                if (!params.multiple) {
                                    context$2$0.next = 15;
                                    break;
                                }

                                return context$2$0.abrupt('return', element && element.length !== 0);

                            case 15:
                                return context$2$0.abrupt('return', !_lodash2['default'].isNull(element));

                            case 16:
                            case 'end':
                                return context$2$0.stop();
                        }
                    }, null, _this, [[0, 6]]);
                };

                context$1$0.prev = 6;
                context$1$0.next = 9;
                return _regeneratorRuntime.awrap(this.implicitWaitForCondition(doFind));

            case 9:
                context$1$0.next = 18;
                break;

            case 11:
                context$1$0.prev = 11;
                context$1$0.t0 = context$1$0['catch'](6);

                if (!(context$1$0.t0.message && context$1$0.t0.message.match(/Condition unmet/))) {
                    context$1$0.next = 17;
                    break;
                }

                // only get here if we are looking for multiple elements
                // condition was not met setting res to empty array
                element = [];
                context$1$0.next = 18;
                break;

            case 17:
                throw context$1$0.t0;

            case 18:
                if (!mult) {
                    context$1$0.next = 22;
                    break;
                }

                return context$1$0.abrupt('return', element);

            case 22:
                if (!(!element || _lodash2['default'].size(element) === 0)) {
                    context$1$0.next = 24;
                    break;
                }

                throw new _appiumBaseDriver.errors.NoSuchElementError();

            case 24:
                return context$1$0.abrupt('return', element);

            case 25:
            case 'end':
                return context$1$0.stop();
        }
    }, null, this, [[6, 11]]);
};

exports['default'] = commands;
module.exports = exports['default'];

// we are fine with this, just indicate a retry

// we want to return false if we want to potentially try again
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9sdWEvZmluZC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O3NCQUFjLFFBQVE7Ozs7Z0NBQ0Msb0JBQW9COztBQUczQyxJQUFJLFFBQVEsR0FBRyxFQUFFLENBQUM7Ozs7Ozs7QUFRbEIsUUFBUSxDQUFDLGNBQWMsR0FBRyxvQkFBZ0IsUUFBUSxFQUFFLFFBQVE7UUFDcEQsTUFBTTs7Ozs7aURBQVMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLEtBQUssQ0FBQzs7O0FBQTdELHNCQUFNOztBQUNWLHNCQUFNLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQTtvREFDYixNQUFNOzs7Ozs7O0NBQ2hCLENBQUM7O0FBRUYsUUFBUSxDQUFDLGVBQWUsR0FBRyxvQkFBZ0IsUUFBUSxFQUFFLFFBQVE7UUFDckQsTUFBTTs7Ozs7aURBQVMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQzs7O0FBQTVELHNCQUFNOztBQUNWLHNCQUFNLENBQUMsT0FBTyxDQUFDLFVBQVUsT0FBTyxFQUFFO0FBQzlCLDJCQUFPLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQTtpQkFDeEIsQ0FBQyxDQUFBO29EQUNLLE1BQU07Ozs7Ozs7Q0FDaEIsQ0FBQzs7QUFFRixRQUFRLENBQUMscUJBQXFCLEdBQUcsb0JBQWdCLE1BQU07Ozs7O2lEQUN0QyxJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDOzs7Ozs7Ozs7O0NBQzFELENBQUM7O0FBRUYsUUFBUSxDQUFDLGNBQWMsR0FBRyxvQkFBZ0IsUUFBUSxFQUFFLFFBQVEsRUFBRSxJQUFJO1FBQUUsT0FBTyx5REFBRyxFQUFFO1FBS3hFLE1BQU0sRUFNTixPQUFPLEVBQ1AsTUFBTTs7Ozs7O0FBWFYsb0JBQUksQ0FBQyx1QkFBdUIsQ0FBQyxRQUFRLENBQUMsQ0FBQzs7b0JBQ2xDLFFBQVE7Ozs7O3NCQUNILElBQUksS0FBSyxDQUFDLCtDQUErQyxDQUFDOzs7QUFFaEUsc0JBQU0sR0FBRztBQUNULDRCQUFRLEVBQVIsUUFBUTtBQUNSLDRCQUFRLEVBQVIsUUFBUTtBQUNSLDJCQUFPLEVBQVAsT0FBTztBQUNQLDRCQUFRLEVBQUUsSUFBSTtpQkFDakI7QUFDRyx1QkFBTzs7QUFDUCxzQkFBTSxHQUFHLFNBQVQsTUFBTTs7Ozs7O2lFQUVjLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxNQUFNLENBQUM7OztBQUFsRCx1Q0FBTzs7Ozs7Ozs7c0NBRUgsZUFBSSxPQUFPLElBQUksZUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUE7Ozs7O29FQUU1RCxLQUFLOzs7Ozs7cUNBS2hCLE1BQU0sQ0FBQyxRQUFROzs7OztvRUFDUixPQUFPLElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDOzs7b0VBRS9CLENBQUMsb0JBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQzs7Ozs7OztpQkFFaEM7Ozs7aURBR1MsSUFBSSxDQUFDLHdCQUF3QixDQUFDLE1BQU0sQ0FBQzs7Ozs7Ozs7OztzQkFFdkMsZUFBSSxPQUFPLElBQUksZUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUE7Ozs7Ozs7QUFHbkQsdUJBQU8sR0FBRyxFQUFFLENBQUM7Ozs7Ozs7O3FCQU1qQixJQUFJOzs7OztvREFDRyxPQUFPOzs7c0JBRVYsQ0FBQyxPQUFPLElBQUksb0JBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQTs7Ozs7c0JBQzNCLElBQUkseUJBQU8sa0JBQWtCLEVBQUU7OztvREFFbEMsT0FBTzs7Ozs7OztDQUVyQixDQUFDOztxQkFJYSxRQUFRIiwiZmlsZSI6ImxpYi9jb21tYW5kcy9sdWEvZmluZC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XHJcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XHJcblxyXG5cclxubGV0IGNvbW1hbmRzID0ge307XHJcblxyXG5cclxuLyoqXHJcbiAqXHJcbiAqIOafpeaJvmx1YeWFg+e0oCAgMjAxNy80LzI0XHJcbiAqXHJcbiAqL1xyXG5jb21tYW5kcy5maW5kTHVhRWxlbWVudCA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgc2VsZWN0b3IpIHtcclxuICAgIGxldCByZXN1bHQgPSBhd2FpdCB0aGlzLmZpbmRMdWFFbE9yRWxzKHN0cmF0ZWd5LCBzZWxlY3RvciwgZmFsc2UpXHJcbiAgICByZXN1bHQuSVNfTFVBID0gdHJ1ZVxyXG4gICAgcmV0dXJuIHJlc3VsdFxyXG59O1xyXG5cclxuY29tbWFuZHMuZmluZEx1YUVsZW1lbnRzID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCBzZWxlY3Rvcikge1xyXG4gICAgbGV0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZmluZEx1YUVsT3JFbHMoc3RyYXRlZ3ksIHNlbGVjdG9yLCB0cnVlKTtcclxuICAgIHJlc3VsdC5mb3JFYWNoKGZ1bmN0aW9uIChlbGVtZW50KSB7XHJcbiAgICAgICAgZWxlbWVudC5JU19MVUEgPSB0cnVlXHJcbiAgICB9KVxyXG4gICAgcmV0dXJuIHJlc3VsdFxyXG59O1xyXG5cclxuY29tbWFuZHMuZG9GaW5kTHVhRWxlbWVudE9yRWxzID0gYXN5bmMgZnVuY3Rpb24gKHBhcmFtcykge1xyXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudGVzdGJ1bmRsZS5zZW5kQWN0aW9uKCdmaW5kJywgcGFyYW1zKVxyXG59O1xyXG5cclxuY29tbWFuZHMuZmluZEx1YUVsT3JFbHMgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0ID0gJycpIHtcclxuICAgIHRoaXMudmFsaWRhdGVMb2NhdG9yU3RyYXRlZ3koc3RyYXRlZ3kpO1xyXG4gICAgaWYgKCFzZWxlY3Rvcikge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIk11c3QgcHJvdmlkZSBhIHNlbGVjdG9yIHdoZW4gZmluZGluZyBlbGVtZW50c1wiKTtcclxuICAgIH1cclxuICAgIGxldCBwYXJhbXMgPSB7XHJcbiAgICAgICAgc3RyYXRlZ3ksXHJcbiAgICAgICAgc2VsZWN0b3IsXHJcbiAgICAgICAgY29udGV4dCxcclxuICAgICAgICBtdWx0aXBsZTogbXVsdFxyXG4gICAgfTtcclxuICAgIGxldCBlbGVtZW50O1xyXG4gICAgbGV0IGRvRmluZCA9IGFzeW5jICgpID0+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBlbGVtZW50ID0gYXdhaXQgdGhpcy5kb0ZpbmRMdWFFbGVtZW50T3JFbHMocGFyYW1zKTtcclxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgICAgaWYgKGVyci5tZXNzYWdlICYmIGVyci5tZXNzYWdlLm1hdGNoKC9BbiBlbGVtZW50IGNvdWxkIG5vdCBiZSBsb2NhdGVkLykpIHtcclxuICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBmaW5lIHdpdGggdGhpcywganVzdCBpbmRpY2F0ZSBhIHJldHJ5XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhyb3cgZXJyO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyB3ZSB3YW50IHRvIHJldHVybiBmYWxzZSBpZiB3ZSB3YW50IHRvIHBvdGVudGlhbGx5IHRyeSBhZ2FpblxyXG4gICAgICAgIGlmIChwYXJhbXMubXVsdGlwbGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQgJiYgZWxlbWVudC5sZW5ndGggIT09IDA7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuICFfLmlzTnVsbChlbGVtZW50KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5pbXBsaWNpdFdhaXRGb3JDb25kaXRpb24oZG9GaW5kKTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgIGlmIChlcnIubWVzc2FnZSAmJiBlcnIubWVzc2FnZS5tYXRjaCgvQ29uZGl0aW9uIHVubWV0LykpIHtcclxuICAgICAgICAgICAgLy8gb25seSBnZXQgaGVyZSBpZiB3ZSBhcmUgbG9va2luZyBmb3IgbXVsdGlwbGUgZWxlbWVudHNcclxuICAgICAgICAgICAgLy8gY29uZGl0aW9uIHdhcyBub3QgbWV0IHNldHRpbmcgcmVzIHRvIGVtcHR5IGFycmF5XHJcbiAgICAgICAgICAgIGVsZW1lbnQgPSBbXTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aHJvdyBlcnI7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChtdWx0KSB7XHJcbiAgICAgICAgcmV0dXJuIGVsZW1lbnQ7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGlmICghZWxlbWVudCB8fCBfLnNpemUoZWxlbWVudCkgPT09IDApIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGVsZW1lbnQ7XHJcbiAgICB9XHJcbn07XHJcblxyXG5cclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xyXG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uIn0=
