"use strict";

var Q = require('q'),
    Args = require("vargs").Constructor,
    _exec = require('child_process').exec,
    chai = require('chai'),
    readFile = Q.denodeify(require('fs').readFile);

chai.should();

// we don't care about exec errors
var exec = Q.denodeify(function () {
  var args = new Args(arguments);
  _exec.apply(null, args.all.concat([function (err, stdout, stderr) {
    args.callback(null, stdout, stderr);
  }]));
});

// some debug
function print(stdout, stderr) {
  if (process.env.VERBOSE) {
    if ((stdout || '').length) console.log('stdout -->', stdout); // eslint-disable-line no-console
    if ((stderr || '').length > 0) console.log('stderr -->', stderr); // eslint-disable-line no-console
  }
}

describe('transpile-specs', function () {
  this.timeout(10000);

  it('should transpile es7 fixtures', function () {
    return exec('./node_modules/.bin/gulp transpile-es7-fixtures').spread(function (stdout, stderr) {
      print(stdout, stderr);
      stderr.should.eql('');
      stdout.should.include('Finished');
    }).then(function () {
      return readFile('build/lib/a.js', 'utf8');
    }).then(function (content) {
      content.should.have.length.above(0);
      content.should.include('sourceMapping');
    });
  });

  var checkCode = function checkCode(opts) {
    opts = opts || {};
    var gulpOpts = opts.flow ? ' --flow' : '';
    before(function () {
      return exec('./node_modules/.bin/gulp transpile-es7-fixtures' + gulpOpts);
    });

    it('should be able to run transpiled code', function () {
      return exec('node build/lib/run.js').spread(function (stdout, stderr) {
        print(stdout, stderr);
        stderr.should.equal('');
        stdout.should.include('hello world!');
      });
    });

    it('should be able to run transpiled tests', function () {
      return exec('./node_modules/.bin/mocha build/test/a-specs.js').spread(function (stdout, stderr) {
        print(stdout, stderr);
        stderr.should.equal('');
        stdout.should.include('1 passing');
      });
    });

    it('should not detect a rtts-assert error', function () {
      return exec('node build/lib/rtts-assert-error.js').spread(function (stdout, stderr) {
        print(stdout, stderr);
        stderr.should.equal('');
        stdout.should.include('123');
        stdout.should.not.include('Invalid arguments given!');
      });
    });

    it('should use sourcemap when throwing', function () {
      return exec('node build/lib/throw.js').spread(function (stdout, stderr) {
        print(stdout, stderr);
        var output = stdout + stderr;
        output.should.include('This is really bad!');
        output.should.include('.es7.js');
        output.should.include('throw.es7.js:7');
      });
    });

    it('should use sourcemap when throwing within mocha', function () {
      return exec('./node_modules/.bin/mocha build/test/a-throw-specs.js').spread(function (stdout, stderr) {
        print(stdout, stderr);
        var output = stdout + stderr;
        output.should.include('This is really bad!');
        output.should.include('.es7.js');
        output.should.include('a-throw-specs.es7.js:11');
      });
    });

    it('should be able to use gulp-mocha', function () {
      return exec('./node_modules/.bin/gulp test-es7-mocha' + gulpOpts).spread(function (stdout, stderr) {
        print(stdout, stderr);
        stderr.should.eql('');
        stdout.should.include('Finished');
      });
    });

    it('should use sourcemap when throwing within gulp-mocha', function () {
      return exec('./node_modules/.bin/gulp --no-notif test-es7-mocha-throw' + gulpOpts).spread(function (stdout, stderr) {
        print(stdout, stderr);
        var output = stdout + stderr;
        output.should.include('This is really bad!');
        output.should.include('.es7.js');
      });
    });
  };

  describe('check transpiled code', function () {
    checkCode();
  });

  // skip because flow requires extra setup and we might not want to support
  // it at all
  describe.skip('check transpiled code when flow is enabled', function () {
    checkCode({ flow: true });
  });
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdHJhbnNwaWxlLXNwZWNzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7QUFFYixJQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDO0lBQ2hCLElBQUksR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsV0FBVztJQUNuQyxLQUFLLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLElBQUk7SUFDckMsSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7SUFDdEIsUUFBUSxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDOztBQUVuRCxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7OztBQUdkLElBQUksSUFBSSxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsWUFBWTtBQUNqQyxNQUFJLElBQUksR0FBRyxJQUFJLElBQUksQ0FBRSxTQUFTLENBQUMsQ0FBQztBQUNoQyxPQUFLLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFVBQVUsR0FBRyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUU7QUFDaEUsUUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0dBQ3JDLENBQUMsQ0FBQyxDQUFDLENBQUM7Q0FDTixDQUFDLENBQUM7OztBQUdILFNBQVMsS0FBSyxDQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUU7QUFDOUIsTUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRTtBQUN2QixRQUFJLENBQUMsTUFBTSxJQUFJLEVBQUUsQ0FBQSxDQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxNQUFNLENBQUMsQ0FBQztBQUM3RCxRQUFJLENBQUMsTUFBTSxJQUFJLEVBQUUsQ0FBQSxDQUFFLE1BQU0sR0FB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TSxDQUFDLENBQUM7QUFDdEIsY0FBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDdEIsY0FBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7T0FDbkMsQ0FBQyxDQUFDO0tBQ04sQ0FBQyxDQUFDOztBQUVILE1BQUUsQ0FBQyxzREFBc0QsRUFBRSxZQUFZO0FBQ3JFLGFBQU8sSUFBSSxDQUFDLDBEQUEwRCxHQUFHLFFBQVEsQ0FBQyxDQUMvRSxNQUFNLENBQUMsVUFBVSxNQUFNLEVBQUUsTUFBTSxFQUFFO0FBQ2hDLGFBQUssQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDdEIsWUFBSSxNQUFNLEdBQUcsTUFBTSxHQUFHLE1BQU0sQ0FBQztBQUM3QixjQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBQzdDLGNBQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO09BQ2xDLENBQUMsQ0FBQztLQUNOLENBQUMsQ0FBQztHQUNKLENBQUM7O0FBRUYsVUFBUSxDQUFDLHVCQUF1QixFQUFFLFlBQVk7QUFDNUMsYUFBUyxFQUFFLENBQUM7R0FDYixDQUFDLENBQUM7Ozs7QUFJSCxVQUFRLENBQUMsSUFBSSxDQUFDLDRDQUE0QyxFQUFFLFlBQVk7QUFDdEUsYUFBUyxDQUFDLEVBQUMsSUFBSSxFQUFFLElBQUksRUFBQyxDQUFDLENBQUM7R0FDekIsQ0FBQyxDQUFDO0NBRUosQ0FBQyxDQUFDIiwiZmlsZSI6InRlc3QvdHJhbnNwaWxlLXNwZWNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbnZhciBRID0gcmVxdWlyZSgncScpLFxuICAgIEFyZ3MgPSByZXF1aXJlKFwidmFyZ3NcIikuQ29uc3RydWN0b3IsXG4gICAgX2V4ZWMgPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJykuZXhlYyxcbiAgICBjaGFpID0gcmVxdWlyZSgnY2hhaScpLFxuICAgIHJlYWRGaWxlID0gUS5kZW5vZGVpZnkocmVxdWlyZSgnZnMnKS5yZWFkRmlsZSk7XG5cbmNoYWkuc2hvdWxkKCk7XG5cbi8vIHdlIGRvbid0IGNhcmUgYWJvdXQgZXhlYyBlcnJvcnNcbnZhciBleGVjID0gUS5kZW5vZGVpZnkoZnVuY3Rpb24gKCkge1xuICB2YXIgYXJncyA9IG5ldyBBcmdzIChhcmd1bWVudHMpO1xuICBfZXhlYy5hcHBseShudWxsLCBhcmdzLmFsbC5jb25jYXQoW2Z1bmN0aW9uIChlcnIsIHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgYXJncy5jYWxsYmFjayhudWxsLCBzdGRvdXQsIHN0ZGVycik7XG4gIH1dKSk7XG59KTtcblxuLy8gc29tZSBkZWJ1Z1xuZnVuY3Rpb24gcHJpbnQgKHN0ZG91dCwgc3RkZXJyKSB7XG4gIGlmIChwcm9jZXNzLmVudi5WRVJCT1NFKSB7XG4gICAgaWYgKChzdGRvdXQgfHwgJycpLmxlbmd0aCkgY29uc29sZS5sb2coJ3N0ZG91dCAtLT4nLCBzdGRvdXQpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGVcbiAgICBpZiAoKHN0ZGVyciB8fCAnJykubGVuZ3RoID4gMCkgY29uc29sZS5sb2coJ3N0ZGVyciAtLT4nLCBzdGRlcnIpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGVcbiAgfVxufVxuXG5kZXNjcmliZSgndHJhbnNwaWxlLXNwZWNzJywgZnVuY3Rpb24gKCkge1xuICB0aGlzLnRpbWVvdXQoMTAwMDApO1xuXG4gIGl0KCdzaG91bGQgdHJhbnNwaWxlIGVzNyBmaXh0dXJlcycsIGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZXhlYygnLi9ub2RlX21vZHVsZXMvLmJpbi9ndWxwIHRyYW5zcGlsZS1lczctZml4dHVyZXMnKVxuICAgICAgLnNwcmVhZChmdW5jdGlvbiAoc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICAgICAgcHJpbnQoc3Rkb3V0LCBzdGRlcnIpO1xuICAgICAgICBzdGRlcnIuc2hvdWxkLmVxbCgnJyk7XG4gICAgICAgIHN0ZG91dC5zaG91bGQuaW5jbHVkZSgnRmluaXNoZWQnKTtcbiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gcmVhZEZpbGUoJ2J1aWxkL2xpYi9hLmpzJywgJ3V0ZjgnKTtcbiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKGNvbnRlbnQpIHtcbiAgICAgICAgY29udGVudC5zaG91bGQuaGF2ZS5sZW5ndGguYWJvdmUoMCk7XG4gICAgICAgIGNvbnRlbnQuc2hvdWxkLmluY2x1ZGUoJ3NvdXJjZU1hcHBpbmcnKTtcbiAgICAgIH0pO1xuICB9KTtcblxuICB2YXIgY2hlY2tDb2RlID0gZnVuY3Rpb24gKG9wdHMpIHtcbiAgICBvcHRzID0gb3B0cyB8fCB7fTtcbiAgICB2YXIgZ3VscE9wdHMgPSBvcHRzLmZsb3cgPyAnIC0tZmxvdycgOiAnJztcbiAgICBiZWZvcmUoZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIGV4ZWMoJy4vbm9kZV9tb2R1bGVzLy5iaW4vZ3VscCB0cmFuc3BpbGUtZXM3LWZpeHR1cmVzJyArIGd1bHBPcHRzKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgYmUgYWJsZSB0byBydW4gdHJhbnNwaWxlZCBjb2RlJywgZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIGV4ZWMoJ25vZGUgYnVpbGQvbGliL3J1bi5qcycpXG4gICAgICAgIC5zcHJlYWQoZnVuY3Rpb24gKHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgICAgICAgcHJpbnQoc3Rkb3V0LCBzdGRlcnIpO1xuICAgICAgICAgIHN0ZGVyci5zaG91bGQuZXF1YWwoJycpO1xuICAgICAgICAgIHN0ZG91dC5zaG91bGQuaW5jbHVkZSgnaGVsbG8gd29ybGQhJyk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBiZSBhYmxlIHRvIHJ1biB0cmFuc3BpbGVkIHRlc3RzJywgZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIGV4ZWMoJy4vbm9kZV9tb2R1bGVzLy5iaW4vbW9jaGEgYnVpbGQvdGVzdC9hLXNwZWNzLmpzJylcbiAgICAgICAgLnNwcmVhZChmdW5jdGlvbiAoc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICAgICAgICBwcmludChzdGRvdXQsIHN0ZGVycik7XG4gICAgICAgICAgc3RkZXJyLnNob3VsZC5lcXVhbCgnJyk7XG4gICAgICAgICAgc3Rkb3V0LnNob3VsZC5pbmNsdWRlKCcxIHBhc3NpbmcnKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIG5vdCBkZXRlY3QgYSBydHRzLWFzc2VydCBlcnJvcicsIGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBleGVjKCdub2RlIGJ1aWxkL2xpYi9ydHRzLWFzc2VydC1lcnJvci5qcycpXG4gICAgICAgIC5zcHJlYWQoZnVuY3Rpb24gKHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgICAgICAgcHJpbnQoc3Rkb3V0LCBzdGRlcnIpO1xuICAgICAgICAgIHN0ZGVyci5zaG91bGQuZXF1YWwoJycpO1xuICAgICAgICAgIHN0ZG91dC5zaG91bGQuaW5jbHVkZSgnMTIzJyk7XG4gICAgICAgICAgc3Rkb3V0LnNob3VsZC5ub3QuaW5jbHVkZSgnSW52YWxpZCBhcmd1bWVudHMgZ2l2ZW4hJyk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB1c2Ugc291cmNlbWFwIHdoZW4gdGhyb3dpbmcnLCBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gZXhlYygnbm9kZSBidWlsZC9saWIvdGhyb3cuanMnKVxuICAgICAgICAuc3ByZWFkKGZ1bmN0aW9uIChzdGRvdXQsIHN0ZGVycikge1xuICAgICAgICAgIHByaW50KHN0ZG91dCwgc3RkZXJyKTtcbiAgICAgICAgICB2YXIgb3V0cHV0ID0gc3Rkb3V0ICsgc3RkZXJyO1xuICAgICAgICAgIG91dHB1dC5zaG91bGQuaW5jbHVkZSgnVGhpcyBpcyByZWFsbHkgYmFkIScpO1xuICAgICAgICAgIG91dHB1dC5zaG91bGQuaW5jbHVkZSgnLmVzNy5qcycpO1xuICAgICAgICAgIG91dHB1dC5zaG91bGQuaW5jbHVkZSgndGhyb3cuZXM3LmpzOjcnKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHVzZSBzb3VyY2VtYXAgd2hlbiB0aHJvd2luZyB3aXRoaW4gbW9jaGEnLCBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gZXhlYygnLi9ub2RlX21vZHVsZXMvLmJpbi9tb2NoYSBidWlsZC90ZXN0L2EtdGhyb3ctc3BlY3MuanMnKVxuICAgICAgICAuc3ByZWFkKGZ1bmN0aW9uIChzdGRvdXQsIHN0ZGVycikge1xuICAgICAgICAgIHByaW50KHN0ZG91dCwgc3RkZXJyKTtcbiAgICAgICAgICB2YXIgb3V0cHV0ID0gc3Rkb3V0ICsgc3RkZXJyO1xuICAgICAgICAgIG91dHB1dC5zaG91bGQuaW5jbHVkZSgnVGhpcyBpcyByZWFsbHkgYmFkIScpO1xuICAgICAgICAgIG91dHB1dC5zaG91bGQuaW5jbHVkZSgnLmVzNy5qcycpO1xuICAgICAgICAgIG91dHB1dC5zaG91bGQuaW5jbHVkZSgnYS10aHJvdy1zcGVjcy5lczcuanM6MTEnKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGJlIGFibGUgdG8gdXNlIGd1bHAtbW9jaGEnLCBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gZXhlYygnLi9ub2RlX21vZHVsZXMvLmJpbi9ndWxwIHRlc3QtZXM3LW1vY2hhJyArIGd1bHBPcHRzKVxuICAgICAgICAuc3ByZWFkKGZ1bmN0aW9uIChzdGRvdXQsIHN0ZGVycikge1xuICAgICAgICAgIHByaW50KHN0ZG91dCwgc3RkZXJyKTtcbiAgICAgICAgICBzdGRlcnIuc2hvdWxkLmVxbCgnJyk7XG4gICAgICAgICAgc3Rkb3V0LnNob3VsZC5pbmNsdWRlKCdGaW5pc2hlZCcpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdXNlIHNvdXJjZW1hcCB3aGVuIHRocm93aW5nIHdpdGhpbiBndWxwLW1vY2hhJywgZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIGV4ZWMoJy4vbm9kZV9tb2R1bGVzLy5iaW4vZ3VscCAtLW5vLW5vdGlmIHRlc3QtZXM3LW1vY2hhLXRocm93JyArIGd1bHBPcHRzKVxuICAgICAgICAuc3ByZWFkKGZ1bmN0aW9uIChzdGRvdXQsIHN0ZGVycikge1xuICAgICAgICAgIHByaW50KHN0ZG91dCwgc3RkZXJyKTtcbiAgICAgICAgICB2YXIgb3V0cHV0ID0gc3Rkb3V0ICsgc3RkZXJyO1xuICAgICAgICAgIG91dHB1dC5zaG91bGQuaW5jbHVkZSgnVGhpcyBpcyByZWFsbHkgYmFkIScpO1xuICAgICAgICAgIG91dHB1dC5zaG91bGQuaW5jbHVkZSgnLmVzNy5qcycpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfTtcblxuICBkZXNjcmliZSgnY2hlY2sgdHJhbnNwaWxlZCBjb2RlJywgZnVuY3Rpb24gKCkge1xuICAgIGNoZWNrQ29kZSgpO1xuICB9KTtcblxuICAvLyBza2lwIGJlY2F1c2UgZmxvdyByZXF1aXJlcyBleHRyYSBzZXR1cCBhbmQgd2UgbWlnaHQgbm90IHdhbnQgdG8gc3VwcG9ydFxuICAvLyBpdCBhdCBhbGxcbiAgZGVzY3JpYmUuc2tpcCgnY2hlY2sgdHJhbnNwaWxlZCBjb2RlIHdoZW4gZmxvdyBpcyBlbmFibGVkJywgZnVuY3Rpb24gKCkge1xuICAgIGNoZWNrQ29kZSh7ZmxvdzogdHJ1ZX0pO1xuICB9KTtcblxufSk7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
