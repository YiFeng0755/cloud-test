/* eslint promise/prefer-await-to-then: 0 */
"use strict";

var Q = require('q'),
    Args = require("vargs").Constructor,
    _exec = require('child_process').exec,
    chai = require('chai'),
    readFile = Q.denodeify(require('fs').readFile);

chai.should();

// we don't care about exec errors
var exec = Q.denodeify(function () {
  var args = new Args(arguments);
  _exec.apply(null, args.all.concat([function (err, stdout, stderr) {
    args.callback(null, stdout, stderr);
  }]));
});

// some debug
function print(stdout, stderr) {
  if (process.env.VERBOSE) {
    if ((stdout || '').length) {
      console.log('stdout -->', stdout); // eslint-disable-line no-console
    }
    if ((stderr || '').length > 0) {
      console.log('stderr -->', stderr); // eslint-disable-line no-console
    }
  }
}

describe('transpile-specs', function () {
  this.timeout(10000);

  it('should transpile es7 fixtures', function () {
    return exec('./node_modules/.bin/gulp transpile-es7-fixtures').spread(function (stdout, stderr) {
      print(stdout, stderr);
      stderr.should.eql('');
      stdout.should.include('Finished');
    }).then(function () {
      return readFile('build/lib/a.js', 'utf8');
    }).then(function (content) {
      content.should.have.length.above(0);
      content.should.include('sourceMapping');
    });
  });

  var checkCode = function checkCode(opts) {
    opts = opts || {};
    var gulpOpts = opts.flow ? ' --flow' : '';
    before(function () {
      return exec('./node_modules/.bin/gulp transpile-es7-fixtures' + gulpOpts);
    });

    it('should be able to run transpiled code', function () {
      return exec('node build/lib/run.js').spread(function (stdout, stderr) {
        print(stdout, stderr);
        stderr.should.equal('');
        stdout.should.include('hello world!');
      });
    });

    it('should be able to run transpiled tests', function () {
      return exec('./node_modules/.bin/mocha build/test/a-specs.js').spread(function (stdout, stderr) {
        print(stdout, stderr);
        stderr.should.equal('');
        stdout.should.include('1 passing');
      });
    });

    it('should not detect a rtts-assert error', function () {
      return exec('node build/lib/rtts-assert-error.js').spread(function (stdout, stderr) {
        print(stdout, stderr);
        stderr.should.equal('');
        stdout.should.include('123');
        stdout.should.not.include('Invalid arguments given!');
      });
    });

    it('should use sourcemap when throwing', function () {
      return exec('node build/lib/throw.js').spread(function (stdout, stderr) {
        print(stdout, stderr);
        var output = stdout + stderr;
        output.should.include('This is really bad!');
        output.should.include('.es7.js');
        output.should.include('throw.es7.js:7');
      });
    });

    it('should use sourcemap when throwing within mocha', function () {
      return exec('./node_modules/.bin/mocha build/test/a-throw-specs.js').spread(function (stdout, stderr) {
        print(stdout, stderr);
        var output = stdout + stderr;
        output.should.include('This is really bad!');
        output.should.include('.es7.js');
        output.should.include('a-throw-specs.es7.js:11');
      });
    });

    it('should be able to use gulp-mocha', function () {
      return exec('./node_modules/.bin/gulp test-es7-mocha' + gulpOpts).spread(function (stdout, stderr) {
        print(stdout, stderr);
        stderr.should.eql('');
        stdout.should.include('Finished');
      });
    });

    it('should use sourcemap when throwing within gulp-mocha', function () {
      return exec('./node_modules/.bin/gulp --no-notif test-es7-mocha-throw' + gulpOpts).spread(function (stdout, stderr) {
        print(stdout, stderr);
        var output = stdout + stderr;
        output.should.include('This is really bad!');
        output.should.include('.es7.js');
      });
    });
  };

  describe('check transpiled code', function () {
    checkCode();
  });

  // skip because flow requires extra setup and we might not want to support
  // it at all
  describe.skip('check transpiled code when flow is enabled', function () {
    checkCode({ flow: true });
  });
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,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YUFBSyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztBQUN0QixjQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN0QixjQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztPQUNuQyxDQUFDLENBQUM7S0FDTixDQUFDLENBQUM7O0FBRUgsTUFBRSxDQUFDLHNEQUFzRCxFQUFFLFlBQVk7QUFDckUsYUFBTyxJQUFJLENBQUMsMERBQTBELEdBQUcsUUFBUSxDQUFDLENBQy9FLE1BQU0sQ0FBQyxVQUFVLE1BQU0sRUFBRSxNQUFNLEVBQUU7QUFDaEMsYUFBSyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztBQUN0QixZQUFJLE1BQU0sR0FBRyxNQUFNLEdBQUcsTUFBTSxDQUFDO0FBQzdCLGNBQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUM7QUFDN0MsY0FBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7T0FDbEMsQ0FBQyxDQUFDO0tBQ04sQ0FBQyxDQUFDO0dBQ0osQ0FBQzs7QUFFRixVQUFRLENBQUMsdUJBQXVCLEVBQUUsWUFBWTtBQUM1QyxhQUFTLEVBQUUsQ0FBQztHQUNiLENBQUMsQ0FBQzs7OztBQUlILFVBQVEsQ0FBQyxJQUFJLENBQUMsNENBQTRDLEVBQUUsWUFBWTtBQUN0RSxhQUFTLENBQUMsRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztHQUN6QixDQUFDLENBQUM7Q0FDSixDQUFDLENBQUMiLCJmaWxlIjoidGVzdC90cmFuc3BpbGUtc3BlY3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tdGhlbjogMCAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG5cbmxldCBRID0gcmVxdWlyZSgncScpLFxuICAgIEFyZ3MgPSByZXF1aXJlKFwidmFyZ3NcIikuQ29uc3RydWN0b3IsXG4gICAgX2V4ZWMgPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJykuZXhlYyxcbiAgICBjaGFpID0gcmVxdWlyZSgnY2hhaScpLFxuICAgIHJlYWRGaWxlID0gUS5kZW5vZGVpZnkocmVxdWlyZSgnZnMnKS5yZWFkRmlsZSk7XG5cbmNoYWkuc2hvdWxkKCk7XG5cbi8vIHdlIGRvbid0IGNhcmUgYWJvdXQgZXhlYyBlcnJvcnNcbmxldCBleGVjID0gUS5kZW5vZGVpZnkoZnVuY3Rpb24gKCkge1xuICBsZXQgYXJncyA9IG5ldyBBcmdzIChhcmd1bWVudHMpO1xuICBfZXhlYy5hcHBseShudWxsLCBhcmdzLmFsbC5jb25jYXQoW2Z1bmN0aW9uIChlcnIsIHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgYXJncy5jYWxsYmFjayhudWxsLCBzdGRvdXQsIHN0ZGVycik7XG4gIH1dKSk7XG59KTtcblxuLy8gc29tZSBkZWJ1Z1xuZnVuY3Rpb24gcHJpbnQgKHN0ZG91dCwgc3RkZXJyKSB7XG4gIGlmIChwcm9jZXNzLmVudi5WRVJCT1NFKSB7XG4gICAgaWYgKChzdGRvdXQgfHwgJycpLmxlbmd0aCkge1xuICAgICAgY29uc29sZS5sb2coJ3N0ZG91dCAtLT4nLCBzdGRvdXQpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGVcbiAgICB9XG4gICAgaWYgKChzdGRlcnIgfHwgJycpLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnNvbGUubG9nKCdzdGRlcnIgLS0+Jywgc3RkZXJyKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlXG4gICAgfVxuICB9XG59XG5cbmRlc2NyaWJlKCd0cmFuc3BpbGUtc3BlY3MnLCBmdW5jdGlvbiAoKSB7XG4gIHRoaXMudGltZW91dCgxMDAwMCk7XG5cbiAgaXQoJ3Nob3VsZCB0cmFuc3BpbGUgZXM3IGZpeHR1cmVzJywgZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBleGVjKCcuL25vZGVfbW9kdWxlcy8uYmluL2d1bHAgdHJhbnNwaWxlLWVzNy1maXh0dXJlcycpXG4gICAgICAuc3ByZWFkKGZ1bmN0aW9uIChzdGRvdXQsIHN0ZGVycikge1xuICAgICAgICBwcmludChzdGRvdXQsIHN0ZGVycik7XG4gICAgICAgIHN0ZGVyci5zaG91bGQuZXFsKCcnKTtcbiAgICAgICAgc3Rkb3V0LnNob3VsZC5pbmNsdWRlKCdGaW5pc2hlZCcpO1xuICAgICAgfSkudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiByZWFkRmlsZSgnYnVpbGQvbGliL2EuanMnLCAndXRmOCcpO1xuICAgICAgfSkudGhlbihmdW5jdGlvbiAoY29udGVudCkge1xuICAgICAgICBjb250ZW50LnNob3VsZC5oYXZlLmxlbmd0aC5hYm92ZSgwKTtcbiAgICAgICAgY29udGVudC5zaG91bGQuaW5jbHVkZSgnc291cmNlTWFwcGluZycpO1xuICAgICAgfSk7XG4gIH0pO1xuXG4gIGxldCBjaGVja0NvZGUgPSBmdW5jdGlvbiAob3B0cykge1xuICAgIG9wdHMgPSBvcHRzIHx8IHt9O1xuICAgIGxldCBndWxwT3B0cyA9IG9wdHMuZmxvdyA/ICcgLS1mbG93JyA6ICcnO1xuICAgIGJlZm9yZShmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gZXhlYygnLi9ub2RlX21vZHVsZXMvLmJpbi9ndWxwIHRyYW5zcGlsZS1lczctZml4dHVyZXMnICsgZ3VscE9wdHMpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBiZSBhYmxlIHRvIHJ1biB0cmFuc3BpbGVkIGNvZGUnLCBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gZXhlYygnbm9kZSBidWlsZC9saWIvcnVuLmpzJylcbiAgICAgICAgLnNwcmVhZChmdW5jdGlvbiAoc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICAgICAgICBwcmludChzdGRvdXQsIHN0ZGVycik7XG4gICAgICAgICAgc3RkZXJyLnNob3VsZC5lcXVhbCgnJyk7XG4gICAgICAgICAgc3Rkb3V0LnNob3VsZC5pbmNsdWRlKCdoZWxsbyB3b3JsZCEnKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGJlIGFibGUgdG8gcnVuIHRyYW5zcGlsZWQgdGVzdHMnLCBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gZXhlYygnLi9ub2RlX21vZHVsZXMvLmJpbi9tb2NoYSBidWlsZC90ZXN0L2Etc3BlY3MuanMnKVxuICAgICAgICAuc3ByZWFkKGZ1bmN0aW9uIChzdGRvdXQsIHN0ZGVycikge1xuICAgICAgICAgIHByaW50KHN0ZG91dCwgc3RkZXJyKTtcbiAgICAgICAgICBzdGRlcnIuc2hvdWxkLmVxdWFsKCcnKTtcbiAgICAgICAgICBzdGRvdXQuc2hvdWxkLmluY2x1ZGUoJzEgcGFzc2luZycpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgbm90IGRldGVjdCBhIHJ0dHMtYXNzZXJ0IGVycm9yJywgZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIGV4ZWMoJ25vZGUgYnVpbGQvbGliL3J0dHMtYXNzZXJ0LWVycm9yLmpzJylcbiAgICAgICAgLnNwcmVhZChmdW5jdGlvbiAoc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICAgICAgICBwcmludChzdGRvdXQsIHN0ZGVycik7XG4gICAgICAgICAgc3RkZXJyLnNob3VsZC5lcXVhbCgnJyk7XG4gICAgICAgICAgc3Rkb3V0LnNob3VsZC5pbmNsdWRlKCcxMjMnKTtcbiAgICAgICAgICBzdGRvdXQuc2hvdWxkLm5vdC5pbmNsdWRlKCdJbnZhbGlkIGFyZ3VtZW50cyBnaXZlbiEnKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHVzZSBzb3VyY2VtYXAgd2hlbiB0aHJvd2luZycsIGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBleGVjKCdub2RlIGJ1aWxkL2xpYi90aHJvdy5qcycpXG4gICAgICAgIC5zcHJlYWQoZnVuY3Rpb24gKHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgICAgICAgcHJpbnQoc3Rkb3V0LCBzdGRlcnIpO1xuICAgICAgICAgIGxldCBvdXRwdXQgPSBzdGRvdXQgKyBzdGRlcnI7XG4gICAgICAgICAgb3V0cHV0LnNob3VsZC5pbmNsdWRlKCdUaGlzIGlzIHJlYWxseSBiYWQhJyk7XG4gICAgICAgICAgb3V0cHV0LnNob3VsZC5pbmNsdWRlKCcuZXM3LmpzJyk7XG4gICAgICAgICAgb3V0cHV0LnNob3VsZC5pbmNsdWRlKCd0aHJvdy5lczcuanM6NycpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdXNlIHNvdXJjZW1hcCB3aGVuIHRocm93aW5nIHdpdGhpbiBtb2NoYScsIGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBleGVjKCcuL25vZGVfbW9kdWxlcy8uYmluL21vY2hhIGJ1aWxkL3Rlc3QvYS10aHJvdy1zcGVjcy5qcycpXG4gICAgICAgIC5zcHJlYWQoZnVuY3Rpb24gKHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgICAgICAgcHJpbnQoc3Rkb3V0LCBzdGRlcnIpO1xuICAgICAgICAgIGxldCBvdXRwdXQgPSBzdGRvdXQgKyBzdGRlcnI7XG4gICAgICAgICAgb3V0cHV0LnNob3VsZC5pbmNsdWRlKCdUaGlzIGlzIHJlYWxseSBiYWQhJyk7XG4gICAgICAgICAgb3V0cHV0LnNob3VsZC5pbmNsdWRlKCcuZXM3LmpzJyk7XG4gICAgICAgICAgb3V0cHV0LnNob3VsZC5pbmNsdWRlKCdhLXRocm93LXNwZWNzLmVzNy5qczoxMScpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgYmUgYWJsZSB0byB1c2UgZ3VscC1tb2NoYScsIGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBleGVjKCcuL25vZGVfbW9kdWxlcy8uYmluL2d1bHAgdGVzdC1lczctbW9jaGEnICsgZ3VscE9wdHMpXG4gICAgICAgIC5zcHJlYWQoZnVuY3Rpb24gKHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgICAgICAgcHJpbnQoc3Rkb3V0LCBzdGRlcnIpO1xuICAgICAgICAgIHN0ZGVyci5zaG91bGQuZXFsKCcnKTtcbiAgICAgICAgICBzdGRvdXQuc2hvdWxkLmluY2x1ZGUoJ0ZpbmlzaGVkJyk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB1c2Ugc291cmNlbWFwIHdoZW4gdGhyb3dpbmcgd2l0aGluIGd1bHAtbW9jaGEnLCBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gZXhlYygnLi9ub2RlX21vZHVsZXMvLmJpbi9ndWxwIC0tbm8tbm90aWYgdGVzdC1lczctbW9jaGEtdGhyb3cnICsgZ3VscE9wdHMpXG4gICAgICAgIC5zcHJlYWQoZnVuY3Rpb24gKHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgICAgICAgcHJpbnQoc3Rkb3V0LCBzdGRlcnIpO1xuICAgICAgICAgIGxldCBvdXRwdXQgPSBzdGRvdXQgKyBzdGRlcnI7XG4gICAgICAgICAgb3V0cHV0LnNob3VsZC5pbmNsdWRlKCdUaGlzIGlzIHJlYWxseSBiYWQhJyk7XG4gICAgICAgICAgb3V0cHV0LnNob3VsZC5pbmNsdWRlKCcuZXM3LmpzJyk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9O1xuXG4gIGRlc2NyaWJlKCdjaGVjayB0cmFuc3BpbGVkIGNvZGUnLCBmdW5jdGlvbiAoKSB7XG4gICAgY2hlY2tDb2RlKCk7XG4gIH0pO1xuXG4gIC8vIHNraXAgYmVjYXVzZSBmbG93IHJlcXVpcmVzIGV4dHJhIHNldHVwIGFuZCB3ZSBtaWdodCBub3Qgd2FudCB0byBzdXBwb3J0XG4gIC8vIGl0IGF0IGFsbFxuICBkZXNjcmliZS5za2lwKCdjaGVjayB0cmFuc3BpbGVkIGNvZGUgd2hlbiBmbG93IGlzIGVuYWJsZWQnLCBmdW5jdGlvbiAoKSB7XG4gICAgY2hlY2tDb2RlKHtmbG93OiB0cnVlfSk7XG4gIH0pO1xufSk7XG4iXSwic291cmNlUm9vdCI6Ii4uXFwuLiJ9
