/* eslint promise/prefer-await-to-then: 0 */
/* eslint promise/catch-or-return: 0 */
"use strict";

var clear = require('clear'),
    spawn = require('child_process').spawn,
    gulp = require('gulp'),
    gutil = require('gulp-util'),
    Q = require('q'),
    notifier = require('node-notifier'),
    moment = require('moment'),
    _ = require('lodash'),
    path = require('path');

var exitOnError = false;
var clearTerminal = true;

var notify = function notify(subtitle, message) {
  if (process.argv.indexOf('--no-notif') >= 0) return; // eslint-disable-line curly
  var title = undefined;
  try {
    title = process.env.APPIUM_NOTIF_BUILD_NAME || 'Appium';
    notifier.notify({
      title: title,
      subtitle: subtitle + '  ' + moment().format('h:mm:ss'),
      message: message
    });
  } catch (ign) {
    console.warn('notifier: [' + title + '] ' + message); // eslint-disable-line no-console
  }
};

var notifyOK = notify.bind(null, 'Build success!', 'All Good!');

module.exports = {
  use: function use(_gulp) {
    gulp = _gulp;
    return this;
  },

  clear: function clear(_clearTerminal) {
    clearTerminal = _clearTerminal;
    return this;
  },

  handleError: function handleError(err) {
    gutil.log(gutil.colors.red(err));
    var code = /\u001b\[(\d+(;\d+)*)?m/g;
    var notifErr = ('' + err).replace(code, '');
    notify('Build failure!', notifErr);
    if (exitOnError) {
      process.exit(1);
    }
  },
  configure: function configure(taskName, filePattern, watchFn) {
    var subtaskName = '_' + taskName;

    var isRespawn = process.argv.indexOf('--respawn') > 0;
    gulp.task(subtaskName, function () {
      exitOnError = true;
      gulp.watch(filePattern, function () {
        if (clearTerminal) {
          clear();
        }
        return watchFn().then(notifyOK);
      });
      gulp.watch(['gulpfile.js'], function () {
        process.exit(0);
      });

      if (!isRespawn) {
        Q.delay(500).then(function () {
          watchFn().then(notifyOK);
        });
      }
    });

    gulp.task(taskName, function () {
      if (clearTerminal) {
        clear();
      }
      var spawnWatch = function spawnWatch(respawn) {
        var args = [subtaskName];
        if (process.argv.indexOf('--no-notif') >= 0) {
          args.push('--no-notif');
        }
        if (respawn) {
          args.push('--respawn');
        }
        args = args.concat(_.chain(process.argv).tail(2).filter(function (arg) {
          if (/gulp$/.test(arg)) return false; // eslint-disable-line curly
          return [taskName, subtaskName, '--no-notif', '--respawn'].indexOf(arg) < 0;
        }).value());
        var proc = spawn(path.resolve('.', 'node_modules', '.bin', 'gulp'), args, { stdio: 'inherit', shell: true });
        proc.on('close', function (code) {
          spawnWatch(code !== 0);
        });
      };
      spawnWatch();
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,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LEdBQUcsRUFBRTtBQUNyRSxjQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsT0FBTyxLQUFLLENBQUM7QUFDcEMsaUJBQVEsQ0FBQyxRQUFRLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFFO1NBQzlFLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0FBQ1osWUFBSSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLGNBQWMsRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUMsS0FBSyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztBQUMzRyxZQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxVQUFVLElBQUksRUFBRTtBQUMvQixvQkFBVSxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQztTQUN4QixDQUFDLENBQUM7T0FDSixDQUFDO0FBQ0YsZ0JBQVUsRUFBRSxDQUFDO0tBQ2QsQ0FBQyxDQUFDO0dBQ0o7Q0FDRixDQUFDIiwiZmlsZSI6ImxpYi9zcGF3bi13YXRjaGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50IHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLXRoZW46IDAgKi9cbi8qIGVzbGludCBwcm9taXNlL2NhdGNoLW9yLXJldHVybjogMCAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG5cbmxldCBjbGVhciA9IHJlcXVpcmUoJ2NsZWFyJyksXG4gICAgc3Bhd24gPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJykuc3Bhd24sXG4gICAgZ3VscCA9IHJlcXVpcmUoJ2d1bHAnKSxcbiAgICBndXRpbCA9IHJlcXVpcmUoJ2d1bHAtdXRpbCcpLFxuICAgIFEgPSByZXF1aXJlKCdxJyksXG4gICAgbm90aWZpZXIgPSByZXF1aXJlKCdub2RlLW5vdGlmaWVyJyksXG4gICAgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50JyksXG4gICAgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpLFxuICAgIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5cbmxldCBleGl0T25FcnJvciA9IGZhbHNlO1xubGV0IGNsZWFyVGVybWluYWwgPSB0cnVlO1xuXG5sZXQgbm90aWZ5ID0gZnVuY3Rpb24gKHN1YnRpdGxlLCBtZXNzYWdlKSB7XG4gIGlmIChwcm9jZXNzLmFyZ3YuaW5kZXhPZignLS1uby1ub3RpZicpID49IDApIHJldHVybjsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuICBsZXQgdGl0bGU7XG4gIHRyeSB7XG4gICAgdGl0bGUgPSBwcm9jZXNzLmVudi5BUFBJVU1fTk9USUZfQlVJTERfTkFNRSB8fCAnQXBwaXVtJztcbiAgICBub3RpZmllci5ub3RpZnkoe1xuICAgICAgdGl0bGUsXG4gICAgICBzdWJ0aXRsZTogYCR7c3VidGl0bGV9ICAke21vbWVudCgpLmZvcm1hdCgnaDptbTpzcycpfWAsXG4gICAgICBtZXNzYWdlXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGlnbikge1xuICAgIGNvbnNvbGUud2Fybihgbm90aWZpZXI6IFske3RpdGxlfV0gJHttZXNzYWdlfWApOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGVcbiAgfVxufTtcblxubGV0IG5vdGlmeU9LID0gbm90aWZ5LmJpbmQobnVsbCwgJ0J1aWxkIHN1Y2Nlc3MhJywgJ0FsbCBHb29kIScpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgdXNlIChfZ3VscCkge1xuICAgIGd1bHAgPSBfZ3VscDtcbiAgICByZXR1cm4gdGhpcztcbiAgfSxcblxuICBjbGVhciAoX2NsZWFyVGVybWluYWwpIHtcbiAgICBjbGVhclRlcm1pbmFsID0gX2NsZWFyVGVybWluYWw7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sXG5cbiAgaGFuZGxlRXJyb3IgKGVycikge1xuICAgIGd1dGlsLmxvZyhndXRpbC5jb2xvcnMucmVkKGVycikpO1xuICAgIGxldCBjb2RlID0gL1xcdTAwMWJcXFsoXFxkKyg7XFxkKykqKT9tL2c7XG4gICAgbGV0IG5vdGlmRXJyID0gKCcnICsgZXJyKS5yZXBsYWNlKGNvZGUsICcnKTtcbiAgICBub3RpZnkoJ0J1aWxkIGZhaWx1cmUhJywgbm90aWZFcnIpO1xuICAgIGlmIChleGl0T25FcnJvcikge1xuICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgIH1cbiAgfSxcbiAgY29uZmlndXJlICh0YXNrTmFtZSwgZmlsZVBhdHRlcm4sIHdhdGNoRm4pIHtcbiAgICBsZXQgc3VidGFza05hbWUgPSAnXycgKyB0YXNrTmFtZTtcblxuICAgIGxldCBpc1Jlc3Bhd24gPSBwcm9jZXNzLmFyZ3YuaW5kZXhPZignLS1yZXNwYXduJykgPiAwO1xuICAgIGd1bHAudGFzayhzdWJ0YXNrTmFtZSwgZnVuY3Rpb24gKCkge1xuICAgICAgZXhpdE9uRXJyb3IgPSB0cnVlO1xuICAgICAgZ3VscC53YXRjaChmaWxlUGF0dGVybiwgZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAoY2xlYXJUZXJtaW5hbCkge1xuICAgICAgICAgIGNsZWFyKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHdhdGNoRm4oKS50aGVuKG5vdGlmeU9LKTtcbiAgICAgIH0pO1xuICAgICAgZ3VscC53YXRjaChbJ2d1bHBmaWxlLmpzJ10sIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcHJvY2Vzcy5leGl0KDApO1xuICAgICAgfSk7XG5cbiAgICAgIGlmICghaXNSZXNwYXduKSB7XG4gICAgICAgIFEuZGVsYXkoNTAwKS50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICB3YXRjaEZuKCkudGhlbihub3RpZnlPSyk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgZ3VscC50YXNrKHRhc2tOYW1lLCBmdW5jdGlvbiAoKSB7XG4gICAgICBpZiAoY2xlYXJUZXJtaW5hbCkge1xuICAgICAgICBjbGVhcigpO1xuICAgICAgfVxuICAgICAgbGV0IHNwYXduV2F0Y2ggPSBmdW5jdGlvbiAocmVzcGF3bikge1xuICAgICAgICBsZXQgYXJncyA9IFtzdWJ0YXNrTmFtZV07XG4gICAgICAgIGlmIChwcm9jZXNzLmFyZ3YuaW5kZXhPZignLS1uby1ub3RpZicpID49IDApIHtcbiAgICAgICAgICBhcmdzLnB1c2goJy0tbm8tbm90aWYnKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzcGF3bikge1xuICAgICAgICAgIGFyZ3MucHVzaCgnLS1yZXNwYXduJyk7XG4gICAgICAgIH1cbiAgICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KF8uY2hhaW4ocHJvY2Vzcy5hcmd2KS50YWlsKDIpLmZpbHRlcihmdW5jdGlvbiAoYXJnKSB7XG4gICAgICAgICAgaWYgKC9ndWxwJC8udGVzdChhcmcpKSByZXR1cm4gZmFsc2U7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgICAgICAgICByZXR1cm4gKFt0YXNrTmFtZSwgc3VidGFza05hbWUsICctLW5vLW5vdGlmJywgJy0tcmVzcGF3biddLmluZGV4T2YoYXJnKSA8IDApO1xuICAgICAgICB9KS52YWx1ZSgpKTtcbiAgICAgICAgbGV0IHByb2MgPSBzcGF3bihwYXRoLnJlc29sdmUoJy4nLCAnbm9kZV9tb2R1bGVzJywgJy5iaW4nLCAnZ3VscCcpLCBhcmdzLCB7c3RkaW86ICdpbmhlcml0Jywgc2hlbGw6IHRydWV9KTtcbiAgICAgICAgcHJvYy5vbignY2xvc2UnLCBmdW5jdGlvbiAoY29kZSkge1xuICAgICAgICAgIHNwYXduV2F0Y2goY29kZSAhPT0gMCk7XG4gICAgICAgIH0pO1xuICAgICAgfTtcbiAgICAgIHNwYXduV2F0Y2goKTtcbiAgICB9KTtcbiAgfVxufTtcbiJdLCJzb3VyY2VSb290IjoiLi5cXC4uIn0=
