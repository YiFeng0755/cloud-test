/* eslint promise/prefer-await-to-then: 0 */
/* eslint promise/prefer-await-to-callbacks: 0 */
"use strict";

var mocha = require('gulp-mocha'),
    Q = require('q'),
    globby = require('globby'),
    Transpiler = require('../index').Transpiler,
    eslint = require('gulp-eslint'),
    vinylPaths = require('vinyl-paths'),
    del = require('del'),
    _ = require('lodash'),
    AndroidEmulator = require('appium-ci').AndroidEmulator,
    androidTools = require('appium-ci').androidTools,
    iosTools = require('appium-ci').iosTools,
    spawn = require('child_process').spawn,
    exec = Q.denodeify(require('child_process').exec),
    path = require('path');

if (process.env.TRAVIS || process.env.CI) {
  process.env.REAL_DEVICE = 0;
}

var DEFAULT_OPTS = {
  files: ["*.js", "lib/**/*.js", "test/**/*.js", "!gulpfile.js"],
  transpile: true,
  transpileOut: "build",
  babelOpts: {},
  linkBabelRuntime: true,
  watch: true,
  watchE2E: false,
  test: {
    files: ['${testDir}/**/*-specs.js', '!${testDir}/**/*-e2e-specs.js']
  },
  coverage: {
    files: ['./test/**/*-specs.js', '!./test/**/*-e2e-specs.js'],
    verbose: true
  },
  'coverage-e2e': {
    files: ['./test/**/*-e2e-specs.js'],
    verbose: true
  },
  e2eTest: {
    files: '${testDir}/**/*-e2e-specs.js',
    forceExit: process.env.TRAVIS || process.env.CI
  },
  testReporter: process.env.TRAVIS || process.env.CI ? 'spec' : 'nyan',
  testTimeout: 8000,
  buildName: null,
  extraPrepublishTasks: [],
  eslint: true
};

var DEFAULT_ANDROID_E2ETEST_OPTS = {
  "android-emu": true,
  "android-avd": process.env.ANDROID_AVD || "NEXUS_S_18_X86"
};

// string interpolation
var interpolate = function interpolate(s, opts) {
  return _.keys(opts).reduce(function (s, k) {
    return s.replace(new RegExp('\\$\\{\\s*' + k + '\\s*\\}', 'g'), opts[k]);
  }, s);
};

var boilerplate = function boilerplate(gulp, opts) {
  var spawnWatcher = require('../index').spawnWatcher.use(gulp);
  var runSequence = Q.denodeify(require('run-sequence').use(gulp));
  opts = _.cloneDeep(opts);
  _.defaults(opts, DEFAULT_OPTS);

  // re-defaulting when e2eTest.android=true
  if (opts.e2eTest.android) {
    _.defaults(opts.e2eTest, DEFAULT_OPTS.e2eTest);
    _.defaults(opts.e2eTest, DEFAULT_ANDROID_E2ETEST_OPTS);
  }
  // re-defaulting when e2eTest.ios=true
  if (opts.e2eTest.ios) {
    _.defaults(opts.e2eTest, DEFAULT_OPTS.e2eTest);
  }
  process.env.APPIUM_NOTIF_BUILD_NAME = opts.buildName;

  gulp.task('clean', function () {
    if (opts.transpile) {
      return gulp.src(opts.transpileOut, { read: false }).pipe(vinylPaths(del));
    }
  });

  var testDeps = [];
  var testTasks = [];
  var rootDir = '.';
  if (opts.transpile) {
    testDeps.push('transpile');
    rootDir = opts.transpileOut;
  }
  var fileAliases = { rootDir: rootDir, testDir: rootDir + '/test', libDir: rootDir + '/lib' };

  if (opts.test) {
    (function () {
      var testFiles = _.flatten([opts.test.files || opts.testFiles]).map(function (f) {
        return interpolate(f, fileAliases);
      });
      gulp.task('unit-test', testDeps, function () {
        var isForceLogMode = parseInt(process.env._FORCE_LOGS, 10) === 1;
        var reporter = isForceLogMode ? 'spec' : process.env.REPORTER ? process.env.REPORTER : opts.testReporter;
        var mochaOpts = {
          reporter: reporter,
          timeout: opts.testTimeout,
          'require': opts.testRequire || []
        };
        // set env so our code knows when it's being run in a test env
        process.env._TESTING = 1;
        return gulp.src(testFiles, { read: false }).pipe(mocha(mochaOpts)).once('error', spawnWatcher.handleError);
      });
      testTasks.push('unit-test');
    })();
  }

  var doCoverage = function doCoverage(taskName, filePatterns, targetDir) {
    var covTestFiles = _.flatten([filePatterns]).map(function (f) {
      return interpolate(f, fileAliases);
    });
    gulp.task(taskName, function () {
      return exec('rm -rf ./build').then(function () {
        return exec('npm bin').then(function (npmBin) {
          if (Array.isArray(npmBin)) {
            npmBin = npmBin[0];
          }
          npmBin = npmBin.trim();
          return globby(covTestFiles).then(function (files) {
            var deferred = Q.defer();
            var bins = {};
            _.each(['istanbul', '_mocha'], function (k) {
              bins[k] = path.resolve(npmBin, k);
            });
            var bin = bins.istanbul;
            var args = ['cover', '--dir', targetDir, bins._mocha, '--', '--reporter', 'dot', '--compilers', 'js:babel-core/register'].concat(files);
            var env = _.clone(process.env);
            env.NO_PRECOMPILE = 1;
            env._TESTING = 1;
            console.log("running command -->", bin, args.join(' ')); // eslint-disable-line no-console
            var proc = spawn(bin, args, { stdio: opts.coverage.verbose ? 'inherit' : 'ignore', env: env });
            proc.on('close', function (code) {
              if (code === 0) {
                deferred.resolve();
              } else {
                deferred.reject(new Error('Coverage command exit code: ' + code));
              }
            });
            return deferred.promise;
          });
        });
      })['catch'](spawnWatcher.handleError);
    });
  };
  if (opts.coverage) {
    doCoverage('coverage', opts.coverage.files, 'coverage');
    gulp.task('coveralls', ['coverage'], function () {
      return exec('npm bin').then(function (npmBin) {
        if (Array.isArray(npmBin)) {
          npmBin = npmBin[0];
        }
        npmBin = npmBin.trim();
        var bin = path.resolve(npmBin, 'coveralls');
        return exec('cat ./coverage/lcov.info | ' + bin)['catch'](spawnWatcher.handleError);
      });
    });
  }
  if (opts['coverage-e2e']) {
    doCoverage('coverage-e2e', opts['coverage-e2e'].files, 'coverage-e2e');
  }
  if (opts.e2eTest) {
    (function () {
      var e2eTestFiles = _.flatten([opts.e2eTest.files || opts.e2eTestFiles]).map(function (f) {
        return interpolate(f, fileAliases);
      });
      gulp.task('e2e-test', testDeps, function () {
        var isForceLogMode = parseInt(process.env._FORCE_LOGS, 10) === 1;
        var mochaOpts = {
          reporter: isForceLogMode ? 'spec' : opts.testReporter,
          timeout: opts.testTimeout
        };
        // set env so our code knows when it's being run in a test env
        process.env._TESTING = 1;

        var mochaCmd = function mochaCmd() {
          return Q.Promise(function (resolve, reject) {
            gulp.src(e2eTestFiles, { read: false }).pipe(mocha(mochaOpts)).once('error', function (err) {
              reject(err);
            }).once('end', function () {
              resolve.apply(null, arguments);
            });
          });
        };

        var startupSeq = [];
        var cleanupSeq = [];
        var cleanupWarn = function cleanupWarn(err) {
          console.warn('Error during cleanup, ignoring:', err);
        }; // eslint-disable-line no-console
        if (opts.e2eTest.android) {
          if (opts.e2eTest["android-emu"]) {
            (function () {
              var emu = new AndroidEmulator(opts.e2eTest['android-avd']);
              startupSeq = [function () {
                return androidTools.killAll();
              }, function () {
                return new Q(emu.start());
              }, function () {
                return emu.waitTillReady();
              }];
              cleanupSeq = cleanupSeq.concat([function () {
                return emu.stop();
              }, function () {
                return androidTools.killAll()['catch'](cleanupWarn);
              }]);
            })();
          } else {
            startupSeq = [function () {
              return androidTools.killAll();
            }];
            cleanupSeq = cleanupSeq.concat([function () {
              return androidTools.killAll()['catch'](cleanupWarn);
            }]);
          }
        }
        if (opts.e2eTest.ios) {
          (function () {
            var xCodeVersion = opts.e2eTest.xCodeVersion || '6.1.1';
            startupSeq = [function () {
              return iosTools.killAll();
            }, function () {
              return iosTools.configureXcode(xCodeVersion);
            }, function () {
              return iosTools.resetSims();
            }];
            cleanupSeq = cleanupSeq.concat([function () {
              return iosTools.killAll()['catch'](cleanupWarn);
            }]);
          })();
        }

        // go through the steps to run the test
        startupSeq.reduce(function (step, sequence) {
          return sequence.then(step);
        }, new Q()).then(mochaCmd).then(function () {
          return cleanupSeq.reduce(function (step, sequence) {
            return sequence.then(step);
          }, new Q()).fin(function () {
            if (opts.e2eTest.forceExit) {
              process.exit(0);
            }
          });
        })['catch'](function () {
          return cleanupSeq.reduce(function (step, sequence) {
            return sequence.then(step);
          }, new Q()).fin(function () {
            if (opts.e2eTest.forceExit) {
              process.exit(1);
            }
          });
        });
      });
      testTasks.push('e2e-test');
    })();
  }

  if (testTasks.length > 0) {
    gulp.task('test', function () {
      return runSequence.apply(null, testTasks);
    });
  }

  if (opts.transpile) {
    gulp.task('transpile', function () {
      var transpiler = new Transpiler(opts);
      return gulp.src(opts.files, { base: './' }).pipe(transpiler.stream()).on('error', spawnWatcher.handleError).pipe(gulp.dest(opts.transpileOut));
    });

    gulp.task('prepublish', function () {
      var tasks = ['clean', 'transpile'].concat(opts.extraPrepublishTasks);
      return runSequence.apply(this, tasks);
    });
  }

  gulp.task('eslint', function () {
    return gulp.src(['**/*.js', '!node_modules/**', '!build/**']).pipe(eslint()).pipe(eslint.format()).pipe(eslint.failAfterError());
  });

  var lintTasks = [];
  if (opts.eslint) {
    opts.lint = true;
    lintTasks.push('eslint');
  }

  var defaultSequence = [];
  if (opts.transpile) {
    defaultSequence.push('clean');
  }
  if (opts.lint) {
    gulp.task('lint', lintTasks);
    defaultSequence.push('lint');
  }
  if (opts.transpile && !opts.test) {
    defaultSequence.push('transpile');
  }
  if (opts.postTranspile) {
    defaultSequence = defaultSequence.concat(opts.postTranspile);
  }
  if (opts.test) {
    if (opts.watchE2E) {
      defaultSequence.push('test');
    } else if (_.includes(testTasks, 'unit-test')) {
      defaultSequence.push('unit-test');
    }
  }
  if (opts.extraDefaultTasks) {
    defaultSequence = defaultSequence.concat(opts.extraDefaultTasks);
  }

  if (opts.watch) {
    spawnWatcher.clear(false);
    spawnWatcher.configure('watch', opts.files, function () {
      return runSequence.apply(null, defaultSequence);
    });
  }

  gulp.task('once', function () {
    return runSequence.apply(null, defaultSequence);
  });

  gulp.task('default', [opts.watch ? 'watch' : 'once']);
};

module.exports = {
  DEFAULTS: _.cloneDeep(DEFAULT_OPTS),
  use: function use(gulp) {
    return function (opts) {
      boilerplate(gulp, opts);
    };
  }
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,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TUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLE9BQU8sR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDO0NBQ3ZELENBQUM7O0FBR0YsTUFBTSxDQUFDLE9BQU8sR0FBRztBQUNmLFVBQVEsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQztBQUNuQyxLQUFHLEVBQUMsYUFBQyxJQUFJLEVBQUU7QUFDVCxXQUFPLFVBQVUsSUFBSSxFQUFFO0FBQ3JCLGlCQUFXLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ3pCLENBQUM7R0FDSDtDQUNGLENBQUMiLCJmaWxlIjoibGliL2JvaWxlcnBsYXRlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50IHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLXRoZW46IDAgKi9cbi8qIGVzbGludCBwcm9taXNlL3ByZWZlci1hd2FpdC10by1jYWxsYmFja3M6IDAgKi9cblwidXNlIHN0cmljdFwiO1xuXG5sZXQgbW9jaGEgPSByZXF1aXJlKCdndWxwLW1vY2hhJyksXG4gICAgUSA9IHJlcXVpcmUoJ3EnKSxcbiAgICBnbG9iYnkgPSByZXF1aXJlKCdnbG9iYnknKSxcbiAgICBUcmFuc3BpbGVyID0gcmVxdWlyZSgnLi4vaW5kZXgnKS5UcmFuc3BpbGVyLFxuICAgIGVzbGludCA9IHJlcXVpcmUoJ2d1bHAtZXNsaW50JyksXG4gICAgdmlueWxQYXRocyA9IHJlcXVpcmUoJ3ZpbnlsLXBhdGhzJyksXG4gICAgZGVsID0gcmVxdWlyZSgnZGVsJyksXG4gICAgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpLFxuICAgIEFuZHJvaWRFbXVsYXRvciA9IHJlcXVpcmUoJ2FwcGl1bS1jaScpLkFuZHJvaWRFbXVsYXRvcixcbiAgICBhbmRyb2lkVG9vbHMgPSByZXF1aXJlKCdhcHBpdW0tY2knKS5hbmRyb2lkVG9vbHMsXG4gICAgaW9zVG9vbHMgPSByZXF1aXJlKCdhcHBpdW0tY2knKS5pb3NUb29scyxcbiAgICBzcGF3biA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKS5zcGF3bixcbiAgICBleGVjID0gUS5kZW5vZGVpZnkocmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpLmV4ZWMpLFxuICAgIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5cblxuaWYgKHByb2Nlc3MuZW52LlRSQVZJUyB8fCBwcm9jZXNzLmVudi5DSSkge1xuICBwcm9jZXNzLmVudi5SRUFMX0RFVklDRSA9IDA7XG59XG5cbmxldCBERUZBVUxUX09QVFMgPSB7XG4gIGZpbGVzOiBbXCIqLmpzXCIsIFwibGliLyoqLyouanNcIiwgXCJ0ZXN0LyoqLyouanNcIiwgXCIhZ3VscGZpbGUuanNcIl0sXG4gIHRyYW5zcGlsZTogdHJ1ZSxcbiAgdHJhbnNwaWxlT3V0OiBcImJ1aWxkXCIsXG4gIGJhYmVsT3B0czoge30sXG4gIGxpbmtCYWJlbFJ1bnRpbWU6IHRydWUsXG4gIHdhdGNoOiB0cnVlLFxuICB3YXRjaEUyRTogZmFsc2UsXG4gIHRlc3Q6IHtcbiAgICBmaWxlczogWycke3Rlc3REaXJ9LyoqLyotc3BlY3MuanMnLCAnISR7dGVzdERpcn0vKiovKi1lMmUtc3BlY3MuanMnXVxuICB9LFxuICBjb3ZlcmFnZToge1xuICAgIGZpbGVzOiBbJy4vdGVzdC8qKi8qLXNwZWNzLmpzJywgJyEuL3Rlc3QvKiovKi1lMmUtc3BlY3MuanMnXSxcbiAgICB2ZXJib3NlOiB0cnVlXG4gIH0sXG4gICdjb3ZlcmFnZS1lMmUnOiB7XG4gICAgZmlsZXM6IFsnLi90ZXN0LyoqLyotZTJlLXNwZWNzLmpzJ10sXG4gICAgdmVyYm9zZTogdHJ1ZVxuICB9LFxuICBlMmVUZXN0OiB7XG4gICAgZmlsZXM6ICcke3Rlc3REaXJ9LyoqLyotZTJlLXNwZWNzLmpzJyxcbiAgICBmb3JjZUV4aXQ6IHByb2Nlc3MuZW52LlRSQVZJUyB8fCBwcm9jZXNzLmVudi5DSVxuICB9LFxuICB0ZXN0UmVwb3J0ZXI6IChwcm9jZXNzLmVudi5UUkFWSVMgfHwgcHJvY2Vzcy5lbnYuQ0kpID8gJ3NwZWMnIDogJ255YW4nLFxuICB0ZXN0VGltZW91dDogODAwMCxcbiAgYnVpbGROYW1lOiBudWxsLFxuICBleHRyYVByZXB1Ymxpc2hUYXNrczogW10sXG4gIGVzbGludDogdHJ1ZSxcbn07XG5cbmxldCBERUZBVUxUX0FORFJPSURfRTJFVEVTVF9PUFRTID0ge1xuICBcImFuZHJvaWQtZW11XCI6IHRydWUsXG4gIFwiYW5kcm9pZC1hdmRcIjogcHJvY2Vzcy5lbnYuQU5EUk9JRF9BVkQgfHwgXCJORVhVU19TXzE4X1g4NlwiXG59O1xuXG4vLyBzdHJpbmcgaW50ZXJwb2xhdGlvblxubGV0IGludGVycG9sYXRlID0gZnVuY3Rpb24gKHMsIG9wdHMpIHtcbiAgcmV0dXJuIF8ua2V5cyhvcHRzKS5yZWR1Y2UoZnVuY3Rpb24gKHMsIGspIHtcbiAgICByZXR1cm4gcy5yZXBsYWNlKG5ldyBSZWdFeHAoJ1xcXFwkXFxcXHtcXFxccyonICsgayArICdcXFxccypcXFxcfScsICdnJyksIG9wdHNba10pO1xuICB9LCBzKTtcbn07XG5cbmxldCBib2lsZXJwbGF0ZSA9IGZ1bmN0aW9uIChndWxwLCBvcHRzKSB7XG4gIGxldCBzcGF3bldhdGNoZXIgPSByZXF1aXJlKCcuLi9pbmRleCcpLnNwYXduV2F0Y2hlci51c2UoZ3VscCk7XG4gIGxldCBydW5TZXF1ZW5jZSA9IFEuZGVub2RlaWZ5KHJlcXVpcmUoJ3J1bi1zZXF1ZW5jZScpLnVzZShndWxwKSk7XG4gIG9wdHMgPSBfLmNsb25lRGVlcChvcHRzKTtcbiAgXy5kZWZhdWx0cyhvcHRzLCBERUZBVUxUX09QVFMpO1xuXG4gIC8vIHJlLWRlZmF1bHRpbmcgd2hlbiBlMmVUZXN0LmFuZHJvaWQ9dHJ1ZVxuICBpZiAob3B0cy5lMmVUZXN0LmFuZHJvaWQpIHtcbiAgICBfLmRlZmF1bHRzKG9wdHMuZTJlVGVzdCwgREVGQVVMVF9PUFRTLmUyZVRlc3QpO1xuICAgIF8uZGVmYXVsdHMob3B0cy5lMmVUZXN0LCBERUZBVUxUX0FORFJPSURfRTJFVEVTVF9PUFRTKTtcbiAgfVxuICAvLyByZS1kZWZhdWx0aW5nIHdoZW4gZTJlVGVzdC5pb3M9dHJ1ZVxuICBpZiAob3B0cy5lMmVUZXN0Lmlvcykge1xuICAgIF8uZGVmYXVsdHMob3B0cy5lMmVUZXN0LCBERUZBVUxUX09QVFMuZTJlVGVzdCk7XG4gIH1cbiAgcHJvY2Vzcy5lbnYuQVBQSVVNX05PVElGX0JVSUxEX05BTUUgPSBvcHRzLmJ1aWxkTmFtZTtcblxuICBndWxwLnRhc2soJ2NsZWFuJywgZnVuY3Rpb24gKCkge1xuICAgIGlmIChvcHRzLnRyYW5zcGlsZSkge1xuICAgICAgcmV0dXJuIGd1bHAuc3JjKG9wdHMudHJhbnNwaWxlT3V0LCB7cmVhZDogZmFsc2V9KVxuICAgICAgICAgICAgICAgICAucGlwZSh2aW55bFBhdGhzKGRlbCkpO1xuICAgIH1cbiAgfSk7XG5cbiAgbGV0IHRlc3REZXBzID0gW107XG4gIGxldCB0ZXN0VGFza3MgPSBbXTtcbiAgbGV0IHJvb3REaXIgPSAnLic7XG4gIGlmIChvcHRzLnRyYW5zcGlsZSkge1xuICAgIHRlc3REZXBzLnB1c2goJ3RyYW5zcGlsZScpO1xuICAgIHJvb3REaXIgPSBvcHRzLnRyYW5zcGlsZU91dDtcbiAgfVxuICBsZXQgZmlsZUFsaWFzZXMgPSB7cm9vdERpciwgdGVzdERpcjogYCR7cm9vdERpcn0vdGVzdGAsIGxpYkRpcjogYCR7cm9vdERpcn0vbGliYH07XG5cbiAgaWYgKG9wdHMudGVzdCkge1xuICAgIGxldCB0ZXN0RmlsZXMgPSBfLmZsYXR0ZW4oW29wdHMudGVzdC5maWxlcyB8fCBvcHRzLnRlc3RGaWxlc10pLm1hcChmdW5jdGlvbiAoZikge1xuICAgICAgcmV0dXJuIGludGVycG9sYXRlKGYsIGZpbGVBbGlhc2VzKTtcbiAgICB9KTtcbiAgICBndWxwLnRhc2soJ3VuaXQtdGVzdCcsIHRlc3REZXBzLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaXNGb3JjZUxvZ01vZGUgPSBwYXJzZUludChwcm9jZXNzLmVudi5fRk9SQ0VfTE9HUywgMTApID09PSAxO1xuICAgICAgbGV0IHJlcG9ydGVyID0gaXNGb3JjZUxvZ01vZGUgPyAnc3BlYycgOlxuICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5lbnYuUkVQT1JURVIgPyBwcm9jZXNzLmVudi5SRVBPUlRFUiA6XG4gICAgICAgICAgICAgICAgICAgICBvcHRzLnRlc3RSZXBvcnRlcjtcbiAgICAgIGxldCBtb2NoYU9wdHMgPSB7XG4gICAgICAgIHJlcG9ydGVyLFxuICAgICAgICB0aW1lb3V0OiBvcHRzLnRlc3RUaW1lb3V0LFxuICAgICAgICAncmVxdWlyZSc6IG9wdHMudGVzdFJlcXVpcmUgfHwgW11cbiAgICAgIH07XG4gICAgICAvLyBzZXQgZW52IHNvIG91ciBjb2RlIGtub3dzIHdoZW4gaXQncyBiZWluZyBydW4gaW4gYSB0ZXN0IGVudlxuICAgICAgcHJvY2Vzcy5lbnYuX1RFU1RJTkcgPSAxO1xuICAgICAgcmV0dXJuIGd1bHBcbiAgICAgICAuc3JjKHRlc3RGaWxlcywge3JlYWQ6IGZhbHNlfSlcbiAgICAgICAucGlwZShtb2NoYShtb2NoYU9wdHMpKVxuICAgICAgIC5vbmNlKCdlcnJvcicsIHNwYXduV2F0Y2hlci5oYW5kbGVFcnJvcik7XG4gICAgfSk7XG4gICAgdGVzdFRhc2tzLnB1c2goJ3VuaXQtdGVzdCcpO1xuICB9XG5cbiAgbGV0IGRvQ292ZXJhZ2UgPSBmdW5jdGlvbiAodGFza05hbWUsIGZpbGVQYXR0ZXJucywgdGFyZ2V0RGlyKSB7XG4gICAgbGV0IGNvdlRlc3RGaWxlcyA9IF8uZmxhdHRlbihbZmlsZVBhdHRlcm5zXSkubWFwKGZ1bmN0aW9uIChmKSB7XG4gICAgICByZXR1cm4gaW50ZXJwb2xhdGUoZiwgZmlsZUFsaWFzZXMpO1xuICAgIH0pO1xuICAgIGd1bHAudGFzayh0YXNrTmFtZSwgZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIGV4ZWMoJ3JtIC1yZiAuL2J1aWxkJykudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiBleGVjKCducG0gYmluJykudGhlbihmdW5jdGlvbiAobnBtQmluKSB7XG4gICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobnBtQmluKSkge1xuICAgICAgICAgICAgbnBtQmluID0gbnBtQmluWzBdO1xuICAgICAgICAgIH1cbiAgICAgICAgICBucG1CaW4gPSBucG1CaW4udHJpbSgpO1xuICAgICAgICAgIHJldHVybiBnbG9iYnkoY292VGVzdEZpbGVzKS50aGVuKGZ1bmN0aW9uIChmaWxlcykge1xuICAgICAgICAgICAgbGV0IGRlZmVycmVkID0gUS5kZWZlcigpO1xuICAgICAgICAgICAgbGV0IGJpbnMgPSB7fTtcbiAgICAgICAgICAgIF8uZWFjaChbJ2lzdGFuYnVsJywgJ19tb2NoYSddLCBmdW5jdGlvbiAoaykgeyBiaW5zW2tdID0gcGF0aC5yZXNvbHZlKG5wbUJpbiwgayk7IH0pO1xuICAgICAgICAgICAgbGV0IGJpbiA9IGJpbnMuaXN0YW5idWw7XG4gICAgICAgICAgICBsZXQgYXJncyA9IFsnY292ZXInLCAnLS1kaXInLCB0YXJnZXREaXIsIGJpbnMuX21vY2hhLCAnLS0nLCAnLS1yZXBvcnRlcicsICdkb3QnLCAnLS1jb21waWxlcnMnLCAnanM6YmFiZWwtY29yZS9yZWdpc3RlciddXG4gICAgICAgICAgICAgIC5jb25jYXQoZmlsZXMpO1xuICAgICAgICAgICAgbGV0IGVudiA9IF8uY2xvbmUocHJvY2Vzcy5lbnYpO1xuICAgICAgICAgICAgZW52Lk5PX1BSRUNPTVBJTEU9MTtcbiAgICAgICAgICAgIGVudi5fVEVTVElORz0xO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJydW5uaW5nIGNvbW1hbmQgLS0+XCIsIGJpbiwgYXJncy5qb2luKCcgJykpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGVcbiAgICAgICAgICAgIGxldCBwcm9jID0gc3Bhd24oYmluLCBhcmdzLCB7c3RkaW86IG9wdHMuY292ZXJhZ2UudmVyYm9zZSA/ICdpbmhlcml0JyA6ICdpZ25vcmUnLCBlbnZ9KTtcbiAgICAgICAgICAgIHByb2Mub24oJ2Nsb3NlJywgZnVuY3Rpb24gKGNvZGUpIHtcbiAgICAgICAgICAgICAgaWYgKGNvZGUgPT09IDApIHtcbiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KG5ldyBFcnJvcignQ292ZXJhZ2UgY29tbWFuZCBleGl0IGNvZGU6ICcgKyBjb2RlKSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfSkuY2F0Y2goc3Bhd25XYXRjaGVyLmhhbmRsZUVycm9yKTtcbiAgICB9KTtcbiAgfTtcbiAgaWYgKG9wdHMuY292ZXJhZ2UpIHtcbiAgICBkb0NvdmVyYWdlKCdjb3ZlcmFnZScsIG9wdHMuY292ZXJhZ2UuZmlsZXMsICdjb3ZlcmFnZScpO1xuICAgIGd1bHAudGFzaygnY292ZXJhbGxzJywgWydjb3ZlcmFnZSddLCBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gZXhlYygnbnBtIGJpbicpLnRoZW4oZnVuY3Rpb24gKG5wbUJpbikge1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShucG1CaW4pKSB7XG4gICAgICAgICAgbnBtQmluID0gbnBtQmluWzBdO1xuICAgICAgICB9XG4gICAgICAgIG5wbUJpbiA9IG5wbUJpbi50cmltKCk7XG4gICAgICAgIGxldCBiaW4gPSBwYXRoLnJlc29sdmUobnBtQmluLCAnY292ZXJhbGxzJyk7XG4gICAgICAgIHJldHVybiBleGVjKCdjYXQgLi9jb3ZlcmFnZS9sY292LmluZm8gfCAnICsgYmluKS5jYXRjaChzcGF3bldhdGNoZXIuaGFuZGxlRXJyb3IpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbiAgaWYgKG9wdHNbJ2NvdmVyYWdlLWUyZSddKSB7XG4gICAgZG9Db3ZlcmFnZSgnY292ZXJhZ2UtZTJlJywgb3B0c1snY292ZXJhZ2UtZTJlJ10uZmlsZXMsICdjb3ZlcmFnZS1lMmUnKTtcbiAgfVxuICBpZiAob3B0cy5lMmVUZXN0KSB7XG4gICAgbGV0IGUyZVRlc3RGaWxlcyA9IF8uZmxhdHRlbihbb3B0cy5lMmVUZXN0LmZpbGVzIHx8IG9wdHMuZTJlVGVzdEZpbGVzXSkubWFwKGZ1bmN0aW9uIChmKSB7XG4gICAgICByZXR1cm4gaW50ZXJwb2xhdGUoZiwgZmlsZUFsaWFzZXMpO1xuICAgIH0pO1xuICAgIGd1bHAudGFzaygnZTJlLXRlc3QnLCB0ZXN0RGVwcywgIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBpc0ZvcmNlTG9nTW9kZSA9IHBhcnNlSW50KHByb2Nlc3MuZW52Ll9GT1JDRV9MT0dTLCAxMCkgPT09IDE7XG4gICAgICBsZXQgbW9jaGFPcHRzID0ge1xuICAgICAgICByZXBvcnRlcjogaXNGb3JjZUxvZ01vZGUgPyAnc3BlYycgOiBvcHRzLnRlc3RSZXBvcnRlcixcbiAgICAgICAgdGltZW91dDogb3B0cy50ZXN0VGltZW91dFxuICAgICAgfTtcbiAgICAgIC8vIHNldCBlbnYgc28gb3VyIGNvZGUga25vd3Mgd2hlbiBpdCdzIGJlaW5nIHJ1biBpbiBhIHRlc3QgZW52XG4gICAgICBwcm9jZXNzLmVudi5fVEVTVElORyA9IDE7XG5cbiAgICAgIGxldCBtb2NoYUNtZCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIFEuUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgZ3VscFxuICAgICAgICAgICAgLnNyYyhlMmVUZXN0RmlsZXMsIHtyZWFkOiBmYWxzZX0pXG4gICAgICAgICAgICAucGlwZShtb2NoYShtb2NoYU9wdHMpKVxuICAgICAgICAgICAgLm9uY2UoJ2Vycm9yJywgZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAub25jZSgnZW5kJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICByZXNvbHZlLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9O1xuXG4gICAgICBsZXQgc3RhcnR1cFNlcSA9IFtdO1xuICAgICAgbGV0IGNsZWFudXBTZXEgPSBbXTtcbiAgICAgIGxldCBjbGVhbnVwV2FybiA9IGZ1bmN0aW9uIChlcnIpIHsgY29uc29sZS53YXJuKCdFcnJvciBkdXJpbmcgY2xlYW51cCwgaWdub3Jpbmc6JywgZXJyKTsgfTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlXG4gICAgICBpZiAob3B0cy5lMmVUZXN0LmFuZHJvaWQpIHtcbiAgICAgICAgaWYgKG9wdHMuZTJlVGVzdFtcImFuZHJvaWQtZW11XCJdKSB7XG4gICAgICAgICAgbGV0IGVtdSA9IG5ldyBBbmRyb2lkRW11bGF0b3Iob3B0cy5lMmVUZXN0WydhbmRyb2lkLWF2ZCddKTtcbiAgICAgICAgICBzdGFydHVwU2VxID0gW1xuICAgICAgICAgICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gYW5kcm9pZFRvb2xzLmtpbGxBbGwoKTsgfSxcbiAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBRKGVtdS5zdGFydCgpKTsgfSxcbiAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIGVtdS53YWl0VGlsbFJlYWR5KCk7fVxuICAgICAgICAgIF07XG4gICAgICAgICAgY2xlYW51cFNlcSA9IGNsZWFudXBTZXEuY29uY2F0KFtcbiAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIGVtdS5zdG9wKCk7IH0sXG4gICAgICAgICAgICBmdW5jdGlvbiAoKSB7IHJldHVybiBhbmRyb2lkVG9vbHMua2lsbEFsbCgpLmNhdGNoKGNsZWFudXBXYXJuKTsgfVxuICAgICAgICAgIF0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHN0YXJ0dXBTZXEgPSBbXG4gICAgICAgICAgICBmdW5jdGlvbiAoKSB7IHJldHVybiBhbmRyb2lkVG9vbHMua2lsbEFsbCgpOyB9LFxuICAgICAgICAgIF07XG4gICAgICAgICAgY2xlYW51cFNlcSA9IGNsZWFudXBTZXEuY29uY2F0KFtcbiAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIGFuZHJvaWRUb29scy5raWxsQWxsKCkuY2F0Y2goY2xlYW51cFdhcm4pOyB9XG4gICAgICAgICAgXSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChvcHRzLmUyZVRlc3QuaW9zKSB7XG4gICAgICAgIGxldCB4Q29kZVZlcnNpb24gPSBvcHRzLmUyZVRlc3QueENvZGVWZXJzaW9uIHx8ICc2LjEuMSc7XG4gICAgICAgIHN0YXJ0dXBTZXEgPSBbXG4gICAgICAgICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gaW9zVG9vbHMua2lsbEFsbCgpOyB9LFxuICAgICAgICAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIGlvc1Rvb2xzLmNvbmZpZ3VyZVhjb2RlKHhDb2RlVmVyc2lvbik7IH0sXG4gICAgICAgICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gaW9zVG9vbHMucmVzZXRTaW1zKCk7IH0sXG4gICAgICAgIF07XG4gICAgICAgIGNsZWFudXBTZXEgPSBjbGVhbnVwU2VxLmNvbmNhdChbXG4gICAgICAgICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gaW9zVG9vbHMua2lsbEFsbCgpLmNhdGNoKGNsZWFudXBXYXJuKTsgfVxuICAgICAgICBdKTtcbiAgICAgIH1cblxuICAgICAgLy8gZ28gdGhyb3VnaCB0aGUgc3RlcHMgdG8gcnVuIHRoZSB0ZXN0XG4gICAgICBzdGFydHVwU2VxLnJlZHVjZSgoc3RlcCwgc2VxdWVuY2UpID0+IHNlcXVlbmNlLnRoZW4oc3RlcCksIG5ldyBRKCkpXG4gICAgICAgIC50aGVuKG1vY2hhQ21kKVxuICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgcmV0dXJuIGNsZWFudXBTZXEucmVkdWNlKChzdGVwLCBzZXF1ZW5jZSkgPT4gc2VxdWVuY2UudGhlbihzdGVwKSwgbmV3IFEoKSlcbiAgICAgICAgICAgIC5maW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICBpZiAob3B0cy5lMmVUZXN0LmZvcmNlRXhpdCkge1xuICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgwKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICByZXR1cm4gY2xlYW51cFNlcS5yZWR1Y2UoKHN0ZXAsIHNlcXVlbmNlKSA9PiBzZXF1ZW5jZS50aGVuKHN0ZXApLCBuZXcgUSgpKVxuICAgICAgICAgICAgLmZpbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgIGlmIChvcHRzLmUyZVRlc3QuZm9yY2VFeGl0KSB7XG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgdGVzdFRhc2tzLnB1c2goJ2UyZS10ZXN0Jyk7XG4gIH1cblxuICBpZiAodGVzdFRhc2tzLmxlbmd0aCA+IDApIHtcbiAgICBndWxwLnRhc2soJ3Rlc3QnLCBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gcnVuU2VxdWVuY2UuYXBwbHkobnVsbCwgdGVzdFRhc2tzKTtcbiAgICB9KTtcbiAgfVxuXG4gIGlmIChvcHRzLnRyYW5zcGlsZSkge1xuICAgIGd1bHAudGFzaygndHJhbnNwaWxlJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IHRyYW5zcGlsZXIgPSBuZXcgVHJhbnNwaWxlcihvcHRzKTtcbiAgICAgIHJldHVybiBndWxwLnNyYyhvcHRzLmZpbGVzLCB7YmFzZTogJy4vJ30pXG4gICAgICAgIC5waXBlKHRyYW5zcGlsZXIuc3RyZWFtKCkpXG4gICAgICAgIC5vbignZXJyb3InLCBzcGF3bldhdGNoZXIuaGFuZGxlRXJyb3IpXG4gICAgICAgIC5waXBlKGd1bHAuZGVzdChvcHRzLnRyYW5zcGlsZU91dCkpO1xuICAgIH0pO1xuXG4gICAgZ3VscC50YXNrKCdwcmVwdWJsaXNoJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IHRhc2tzID0gWydjbGVhbicsICd0cmFuc3BpbGUnXS5jb25jYXQob3B0cy5leHRyYVByZXB1Ymxpc2hUYXNrcyk7XG4gICAgICByZXR1cm4gcnVuU2VxdWVuY2UuYXBwbHkodGhpcywgdGFza3MpO1xuICAgIH0pO1xuICB9XG5cbiAgZ3VscC50YXNrKCdlc2xpbnQnLCBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIGd1bHAuc3JjKFsnKiovKi5qcycsICchbm9kZV9tb2R1bGVzLyoqJywgJyFidWlsZC8qKiddKVxuICAgICAgLnBpcGUoZXNsaW50KCkpXG4gICAgICAucGlwZShlc2xpbnQuZm9ybWF0KCkpXG4gICAgICAucGlwZShlc2xpbnQuZmFpbEFmdGVyRXJyb3IoKSk7XG4gIH0pO1xuXG4gIGxldCBsaW50VGFza3MgPSBbXTtcbiAgaWYgKG9wdHMuZXNsaW50KSB7XG4gICAgb3B0cy5saW50ID0gdHJ1ZTtcbiAgICBsaW50VGFza3MucHVzaCgnZXNsaW50Jyk7XG4gIH1cblxuICBsZXQgZGVmYXVsdFNlcXVlbmNlID0gW107XG4gIGlmIChvcHRzLnRyYW5zcGlsZSkge1xuICAgIGRlZmF1bHRTZXF1ZW5jZS5wdXNoKCdjbGVhbicpO1xuICB9XG4gIGlmIChvcHRzLmxpbnQpIHtcbiAgICBndWxwLnRhc2soJ2xpbnQnLCBsaW50VGFza3MpO1xuICAgIGRlZmF1bHRTZXF1ZW5jZS5wdXNoKCdsaW50Jyk7XG4gIH1cbiAgaWYgKG9wdHMudHJhbnNwaWxlICYmICFvcHRzLnRlc3QpIHtcbiAgICBkZWZhdWx0U2VxdWVuY2UucHVzaCgndHJhbnNwaWxlJyk7XG4gIH1cbiAgaWYgKG9wdHMucG9zdFRyYW5zcGlsZSkge1xuICAgIGRlZmF1bHRTZXF1ZW5jZSA9IGRlZmF1bHRTZXF1ZW5jZS5jb25jYXQob3B0cy5wb3N0VHJhbnNwaWxlKTtcbiAgfVxuICBpZiAob3B0cy50ZXN0KSB7XG4gICAgaWYgKG9wdHMud2F0Y2hFMkUpIHtcbiAgICAgIGRlZmF1bHRTZXF1ZW5jZS5wdXNoKCd0ZXN0Jyk7XG4gICAgfSBlbHNlIGlmIChfLmluY2x1ZGVzKHRlc3RUYXNrcywgJ3VuaXQtdGVzdCcpKSB7XG4gICAgICBkZWZhdWx0U2VxdWVuY2UucHVzaCgndW5pdC10ZXN0Jyk7XG4gICAgfVxuICB9XG4gIGlmIChvcHRzLmV4dHJhRGVmYXVsdFRhc2tzKSB7XG4gICAgZGVmYXVsdFNlcXVlbmNlID0gZGVmYXVsdFNlcXVlbmNlLmNvbmNhdChvcHRzLmV4dHJhRGVmYXVsdFRhc2tzKTtcbiAgfVxuXG4gIGlmIChvcHRzLndhdGNoKSB7XG4gICAgc3Bhd25XYXRjaGVyLmNsZWFyKGZhbHNlKTtcbiAgICBzcGF3bldhdGNoZXIuY29uZmlndXJlKCd3YXRjaCcsIG9wdHMuZmlsZXMsIGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBydW5TZXF1ZW5jZS5hcHBseShudWxsLCBkZWZhdWx0U2VxdWVuY2UpO1xuICAgIH0pO1xuICB9XG5cbiAgZ3VscC50YXNrKCdvbmNlJywgZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBydW5TZXF1ZW5jZS5hcHBseShudWxsLCBkZWZhdWx0U2VxdWVuY2UpO1xuICB9KTtcblxuICBndWxwLnRhc2soJ2RlZmF1bHQnLCBbb3B0cy53YXRjaCA/ICd3YXRjaCcgOiAnb25jZSddKTtcbn07XG5cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIERFRkFVTFRTOiBfLmNsb25lRGVlcChERUZBVUxUX09QVFMpLFxuICB1c2UgKGd1bHApIHtcbiAgICByZXR1cm4gZnVuY3Rpb24gKG9wdHMpIHtcbiAgICAgIGJvaWxlcnBsYXRlKGd1bHAsIG9wdHMpO1xuICAgIH07XG4gIH1cbn07XG4iXSwic291cmNlUm9vdCI6Ii4uXFwuLiJ9
