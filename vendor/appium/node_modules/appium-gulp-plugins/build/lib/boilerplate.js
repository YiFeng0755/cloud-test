"use strict";
var mocha = require('gulp-mocha'),
    Q = require('q'),
    globby = Q.denodeify(require('globby')),
    Transpiler = require('../index').Transpiler,
    jshint = require('gulp-jshint'),
    eslint = require('gulp-eslint'),
    vinylPaths = require('vinyl-paths'),
    del = require('del'),
    _ = require('lodash'),
    promisePipe = require("promisepipe"),
    AndroidEmulator = require('appium-ci').AndroidEmulator,
    androidTools = require('appium-ci').androidTools,
    iosTools = require('appium-ci').iosTools,
    spawn = require('child_process').spawn,
    exec = Q.denodeify(require('child_process').exec),
    path = require('path');

var DEFAULT_OPTS = {
  files: ["*.js", "lib/**/*.js", "test/**/*.js", "!gulpfile.js"],
  transpile: true,
  transpileOut: "build",
  babelOpts: {},
  linkBabelRuntime: true,
  jshint: true,
  watch: true,
  watchE2E: false,
  test: {
    files: ['${testDir}/**/*-specs.js', '!${testDir}/**/*-e2e-specs.js']
  },
  coverage: {
    files: ['./test/**/*-specs.js', '!./test/**/*-e2e-specs.js'],
    verbose: true
  },
  'coverage-e2e': {
    files: ['./test/**/*-e2e-specs.js'],
    verbose: true
  },
  e2eTest: {
    files: '${testDir}/**/*-e2e-specs.js',
    forceExit: process.env.TRAVIS || process.env.CI
  },
  testReporter: process.env.TRAVIS || process.env.CI ? 'spec' : 'nyan',
  testTimeout: 8000,
  buildName: null,
  extraPrepublishTasks: [],
  preCommitTasks: ['jshint', 'once']
};

var DEFAULT_ANDROID_E2ETEST_OPTS = {
  "android-emu": true,
  "android-avd": process.env.ANDROID_AVD || "NEXUS_S_18_X86"
};

// string interpolation
var interpolate = function interpolate(s, opts) {
  return _.keys(opts).reduce(function (s, k) {
    return s.replace(new RegExp('\\$\\{\\s*' + k + '\\s*\\}', 'g'), opts[k]);
  }, s);
};

var boilerplate = function boilerplate(gulp, opts) {
  var spawnWatcher = require('../index').spawnWatcher.use(gulp);
  var runSequence = Q.denodeify(require('run-sequence').use(gulp));
  opts = _.cloneDeep(opts);
  _.defaults(opts, DEFAULT_OPTS);

  // re-defaulting when e2eTest.android=true
  if (opts.e2eTest.android) {
    _.defaults(opts.e2eTest, DEFAULT_OPTS.e2eTest);
    _.defaults(opts.e2eTest, DEFAULT_ANDROID_E2ETEST_OPTS);
  }
  // re-defaulting when e2eTest.ios=true
  if (opts.e2eTest.ios) {
    _.defaults(opts.e2eTest, DEFAULT_OPTS.e2eTest);
  }
  process.env.APPIUM_NOTIF_BUILD_NAME = opts.buildName;

  gulp.task('clean', function () {
    if (opts.transpile) {
      return gulp.src(opts.transpileOut, { read: false }).pipe(vinylPaths(del));
    }
  });

  var testDeps = [];
  var testTasks = [];
  var rootDir = '.';
  if (opts.transpile) {
    testDeps.push('transpile');
    rootDir = opts.transpileOut;
  }
  var fileAliases = { rootDir: rootDir, testDir: rootDir + '/test', libDir: rootDir + '/lib' };

  if (opts.test) {
    var testFiles = _.flatten([opts.test.files || opts.testFiles]).map(function (f) {
      return interpolate(f, fileAliases);
    });
    gulp.task('unit-test', testDeps, function () {
      var isForceLogMode = parseInt(process.env._FORCE_LOGS, 10) === 1;
      var mochaOpts = {
        reporter: isForceLogMode ? 'spec' : opts.testReporter,
        timeout: opts.testTimeout,
        'require': opts.testRequire || []
      };
      // set env so our code knows when it's being run in a test env
      process.env._TESTING = 1;
      return gulp.src(testFiles, { read: false }).pipe(mocha(mochaOpts)).on('error', spawnWatcher.handleError);
    });
    testTasks.push('unit-test');
  }

  var doCoverage = function doCoverage(taskName, filePatterns, targetDir) {
    var covTestFiles = _.flatten([filePatterns]).map(function (f) {
      return interpolate(f, fileAliases);
    });
    gulp.task(taskName, function () {
      return exec('rm -rf ./build').then(function () {
        return globby(covTestFiles).then(function (files) {
          var deferred = Q.defer();
          var bins = {};
          _.each(['isparta', 'babel-node', 'text', '_mocha'], function (k) {
            bins[k] = path.resolve(__dirname, '../node_modules/.bin', k);
          });
          var bin = bins['babel-node'];
          var args = [bins.isparta, 'cover', '--dir', targetDir, bins._mocha, '--', '--require', __dirname + '/../babelhook', '--reporter', 'dot'].concat(files);
          var env = _.clone(process.env);
          env.NO_PRECOMPILE = 1;
          env._TESTING = 1;
          console.log("running command -->", bin, args.join(' ')); // eslint-disable-line no-console
          var proc = spawn(bin, args, { stdio: opts.coverage.verbose ? 'inherit' : 'ignore', env: env });
          proc.on('close', function (code) {
            if (code === 0) {
              deferred.resolve();
            } else {
              deferred.reject(new Error('Coverage command exit code: ' + code));
            }
          });
          return deferred.promise;
        });
      })['catch'](spawnWatcher.handleError);
    });
  };
  if (opts.coverage) {
    doCoverage('coverage', opts.coverage.files, 'coverage');
    gulp.task('coveralls', ['coverage'], function () {
      var bin = path.resolve(__dirname, '../node_modules/.bin/coveralls');
      return exec('cat ./coverage/lcov.info | ' + bin)['catch'](spawnWatcher.handleError);
    });
  }
  if (opts['coverage-e2e']) {
    doCoverage('coverage-e2e', opts['coverage-e2e'].files, 'coverage-e2e');
  }
  if (opts.e2eTest) {
    var e2eTestFiles = _.flatten([opts.e2eTest.files || opts.e2eTestFiles]).map(function (f) {
      return interpolate(f, fileAliases);
    });
    gulp.task('e2e-test', testDeps, function () {
      var isForceLogMode = parseInt(process.env._FORCE_LOGS, 10) === 1;
      var mochaOpts = {
        reporter: isForceLogMode ? 'spec' : opts.testReporter,
        timeout: opts.testTimeout
      };
      // set env so our code knows when it's being run in a test env
      process.env._TESTING = 1;
      var seq = [function () {
        return promisePipe(gulp.src(e2eTestFiles, { read: false }).pipe(mocha(mochaOpts)));
      }];
      var cleanupSeq = [];
      var cleanupWarn = function cleanupWarn(err) {
        console.warn('Error during cleanup, ignoring:', err);
      }; // eslint-disable-line no-console
      if (opts.e2eTest.android) {
        if (opts.e2eTest["android-emu"]) {
          var emu = new AndroidEmulator(opts.e2eTest['android-avd']);
          seq = [function () {
            return androidTools.killAll();
          }, function () {
            return new Q(emu.start());
          }, function () {
            return emu.waitTillReady();
          }].concat(seq);
          cleanupSeq = cleanupSeq.concat([function () {
            return emu.stop();
          }, function () {
            return androidTools.killAll()['catch'](cleanupWarn);
          }]);
        } else {
          seq = [function () {
            return androidTools.killAll();
          }].concat(seq);
          cleanupSeq = cleanupSeq.concat([function () {
            return androidTools.killAll()['catch'](cleanupWarn);
          }]);
        }
      }
      if (opts.e2eTest.ios) {
        var xCodeVersion = opts.e2eTest.xCodeVersion || '6.1.1';
        seq = [function () {
          return iosTools.killAll();
        }, function () {
          return iosTools.configureXcode(xCodeVersion);
        }, function () {
          return iosTools.resetSims();
        }].concat(seq);
        cleanupSeq = cleanupSeq.concat([function () {
          return iosTools.killAll()['catch'](cleanupWarn);
        }]);
      }
      return seq.reduce(Q.when, new Q()).then(function () {
        return cleanupSeq.reduce(Q.when, new Q()).fin(function () {
          if (opts.e2eTest.forceExit) {
            process.exit(0);
          }
        });
      })['catch'](function (err) {
        return cleanupSeq.reduce(Q.when, new Q()).fin(function () {
          spawnWatcher.handleError(err);
          if (opts.e2eTest.forceExit) {
            process.exit(1);
          }
        });
      });
    });
    testTasks.push('e2e-test');
  }

  if (testTasks.length > 0) {
    gulp.task('test', function () {
      return runSequence.apply(null, testTasks);
    });
  }

  if (opts.transpile) {
    gulp.task('transpile', function () {
      var transpiler = new Transpiler(opts);
      return gulp.src(opts.files, { base: './' }).pipe(transpiler.stream()).on('error', spawnWatcher.handleError).pipe(gulp.dest(opts.transpileOut));
    });

    gulp.task('prepublish', function () {
      var tasks = ['clean', 'transpile'].concat(opts.extraPrepublishTasks);
      return runSequence.apply(this, tasks);
    });
  }

  var lintTasks = [];

  gulp.task('eslint', function () {
    return gulp.src(['**/*.js', '!node_modules/**', '!build/**']).pipe(eslint()).pipe(eslint.format()).pipe(eslint.failAfterError());
  });

  if (opts.jshint) {
    gulp.task('jshint', function () {
      return gulp.src(opts.files).pipe(jshint()).pipe(jshint.reporter('jshint-stylish')).pipe(jshint.reporter('fail')).on('error', spawnWatcher.handleError);
    });
    lintTasks.push('jshint');
  }

  if (opts.jshint) {
    opts.lint = true;
    gulp.task('lint', lintTasks);
  }

  var defaultSequence = [];
  if (opts.transpile) defaultSequence.push('clean');
  if (opts.lint) defaultSequence.push('lint');
  if (opts.transpile && !opts.test) defaultSequence.push('transpile');
  if (opts.postTranspile) defaultSequence = defaultSequence.concat(opts.postTranspile);
  if (opts.test) {
    if (opts.watchE2E) {
      defaultSequence.push('test');
    } else if (_.includes(testTasks, 'unit-test')) {
      defaultSequence.push('unit-test');
    }
  }
  if (opts.extraDefaultTasks) defaultSequence = defaultSequence.concat(opts.extraDefaultTasks);

  if (opts.watch) {
    spawnWatcher.clear(false);
    spawnWatcher.configure('watch', opts.files, function () {
      return runSequence.apply(null, defaultSequence);
    });
  }

  gulp.task('once', function () {
    return runSequence.apply(null, defaultSequence);
  });

  gulp.task('default', [opts.watch ? 'watch' : 'once']);

  if (opts.preCommitTasks) {
    // this is a magic task that gets picked up by `git-guppy`
    // and automatically added as a pre-commit git hook
    gulp.task('pre-commit', opts.preCommitTasks);
  }
};

module.exports = {
  DEFAULTS: _.cloneDeep(DEFAULT_OPTS),
  use: function use(gulp) {
    return function (opts) {
      boilerplate(gulp, opts);
    };
  }
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUksSUFBSSxDQUFDLGlCQUFpQixFQUFFLGVBQWUsR0FBRyxlQUFlLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDOztBQUU3RixNQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7QUFDZCxnQkFBWSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUMxQixnQkFBWSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxZQUFZO0FBQ3RELGFBQU8sV0FBVyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsZUFBZSxDQUFDLENBQUM7S0FDakQsQ0FBQyxDQUFDO0dBQ0o7O0FBRUQsTUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsWUFBWTtBQUM1QixXQUFPLFdBQVcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLGVBQWUsQ0FBQyxDQUFDO0dBQ2pELENBQUMsQ0FBQzs7QUFFSCxNQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsT0FBTyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUM7O0FBRXRELE1BQUksSUFBSSxDQUFDLGNBQWMsRUFBRTs7O0FBR3ZCLFFBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztHQUM5QztDQUNGLENBQUM7O0FBR0YsTUFBTSxDQUFDLE9BQU8sR0FBRztBQUNmLFVBQVEsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQztBQUNuQyxLQUFHLEVBQUMsYUFBQyxJQUFJLEVBQUU7QUFDVCxXQUFPLFVBQVUsSUFBSSxFQUFFO0FBQ3JCLGlCQUFXLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ3pCLENBQUM7R0FDSDtDQUNGLENBQUMiLCJmaWxlIjoibGliL2JvaWxlcnBsYXRlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG52YXIgbW9jaGEgPSByZXF1aXJlKCdndWxwLW1vY2hhJyksXG4gICAgUSA9IHJlcXVpcmUoJ3EnKSxcbiAgICBnbG9iYnkgPSBRLmRlbm9kZWlmeShyZXF1aXJlKCdnbG9iYnknKSksXG4gICAgVHJhbnNwaWxlciA9IHJlcXVpcmUoJy4uL2luZGV4JykuVHJhbnNwaWxlcixcbiAgICBqc2hpbnQgPSByZXF1aXJlKCdndWxwLWpzaGludCcpLFxuICAgIGVzbGludCA9IHJlcXVpcmUoJ2d1bHAtZXNsaW50JyksXG4gICAgdmlueWxQYXRocyA9IHJlcXVpcmUoJ3ZpbnlsLXBhdGhzJyksXG4gICAgZGVsID0gcmVxdWlyZSgnZGVsJyksXG4gICAgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpLFxuICAgIHByb21pc2VQaXBlID0gcmVxdWlyZShcInByb21pc2VwaXBlXCIpLFxuICAgIEFuZHJvaWRFbXVsYXRvciA9IHJlcXVpcmUoJ2FwcGl1bS1jaScpLkFuZHJvaWRFbXVsYXRvcixcbiAgICBhbmRyb2lkVG9vbHMgPSByZXF1aXJlKCdhcHBpdW0tY2knKS5hbmRyb2lkVG9vbHMsXG4gICAgaW9zVG9vbHMgPSByZXF1aXJlKCdhcHBpdW0tY2knKS5pb3NUb29scyxcbiAgICBzcGF3biA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKS5zcGF3bixcbiAgICBleGVjID0gUS5kZW5vZGVpZnkocmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpLmV4ZWMpLFxuICAgIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5cbnZhciBERUZBVUxUX09QVFMgPSB7XG4gIGZpbGVzOiBbXCIqLmpzXCIsIFwibGliLyoqLyouanNcIiwgXCJ0ZXN0LyoqLyouanNcIiwgXCIhZ3VscGZpbGUuanNcIl0sXG4gIHRyYW5zcGlsZTogdHJ1ZSxcbiAgdHJhbnNwaWxlT3V0OiBcImJ1aWxkXCIsXG4gIGJhYmVsT3B0czoge30sXG4gIGxpbmtCYWJlbFJ1bnRpbWU6IHRydWUsXG4gIGpzaGludDogdHJ1ZSxcbiAgd2F0Y2g6IHRydWUsXG4gIHdhdGNoRTJFOiBmYWxzZSxcbiAgdGVzdDoge1xuICAgIGZpbGVzOiBbJyR7dGVzdERpcn0vKiovKi1zcGVjcy5qcycsICchJHt0ZXN0RGlyfS8qKi8qLWUyZS1zcGVjcy5qcyddXG4gIH0sXG4gIGNvdmVyYWdlOiB7XG4gICAgZmlsZXM6IFsnLi90ZXN0LyoqLyotc3BlY3MuanMnLCAnIS4vdGVzdC8qKi8qLWUyZS1zcGVjcy5qcyddLFxuICAgIHZlcmJvc2U6IHRydWVcbiAgfSxcbiAgJ2NvdmVyYWdlLWUyZSc6IHtcbiAgICBmaWxlczogWycuL3Rlc3QvKiovKi1lMmUtc3BlY3MuanMnXSxcbiAgICB2ZXJib3NlOiB0cnVlXG4gIH0sXG4gIGUyZVRlc3Q6IHtcbiAgICBmaWxlczogJyR7dGVzdERpcn0vKiovKi1lMmUtc3BlY3MuanMnLFxuICAgIGZvcmNlRXhpdDogcHJvY2Vzcy5lbnYuVFJBVklTIHx8IHByb2Nlc3MuZW52LkNJXG4gIH0sXG4gIHRlc3RSZXBvcnRlcjogKCBwcm9jZXNzLmVudi5UUkFWSVMgfHwgcHJvY2Vzcy5lbnYuQ0kgKSA/ICdzcGVjJyA6ICdueWFuJyxcbiAgdGVzdFRpbWVvdXQ6IDgwMDAsXG4gIGJ1aWxkTmFtZTogbnVsbCxcbiAgZXh0cmFQcmVwdWJsaXNoVGFza3M6IFtdLFxuICBwcmVDb21taXRUYXNrczogWydqc2hpbnQnLCAnb25jZSddXG59O1xuXG52YXIgREVGQVVMVF9BTkRST0lEX0UyRVRFU1RfT1BUUyA9IHtcbiAgXCJhbmRyb2lkLWVtdVwiOiB0cnVlLFxuICBcImFuZHJvaWQtYXZkXCI6IHByb2Nlc3MuZW52LkFORFJPSURfQVZEIHx8IFwiTkVYVVNfU18xOF9YODZcIlxufTtcblxuLy8gc3RyaW5nIGludGVycG9sYXRpb25cbnZhciBpbnRlcnBvbGF0ZSA9IGZ1bmN0aW9uIChzLCBvcHRzKSB7XG4gIHJldHVybiBfLmtleXMob3B0cykucmVkdWNlKGZ1bmN0aW9uIChzLCBrKSB7XG4gICAgcmV0dXJuIHMucmVwbGFjZShuZXcgUmVnRXhwKCdcXFxcJFxcXFx7XFxcXHMqJyArIGsgKyAnXFxcXHMqXFxcXH0nLCAnZycpLCBvcHRzW2tdKTtcbiAgfSwgcyk7XG59O1xuXG52YXIgYm9pbGVycGxhdGUgPSBmdW5jdGlvbiAoZ3VscCwgb3B0cykge1xuICB2YXIgc3Bhd25XYXRjaGVyID0gcmVxdWlyZSgnLi4vaW5kZXgnKS5zcGF3bldhdGNoZXIudXNlKGd1bHApO1xuICB2YXIgcnVuU2VxdWVuY2UgPSBRLmRlbm9kZWlmeShyZXF1aXJlKCdydW4tc2VxdWVuY2UnKS51c2UoZ3VscCkpO1xuICBvcHRzID0gXy5jbG9uZURlZXAob3B0cyk7XG4gIF8uZGVmYXVsdHMob3B0cywgREVGQVVMVF9PUFRTKTtcblxuICAvLyByZS1kZWZhdWx0aW5nIHdoZW4gZTJlVGVzdC5hbmRyb2lkPXRydWVcbiAgaWYgKG9wdHMuZTJlVGVzdC5hbmRyb2lkKSB7XG4gICAgXy5kZWZhdWx0cyhvcHRzLmUyZVRlc3QsIERFRkFVTFRfT1BUUy5lMmVUZXN0KTtcbiAgICBfLmRlZmF1bHRzKG9wdHMuZTJlVGVzdCwgREVGQVVMVF9BTkRST0lEX0UyRVRFU1RfT1BUUyk7XG4gIH1cbiAgLy8gcmUtZGVmYXVsdGluZyB3aGVuIGUyZVRlc3QuaW9zPXRydWVcbiAgaWYgKG9wdHMuZTJlVGVzdC5pb3MpIHtcbiAgICBfLmRlZmF1bHRzKG9wdHMuZTJlVGVzdCwgREVGQVVMVF9PUFRTLmUyZVRlc3QpO1xuICB9XG4gIHByb2Nlc3MuZW52LkFQUElVTV9OT1RJRl9CVUlMRF9OQU1FID0gb3B0cy5idWlsZE5hbWU7XG5cbiAgZ3VscC50YXNrKCdjbGVhbicsIGZ1bmN0aW9uICgpIHtcbiAgICBpZiAob3B0cy50cmFuc3BpbGUpIHtcbiAgICAgIHJldHVybiBndWxwLnNyYyhvcHRzLnRyYW5zcGlsZU91dCwge3JlYWQ6IGZhbHNlfSlcbiAgICAgICAgICAgICAgICAgLnBpcGUodmlueWxQYXRocyhkZWwpKTtcbiAgICB9XG4gIH0pO1xuXG4gIHZhciB0ZXN0RGVwcyA9IFtdO1xuICB2YXIgdGVzdFRhc2tzID0gW107XG4gIHZhciByb290RGlyID0gJy4nO1xuICBpZiAob3B0cy50cmFuc3BpbGUpIHtcbiAgICB0ZXN0RGVwcy5wdXNoKCd0cmFuc3BpbGUnKTtcbiAgICByb290RGlyID0gb3B0cy50cmFuc3BpbGVPdXQ7XG4gIH1cbiAgdmFyIGZpbGVBbGlhc2VzID0ge3Jvb3REaXIsIHRlc3REaXI6IGAke3Jvb3REaXJ9L3Rlc3RgLCBsaWJEaXI6IGAke3Jvb3REaXJ9L2xpYmB9O1xuXG4gIGlmIChvcHRzLnRlc3QpIHtcbiAgICB2YXIgdGVzdEZpbGVzID0gXy5mbGF0dGVuKFtvcHRzLnRlc3QuZmlsZXMgfHwgb3B0cy50ZXN0RmlsZXNdKS5tYXAoZnVuY3Rpb24gKGYpIHtcbiAgICAgIHJldHVybiBpbnRlcnBvbGF0ZShmLCBmaWxlQWxpYXNlcyk7XG4gICAgfSk7XG4gICAgZ3VscC50YXNrKCd1bml0LXRlc3QnLCB0ZXN0RGVwcywgZnVuY3Rpb24gKCkge1xuICAgICAgdmFyIGlzRm9yY2VMb2dNb2RlID0gcGFyc2VJbnQocHJvY2Vzcy5lbnYuX0ZPUkNFX0xPR1MsIDEwKSA9PT0gMTtcbiAgICAgIHZhciBtb2NoYU9wdHMgPSB7XG4gICAgICAgIHJlcG9ydGVyOiBpc0ZvcmNlTG9nTW9kZSA/ICdzcGVjJyA6IG9wdHMudGVzdFJlcG9ydGVyLFxuICAgICAgICB0aW1lb3V0OiBvcHRzLnRlc3RUaW1lb3V0LFxuICAgICAgICAncmVxdWlyZSc6IG9wdHMudGVzdFJlcXVpcmUgfHwgW11cbiAgICAgIH07XG4gICAgICAvLyBzZXQgZW52IHNvIG91ciBjb2RlIGtub3dzIHdoZW4gaXQncyBiZWluZyBydW4gaW4gYSB0ZXN0IGVudlxuICAgICAgcHJvY2Vzcy5lbnYuX1RFU1RJTkcgPSAxO1xuICAgICAgcmV0dXJuIGd1bHBcbiAgICAgICAuc3JjKHRlc3RGaWxlcywge3JlYWQ6IGZhbHNlfSlcbiAgICAgICAucGlwZShtb2NoYShtb2NoYU9wdHMpKVxuICAgICAgIC5vbignZXJyb3InLCBzcGF3bldhdGNoZXIuaGFuZGxlRXJyb3IpO1xuICAgIH0pO1xuICAgIHRlc3RUYXNrcy5wdXNoKCd1bml0LXRlc3QnKTtcbiAgfVxuXG4gIHZhciBkb0NvdmVyYWdlID0gZnVuY3Rpb24gKHRhc2tOYW1lLCBmaWxlUGF0dGVybnMsIHRhcmdldERpcikge1xuICAgIHZhciBjb3ZUZXN0RmlsZXMgPSBfLmZsYXR0ZW4oW2ZpbGVQYXR0ZXJuc10pLm1hcChmdW5jdGlvbiAoZikge1xuICAgICAgcmV0dXJuIGludGVycG9sYXRlKGYsIGZpbGVBbGlhc2VzKTtcbiAgICB9KTtcbiAgICBndWxwLnRhc2sodGFza05hbWUsIGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBleGVjKCdybSAtcmYgLi9idWlsZCcpLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gZ2xvYmJ5KGNvdlRlc3RGaWxlcykudGhlbihmdW5jdGlvbiAoZmlsZXMpIHtcbiAgICAgICAgICB2YXIgZGVmZXJyZWQgPSBRLmRlZmVyKCk7XG4gICAgICAgICAgdmFyIGJpbnMgPSB7fTtcbiAgICAgICAgICBfLmVhY2goWydpc3BhcnRhJywgJ2JhYmVsLW5vZGUnLCAndGV4dCcsICdfbW9jaGEnXSwgZnVuY3Rpb24gKGspIHsgYmluc1trXSA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi9ub2RlX21vZHVsZXMvLmJpbicsIGspOyB9KTtcbiAgICAgICAgICB2YXIgYmluID0gYmluc1snYmFiZWwtbm9kZSddO1xuICAgICAgICAgIHZhciBhcmdzID0gW2JpbnMuaXNwYXJ0YSwgJ2NvdmVyJywgJy0tZGlyJywgdGFyZ2V0RGlyLCBiaW5zLl9tb2NoYSwgJy0tJywgJy0tcmVxdWlyZScsIF9fZGlybmFtZSArICcvLi4vYmFiZWxob29rJywgJy0tcmVwb3J0ZXInLCAnZG90J11cbiAgICAgICAgICAgIC5jb25jYXQoZmlsZXMpO1xuICAgICAgICAgIHZhciBlbnYgPSBfLmNsb25lKHByb2Nlc3MuZW52KTtcbiAgICAgICAgICBlbnYuTk9fUFJFQ09NUElMRT0xO1xuICAgICAgICAgIGVudi5fVEVTVElORz0xO1xuICAgICAgICAgIGNvbnNvbGUubG9nKFwicnVubmluZyBjb21tYW5kIC0tPlwiLCBiaW4sIGFyZ3Muam9pbignICcpKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlXG4gICAgICAgICAgdmFyIHByb2MgPSBzcGF3bihiaW4sIGFyZ3MsIHtzdGRpbzogb3B0cy5jb3ZlcmFnZS52ZXJib3NlID8gJ2luaGVyaXQnIDogJ2lnbm9yZScsIGVudn0pO1xuICAgICAgICAgIHByb2Mub24oJ2Nsb3NlJywgZnVuY3Rpb24gKGNvZGUpIHtcbiAgICAgICAgICAgIGlmIChjb2RlID09PSAwKSB7XG4gICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChuZXcgRXJyb3IoJ0NvdmVyYWdlIGNvbW1hbmQgZXhpdCBjb2RlOiAnICsgY29kZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuICAgICAgICB9KTtcbiAgICAgIH0pLmNhdGNoKHNwYXduV2F0Y2hlci5oYW5kbGVFcnJvcik7XG4gICAgfSk7XG4gIH07XG4gIGlmIChvcHRzLmNvdmVyYWdlKSB7XG4gICAgZG9Db3ZlcmFnZSgnY292ZXJhZ2UnLCBvcHRzLmNvdmVyYWdlLmZpbGVzLCAnY292ZXJhZ2UnKTtcbiAgICBndWxwLnRhc2soJ2NvdmVyYWxscycsIFsnY292ZXJhZ2UnXSwgZnVuY3Rpb24gKCkge1xuICAgICAgdmFyIGJpbiA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi9ub2RlX21vZHVsZXMvLmJpbi9jb3ZlcmFsbHMnKTtcbiAgICAgIHJldHVybiBleGVjKCdjYXQgLi9jb3ZlcmFnZS9sY292LmluZm8gfCAnICsgYmluKS5jYXRjaChzcGF3bldhdGNoZXIuaGFuZGxlRXJyb3IpO1xuICAgIH0pO1xuICB9XG4gIGlmIChvcHRzWydjb3ZlcmFnZS1lMmUnXSkge1xuICAgIGRvQ292ZXJhZ2UoJ2NvdmVyYWdlLWUyZScsIG9wdHNbJ2NvdmVyYWdlLWUyZSddLmZpbGVzLCAnY292ZXJhZ2UtZTJlJyk7XG4gIH1cbiAgaWYgKG9wdHMuZTJlVGVzdCkge1xuICAgIHZhciBlMmVUZXN0RmlsZXMgPSBfLmZsYXR0ZW4oW29wdHMuZTJlVGVzdC5maWxlcyB8fCBvcHRzLmUyZVRlc3RGaWxlc10pLm1hcChmdW5jdGlvbiAoZikge1xuICAgICAgcmV0dXJuIGludGVycG9sYXRlKGYsIGZpbGVBbGlhc2VzKTtcbiAgICB9KTtcbiAgICBndWxwLnRhc2soJ2UyZS10ZXN0JywgdGVzdERlcHMsICBmdW5jdGlvbiAoKSB7XG4gICAgICB2YXIgaXNGb3JjZUxvZ01vZGUgPSBwYXJzZUludChwcm9jZXNzLmVudi5fRk9SQ0VfTE9HUywgMTApID09PSAxO1xuICAgICAgdmFyIG1vY2hhT3B0cyA9IHtcbiAgICAgICAgcmVwb3J0ZXI6IGlzRm9yY2VMb2dNb2RlID8gJ3NwZWMnIDogb3B0cy50ZXN0UmVwb3J0ZXIsXG4gICAgICAgIHRpbWVvdXQ6IG9wdHMudGVzdFRpbWVvdXRcbiAgICAgIH07XG4gICAgICAvLyBzZXQgZW52IHNvIG91ciBjb2RlIGtub3dzIHdoZW4gaXQncyBiZWluZyBydW4gaW4gYSB0ZXN0IGVudlxuICAgICAgcHJvY2Vzcy5lbnYuX1RFU1RJTkcgPSAxO1xuICAgICAgdmFyIHNlcSA9IFtcbiAgICAgICAgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIHJldHVybiBwcm9taXNlUGlwZShndWxwXG4gICAgICAgICAgIC5zcmMoZTJlVGVzdEZpbGVzLCB7cmVhZDogZmFsc2V9KVxuICAgICAgICAgICAucGlwZShtb2NoYShtb2NoYU9wdHMpKSk7XG4gICAgICAgIH1dO1xuICAgICAgdmFyIGNsZWFudXBTZXEgPSBbXTtcbiAgICAgIHZhciBjbGVhbnVwV2FybiA9IGZ1bmN0aW9uIChlcnIpIHsgY29uc29sZS53YXJuKCdFcnJvciBkdXJpbmcgY2xlYW51cCwgaWdub3Jpbmc6JywgZXJyKTsgfTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlXG4gICAgICBpZiAob3B0cy5lMmVUZXN0LmFuZHJvaWQpIHtcbiAgICAgICAgaWYgKG9wdHMuZTJlVGVzdFtcImFuZHJvaWQtZW11XCJdKSB7XG4gICAgICAgICAgdmFyIGVtdSA9IG5ldyBBbmRyb2lkRW11bGF0b3Iob3B0cy5lMmVUZXN0WydhbmRyb2lkLWF2ZCddKTtcbiAgICAgICAgICBzZXEgPSBbXG4gICAgICAgICAgICBmdW5jdGlvbiAoKSB7IHJldHVybiBhbmRyb2lkVG9vbHMua2lsbEFsbCgpOyB9LFxuICAgICAgICAgICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IFEoZW11LnN0YXJ0KCkpOyB9LFxuICAgICAgICAgICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gZW11LndhaXRUaWxsUmVhZHkoKTt9XG4gICAgICAgICAgXS5jb25jYXQoc2VxKTtcbiAgICAgICAgICBjbGVhbnVwU2VxID0gY2xlYW51cFNlcS5jb25jYXQoW1xuICAgICAgICAgICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gZW11LnN0b3AoKTsgfSxcbiAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIGFuZHJvaWRUb29scy5raWxsQWxsKCkuY2F0Y2goY2xlYW51cFdhcm4pOyB9XG4gICAgICAgICAgXSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc2VxID0gW1xuICAgICAgICAgICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gYW5kcm9pZFRvb2xzLmtpbGxBbGwoKTsgfSxcbiAgICAgICAgICBdLmNvbmNhdChzZXEpO1xuICAgICAgICAgIGNsZWFudXBTZXEgPSBjbGVhbnVwU2VxLmNvbmNhdChbXG4gICAgICAgICAgICBmdW5jdGlvbiAoKSB7IHJldHVybiBhbmRyb2lkVG9vbHMua2lsbEFsbCgpLmNhdGNoKGNsZWFudXBXYXJuKTsgfVxuICAgICAgICAgIF0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAob3B0cy5lMmVUZXN0Lmlvcykge1xuICAgICAgICB2YXIgeENvZGVWZXJzaW9uID0gb3B0cy5lMmVUZXN0LnhDb2RlVmVyc2lvbiB8fCAnNi4xLjEnO1xuICAgICAgICBzZXEgPSBbXG4gICAgICAgICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gaW9zVG9vbHMua2lsbEFsbCgpOyB9LFxuICAgICAgICAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIGlvc1Rvb2xzLmNvbmZpZ3VyZVhjb2RlKHhDb2RlVmVyc2lvbik7IH0sXG4gICAgICAgICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gaW9zVG9vbHMucmVzZXRTaW1zKCk7IH0sXG4gICAgICAgIF0uY29uY2F0KHNlcSk7XG4gICAgICAgIGNsZWFudXBTZXEgPSBjbGVhbnVwU2VxLmNvbmNhdChbXG4gICAgICAgICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gaW9zVG9vbHMua2lsbEFsbCgpLmNhdGNoKGNsZWFudXBXYXJuKTsgfVxuICAgICAgICBdKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBzZXEucmVkdWNlKFEud2hlbiwgbmV3IFEoKSlcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgIHJldHVybiBjbGVhbnVwU2VxLnJlZHVjZShRLndoZW4sIG5ldyBRKCkpLmZpbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAob3B0cy5lMmVUZXN0LmZvcmNlRXhpdCkge1xuICAgICAgICAgICAgICBwcm9jZXNzLmV4aXQoMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICByZXR1cm4gY2xlYW51cFNlcS5yZWR1Y2UoUS53aGVuLCBuZXcgUSgpKS5maW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgc3Bhd25XYXRjaGVyLmhhbmRsZUVycm9yKGVycik7XG4gICAgICAgICAgICBpZiAob3B0cy5lMmVUZXN0LmZvcmNlRXhpdCkge1xuICAgICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIHRlc3RUYXNrcy5wdXNoKCdlMmUtdGVzdCcpO1xuICB9XG5cbiAgaWYgKHRlc3RUYXNrcy5sZW5ndGggPiAwKSB7XG4gICAgZ3VscC50YXNrKCd0ZXN0JywgZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIHJ1blNlcXVlbmNlLmFwcGx5KG51bGwsIHRlc3RUYXNrcyk7XG4gICAgfSk7XG4gIH1cblxuICBpZiAob3B0cy50cmFuc3BpbGUpIHtcbiAgICBndWxwLnRhc2soJ3RyYW5zcGlsZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgIHZhciB0cmFuc3BpbGVyID0gbmV3IFRyYW5zcGlsZXIob3B0cyk7XG4gICAgICByZXR1cm4gZ3VscC5zcmMob3B0cy5maWxlcywge2Jhc2U6ICcuLyd9KVxuICAgICAgICAucGlwZSh0cmFuc3BpbGVyLnN0cmVhbSgpKVxuICAgICAgICAub24oJ2Vycm9yJywgc3Bhd25XYXRjaGVyLmhhbmRsZUVycm9yKVxuICAgICAgICAucGlwZShndWxwLmRlc3Qob3B0cy50cmFuc3BpbGVPdXQpKTtcbiAgICB9KTtcblxuICAgIGd1bHAudGFzaygncHJlcHVibGlzaCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgIHZhciB0YXNrcyA9IFsnY2xlYW4nLCAndHJhbnNwaWxlJ10uY29uY2F0KG9wdHMuZXh0cmFQcmVwdWJsaXNoVGFza3MpO1xuICAgICAgcmV0dXJuIHJ1blNlcXVlbmNlLmFwcGx5KHRoaXMsIHRhc2tzKTtcbiAgICB9KTtcbiAgfVxuXG4gIHZhciBsaW50VGFza3MgPSBbXTtcblxuICBndWxwLnRhc2soJ2VzbGludCcsIGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZ3VscC5zcmMoWycqKi8qLmpzJywgJyFub2RlX21vZHVsZXMvKionLCAnIWJ1aWxkLyoqJ10pXG4gICAgICAucGlwZShlc2xpbnQoKSlcbiAgICAgIC5waXBlKGVzbGludC5mb3JtYXQoKSlcbiAgICAgIC5waXBlKGVzbGludC5mYWlsQWZ0ZXJFcnJvcigpKTtcbiAgfSk7XG5cbiAgaWYgKG9wdHMuanNoaW50KSB7XG4gICAgZ3VscC50YXNrKCdqc2hpbnQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gZ3VscFxuICAgICAgIC5zcmMob3B0cy5maWxlcylcbiAgICAgICAucGlwZShqc2hpbnQoKSlcbiAgICAgICAucGlwZShqc2hpbnQucmVwb3J0ZXIoJ2pzaGludC1zdHlsaXNoJykpXG4gICAgICAgLnBpcGUoanNoaW50LnJlcG9ydGVyKCdmYWlsJykpXG4gICAgICAgLm9uKCdlcnJvcicsIHNwYXduV2F0Y2hlci5oYW5kbGVFcnJvcik7XG4gICAgfSk7XG4gICAgbGludFRhc2tzLnB1c2goJ2pzaGludCcpO1xuICB9XG5cbiAgaWYgKG9wdHMuanNoaW50KSB7XG4gICAgb3B0cy5saW50ID0gdHJ1ZTtcbiAgICBndWxwLnRhc2soJ2xpbnQnLCBsaW50VGFza3MpO1xuICB9XG5cbiAgdmFyIGRlZmF1bHRTZXF1ZW5jZSA9IFtdO1xuICBpZiAob3B0cy50cmFuc3BpbGUpIGRlZmF1bHRTZXF1ZW5jZS5wdXNoKCdjbGVhbicpO1xuICBpZiAob3B0cy5saW50KSBkZWZhdWx0U2VxdWVuY2UucHVzaCgnbGludCcpO1xuICBpZiAob3B0cy50cmFuc3BpbGUgJiYgIW9wdHMudGVzdCkgZGVmYXVsdFNlcXVlbmNlLnB1c2goJ3RyYW5zcGlsZScpO1xuICBpZiAob3B0cy5wb3N0VHJhbnNwaWxlKSBkZWZhdWx0U2VxdWVuY2UgPSBkZWZhdWx0U2VxdWVuY2UuY29uY2F0KG9wdHMucG9zdFRyYW5zcGlsZSk7XG4gIGlmIChvcHRzLnRlc3QpIHtcbiAgICBpZiAob3B0cy53YXRjaEUyRSkge1xuICAgICAgZGVmYXVsdFNlcXVlbmNlLnB1c2goJ3Rlc3QnKTtcbiAgICB9IGVsc2UgaWYgKF8uaW5jbHVkZXModGVzdFRhc2tzLCAndW5pdC10ZXN0JykpIHtcbiAgICAgIGRlZmF1bHRTZXF1ZW5jZS5wdXNoKCd1bml0LXRlc3QnKTtcbiAgICB9XG4gIH1cbiAgaWYgKG9wdHMuZXh0cmFEZWZhdWx0VGFza3MpIGRlZmF1bHRTZXF1ZW5jZSA9IGRlZmF1bHRTZXF1ZW5jZS5jb25jYXQob3B0cy5leHRyYURlZmF1bHRUYXNrcyk7XG5cbiAgaWYgKG9wdHMud2F0Y2gpIHtcbiAgICBzcGF3bldhdGNoZXIuY2xlYXIoZmFsc2UpO1xuICAgIHNwYXduV2F0Y2hlci5jb25maWd1cmUoJ3dhdGNoJywgb3B0cy5maWxlcywgZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIHJ1blNlcXVlbmNlLmFwcGx5KG51bGwsIGRlZmF1bHRTZXF1ZW5jZSk7XG4gICAgfSk7XG4gIH1cblxuICBndWxwLnRhc2soJ29uY2UnLCBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHJ1blNlcXVlbmNlLmFwcGx5KG51bGwsIGRlZmF1bHRTZXF1ZW5jZSk7XG4gIH0pO1xuXG4gIGd1bHAudGFzaygnZGVmYXVsdCcsIFtvcHRzLndhdGNoID8gJ3dhdGNoJyA6ICdvbmNlJ10pO1xuXG4gIGlmIChvcHRzLnByZUNvbW1pdFRhc2tzKSB7XG4gICAgLy8gdGhpcyBpcyBhIG1hZ2ljIHRhc2sgdGhhdCBnZXRzIHBpY2tlZCB1cCBieSBgZ2l0LWd1cHB5YFxuICAgIC8vIGFuZCBhdXRvbWF0aWNhbGx5IGFkZGVkIGFzIGEgcHJlLWNvbW1pdCBnaXQgaG9va1xuICAgIGd1bHAudGFzaygncHJlLWNvbW1pdCcsIG9wdHMucHJlQ29tbWl0VGFza3MpO1xuICB9XG59O1xuXG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBERUZBVUxUUzogXy5jbG9uZURlZXAoREVGQVVMVF9PUFRTKSxcbiAgdXNlIChndWxwKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uIChvcHRzKSB7XG4gICAgICBib2lsZXJwbGF0ZShndWxwLCBvcHRzKTtcbiAgICB9O1xuICB9XG59O1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
